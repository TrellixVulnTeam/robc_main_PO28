<?php

class AdminReportsController extends AppController
{
    var $name       = 'AdminReports';
    var $uses       = array('User', 'MetricLog', 'ReportSetting');
    var $components = array('CIReportsSidebar', 'CIDatePicker', 'CIHubsSelect', 'CIWebsitesSelect');

    var $view       = 'Theme';
    var $theme      = 'bootstrap';

    public function beforeFilter()
    {
        $this->Session->activate();
        $user = $this->Session->read('User');
        $user = $this->User->findById($user['id']);
        $this->validate_admin(ADMIN_DOMAIN);
        App::import('Vendor', 'Carbon', array('file' => 'Carbon.php'));
        $this->layout = 'bootstrap';
        $this->set_types_user($user['User']);
        $this->MetricLog->log(LOG_TYPE_PAGE_VIEW);
        $this->set('user', $user);
        $this->set('full_admin',$user['User']['domain_bitfield'] == -1);
        $this->set('tab', 'reports');
    }

    public function index()
    {
        App::import('Vendor', 'Carbon', array('file' => 'Carbon.php'));

        $this->CIReportsSidebar->setup(
            'reportssidebar_component',
            array(
                'id' => 'sidebar-reports',
                'title' => 'Reports',
            )
        );

        $start_date = \Carbon\Carbon::now()->subDays(30)->format('m/d/Y');
        $end_date   = \Carbon\Carbon::now()->format('m/d/Y');
        $this->CIDatePicker->setup(
            'datepicker_component',
            array(
                'id' => 'ci-stats-datepicker',
                'placeholder' => $start_date . ' to ' . $end_date,
                'start_date'  => $start_date,
                'end_date'    => $end_date
            )
        );

        $this->CIHubsSelect->setup(
            'hubs_list_component',
            array(
                'name'     => 'hubs_ids',
                'multiple' => true,
            )
        );

        $this->CIWebsitesSelect->setup(
            'website_list_component',
            array(
                'name'     => 'websites_ids',
                'multiple' => true,
                'header'   => 'Clear selection',
                'status'   => array(
                    WEBSITE_STATUS_ACTIVE,
                    WEBSITE_STATUS_INACTIVE,
                    WEBSITE_STATUS_NEW,
                    WEBSITE_STATUS_TRANSFER,
                ),
            )
        );

        $start_date = \Carbon\Carbon::now()->subDays(7)->format('m/d/Y');
        $end_date   = \Carbon\Carbon::now()->subDays(1)->format('m/d/Y');
        $this->CIDatePicker->setup(
            'report_hub_datepicker_component',
            array(
                'id'          => 'reports-datepicker',
                'placeholder' => $start_date . ' to ' . $end_date,
                'start_date'  => $start_date,
                'end_date'    => $end_date
            )
        );

        $user = $this->Session->read('User');
        $this->set('report_list', $this->ReportSetting->get_list_with_user($user['id']));
    }
}