<script>
var time_unit_day = <?=TIME_UNIT_DAY?>;

jQuery(document).ready(function() { 

   jQuery.blockUI.defaults.overlayCSS = {};
   jQuery.blockUI.defaults.css = {}; 
     
   /////////
   // Add a new widget stuff
   /////////
   jQuery("#add_widget_button").click(function(){
      location.href = "/widgets/create";
   });
   
   /////////
   // update the graphs
   /////////
     
   jQuery("#timeChoices").change(function(){
      getGraphData();  
   });

   jQuery(".widget_check").click(function(){
       jQuery(this).toggleClass('active');
       getGraphData();
       return false;
   });
     
   ////////////
   //  Get a widget's code
   ///////////
   jQuery("a.code").click(function(){
      var ID =  jQuery(this).parent().children('.widget_check').attr('id').split("-")[1].toString();
            var width = jQuery(this).parent().children('.widget_check').attr('data-width');
            var account_id = jQuery(this).parent().children('.widget_check').attr('data-id');

            <?=$this->element('widget_async_start')?>
            async_code += ID;
            <?=$this->element('widget_async_end')?>

            if (jQuery(this).parent().children('.widget_check').hasClass('powered') ) {
                var widget_powered_text = "<?=$this->element('widget_powered')?>";
                async_code += "<div id='widget_powered_div' style='width: "+width+"px;'><a href='http://<?=SITE_URL?>/account/"+account_id+"' target=_blank>"+widget_powered_text+"</a></div>";
            }     
      async_code = async_code.replace(/&#47;/gi, "/");
      jQuery("#code").text(async_code);

            jQuery.blockUI({ message:jQuery("#responseDiv"), css: { background:'white', top: '100px', left: '22%', width:'670px', height:'360px', padding:'15px', border:'1px solid #666'}, overlayCSS:  { backgroundColor: '#000', opacity:0.6, cursor:'wait' } });
   });
   
       jQuery("#closeResponse").click(function(){
           jQuery.unblockUI();
       });


   $('.element .title').live('click', function() {
       if(jQuery(this).parent().hasClass('selected')) {
            jQuery(this).parent().removeClass('selected');
            jQuery(this).parent().children('.info').slideUp();
       } else {
            jQuery(this).parent().addClass('selected');
            jQuery(this).parent().children('.info').slideDown();
       }
       return false;
   });

   //////////
   //  Delete a widget code
   /////////   
   jQuery("a.delete").click(function(){
      var ID = jQuery(this).parent().children('.widget_check').attr('id').split("-")[1].toString();
      jQuery("#deleteID").val(ID);
            jQuery.blockUI({ message:jQuery("#deleteDiv"), css: { background:'white', top: '180px', left: '32%', width:'250px', height:'100px', padding:'20px', border:'1px solid #666'}, overlayCSS:  { backgroundColor: '#000', opacity:0.6, cursor:'wait' } });
   });
   
   jQuery("#yesDelete").click(function(){
       var VAL = jQuery("#deleteID").val();
     jQuery.post("/widgets/delete", { deleteID: VAL});
       var ID = jQuery("#deleteID").val();
       //jQuery("#" + ID).parents("div.widget").remove();
       jQuery('#websitename-'+ID).parent().parent().remove();
       jQuery("#deleteID").val("");
       jQuery.unblockUI();
   });
   
   jQuery("#noDelete").click(function(){
       jQuery("#deleteID").val("");
       jQuery.unblockUI();
   });
   
   
   var show_code_widget_id = <?=$show_code?>;
   if (show_code_widget_id != 0)
   {
      jQuery("#code-" + show_code_widget_id).click();
   }

   //////////
   //  Edit a widget
   /////////
   jQuery("a.edit").click(function(){
       var ID = jQuery(this).parent().children('.widget_check').attr('id').split("-")[1].toString();
       location.href = "/widgets/create/" + ID;
   });
   

   ///////
   // Select Website
   /////
   jQuery("#selectWebsite").change(function(){
        refreshWidgets();
   });

    refreshWidgets();   
});
</script>  
<?
	echo $this->element("dashboard2_toolbar", array("tab" => "widgets"));
?>
<div class="row supercontainer wide_column_container" id="content_area">

    <div class="hubs_column"> <!-- left col -->
<?
    /* Websites */
  foreach($websites as $website) {

      if (empty($website['Website']['name'])) {
        $website_name = $website['Website']['url'];
      } else {
        $website_name = $website['Website']['name'];
      }
?>      
          <div class="element_container inactive" id="website-<?=$website['Website']['id']?>">
              <? /*<table width=100% cellspacing=3><tr><td width="20" class="expandCollapse"><img src="/img/expanded.gif"></td><td width="36"><input type="checkbox" checked class="website_check" id="website-<?=$website['Website']['id']?>"></input></td><td align="left" class="websitename" id="websitename-<?=$website['Website']['id']?>"><?=$website_name?></td><td width="50" align=right><?=$website['Website']['return_rate']?>%</td></tr></table></div> */ ?>
          
<?        $widget_count = 0;
          foreach($widgets as $widget) {
                    if ($widget['Widget']['website_id'] != $website['Website']['id']) {
                            continue;
                    }

                    if ($widget['Widget']['display']) {
                            $ctr = ($widget['Widget']['incoming'] / $widget['Widget']['display']) * 100;
                    } else {
                            $ctr = 0;
                    } ?>



                   <div class="element">
                        <div class="title">
                              <span class="websitename" id="widgetname-<?=$widget['Widget']['id']?>">
                                  <a href="#"><?=$widget['Widget']['name']?></a>
                              </span>
                              <span class="rate">
                                   <?=$widget['Widget']['width']?> x <?=$widget['Widget']['height']?>
                              </span>
                              <br class="clearfloat"/>
                         </div>
                         <div class="info">
                              <p>
                                 CTR: <b><?=printf("%.2f", $ctr)?>%</b>&nbsp;&nbsp;&nbsp;
                                 Traffic from <?php echo $website_name;?>: <b><?=number_format($widget['Widget']['incoming'])?></b>&nbsp;&nbsp;&nbsp;
                                 <br />
                                 Status:
                                 <?
                                    $status = $convert->widget_status($widget['Widget']['status']);
                                    if( $status == "Active" ) echo '<b class="green">'; else echo '<b class="red">';
                                    echo '<span>&bull;</span> '.$status.'</b>';
                                 ?>                                 
                              </p>

                              <div class="buttons">
                                  <a class="button chart widget_check <? if($widget['Widget']['powered']) echo 'powered'; ?> tooltip" id="widget-<?=$widget['Widget']['id']?>"
                                     <? if($widget['Widget']['powered']) {
                                         echo ' data-id="'.$website['Website']['id'].'"';
                                         echo ' data-width="'.$widget['Widget']['width'].'"';                                         
                                     }
                                     ?> 
                                     href="#" title="Turn On/Off this widget's line in the chart."><span class="icon"></span><span class="label">Chart</span></a>
                                  <a class="button delete tooltip" href="#" title="Remove this widget."><span class="icon"></span><span class="label">Delete</span></a>
                                  <a class="button edit tooltip" href="#" title="Customize the look of the widget."><span class="icon"></span><span class="label">Edit</span></a>
                                  <a class="button code tooltip" href="#" title="Get the widget code to copy/paste in your website's HTML."><span class="icon"></span><span class="label">Get Code</span></a>
                              </div>
                         </div>
                  </div>
                  <!-- end widget -->
<?
                $widget_count++;
        } // end for
      
?>
        </div>  <!-- end website_container -->
       
<?
    } // endfor
?>

    </div>


  <div class="websites_column"> <!-- right col -->    
    
  <div id="status_bar">

      <div class="ddown_container">
        <span>Website</span>
            <select id="selectWebsite">
<?
            foreach($websites as $website) { 
        $website_name = $website['Website']['name'];        
        if (!$website_name) {
          $website_name = $website['Website']['url'];
        }
?>
                <option value="<? echo $website['Website']['id'];?>"><? echo $website_name;?></option>
<?
            }
?>
        </select>
      <div>
      </div>
    </div>

      <div class="ddown_container">
          <a id="add_widget_button" class="button">Add New Widget</a>
      </div>
  

      <div class="ddown_container">
        <span>Time Range</span>
         <select id="timeChoices">
           <!--<option value="<?=strtotime("midnight today")?>">Today</option>-->
           <!--<option value="<?=strtotime("midnight yesterday")?>">Yesterday</option>-->
           <option value="<?=strtotime("midnight -3 days")?>">Last 3 Days</option>
           <option value="<?=strtotime("midnight -7 days")?>">Last 7 Days</option>
           <option selected value="<?=strtotime("midnight -14 days")?>">Last 2 Weeks</option>
           <option value="<?=strtotime("midnight -30 days")?>">Last 30 days</option>
           <option value="<?=mktime(0, 0, 0, date("n"), 1, date("Y"))?>">This Month</option>
           <option value="<?=strtotime("midnight first day -2 month")?>">Last 2 Months</option>
           <!--<option value="<?=strtotime("midnight first day last month")?>">Last Month</option>-->
           <option value="<?=strtotime("midnight first day -3 month")?>">Last 3 Months</option>
           <!--<option value="0">All Time</option>-->
         </select>
      <div>
  </div>
</div>
</div>



  
  <div class="table_container">

     <div id="graphs" style="margin-left:40px;">
          <div id="graph1" style="width:540px;height:360px;margin-top:12px;"></div>
          <div id="legend1" style="margin-top:12px;margin-left:24px;"></div> 
     </div>

</div> <!--  end of content row -->



	 
<div id="addWebsiteDiv" style="display:none;cursor:default;">
<h3>Add a New Website</h3>
<p style="font-size:14px;margin-top:18px;">Enter your new website
<p style="margin-top:18px;"><input type="text" id="new_website" style="width:240px;">
<p style="margin-top:18px;"><div class="button" id="save_website">Save</div> <a class="button" id="cancel_website">Cancel</a>
  
</div>

<div class="preloaderbox" id="waitingDiv1" style="display:none;cursor:default"></div>
<div class="preloaderbox" id="waitingDiv2" style="display:none;cursor:default"></div>

<div id=responseDiv style="display:none;cursor:default;">
<h3>Your <?=SITE_NAME?> Widget Code</h3>
<p style="font-size:14px;margin-top:18px;text-align:left;">Paste the following code into your webpage where you want your <?=SITE_NAME?> widget to appear.  If you have any questions, please e-mail
<?=EMAIL_ADMIN?>
<p style="margin-top:18px;">
<textarea style="width:650px;height:190px;" id="code">
</textarea>
<p style="margin-top:18px;"><a class="button" id="closeResponse">Close</a>
  
</div>

<div id="deleteDiv" style="display:none;cursor:default;">
<p>Are you sure you want to delete this widget?
<p style="margin-top:18px;"><a class="button" id="yesDelete">Yes</a> <a class="button" id="noDelete">No</a>
<form id="deleteForm">
<input type="hidden" id="deleteID" value="">
</form>
</div>