<?

if (isset($_POST["daily_breakdown"])) {
	if (isset($widget_clicks)) {
		$line = array('Hubs', 'Date Start', 'Date End', 'Widget Clicks', 'Widget Impressions', 'Widget CTR (%)', 'Return Rate (%)', 'TPM');
		$csv->addRow($line);

		$hub = '';
		foreach ($domain_ids as $domain_id)
		{
			$hub .= $convert->domain_name($domain_id)."; ";
		}

		$widget_clicks = number_format($widget_clicks);
		$widget_impressions = number_format($widget_impressions);
		$widget_ctr = round($widget_ctr, 2);
		$return_rate = round($return_rate, 2);
		$tpm = round($tpm, 2);

		$line = array($hub, $date_start, $date_end, $widget_clicks, $widget_impressions, $widget_ctr, $return_rate, $tpm);
		$csv->addRow($line);
		$csv->endRow();
		$csv->endRow();
		$csv->endRow();
	}

	if (isset($websites) && count($websites) > 0) {

		$line = array('Date', 'ID', 'Website', 'Hub', 'Status', 'Out', 'In', 'Ret. Rate', 'Widget Incoming', 'Widget Display', 'Widget CTR', 'Credits');
		$csv->addRow($line);

		foreach ($websites as $date => $daily_stat) {
			foreach($daily_stat as $website) {
				if (empty($website['Website']['name'])) {
					$website_name = $website['Website']['url'];
				} else {
					$website_name = $website['Website']['name'];
				}

				$id = $website['Website']['id'];
				$hub = $convert->domain_name($website['Website']['domain_primary']);
				$status = $convert->website_status($website['Website']['status']);
				$outgoing = $website['Account']['outgoing'];
				$incoming = $website['Account']['incoming'];
				$credits = $website['Account']['credits'];
				$return_rate = $incoming ? round((($outgoing/$incoming)*100), 2) : 0;
				if (isset($website['Widget'])) {
					$wincoming = $website['Widget']['incoming'];
					$wdisplay = $website['Widget']['display'];
				} else {
					$wincoming = 0;
					$wdisplay = 0;
				}
				$wctr = $wdisplay ? round((($wincoming/$wdisplay)*100), 3) : 0;

				$line = array($date, $id, $website_name, $hub, $status, $outgoing, $incoming, $return_rate, $wincoming, $wdisplay, $wctr, $credits);
				$csv->addRow($line);
			}
		}
	}
} else {
	if (isset($widget_clicks)) {
		$line = array('Hubs', 'Date Start', 'Date End', 'Widget Clicks', 'Widget Impressions', 'Widget CTR (%)', 'Return Rate (%)', 'TPM');
		$csv->addRow($line);

		$hub = '';
		foreach ($domain_ids as $domain_id)
		{
			$hub .= $convert->domain_name($domain_id)."; ";
		}

		$widget_clicks = number_format($widget_clicks);
		$widget_impressions = number_format($widget_impressions);
		$widget_ctr = round($widget_ctr, 2);
		$return_rate = round($return_rate, 2);
		$tpm = round($tpm, 2);

		$line = array($hub, $date_start, $date_end, $widget_clicks, $widget_impressions, $widget_ctr, $return_rate, $tpm);
		$csv->addRow($line);
		$csv->endRow();
		$csv->endRow();
		$csv->endRow();
	}

	if (isset($websites) && count($websites) > 0) {

		$line = array('ID', 'Website', 'Hub', 'Category', 'Status', 'Out', 'In', 'Ret. Rate', 'Credits', 'Widget Incoming', 'Widget Display', 'Widget CTR', 'Total In', 'Total Out', 'Total RT');
		$csv->addRow($line);

		foreach($websites as $website) {
			if (empty($website['Website']['name'])) {
				$website_name = $website['Website']['url'];
			} else {
				$website_name = $website['Website']['name'];
			}

			$id = $website['Website']['id'];
			$hub = $convert->domain_name($website['Website']['domain_primary']);
			$status = $convert->website_status($website['Website']['status']);
			$category = $convert->category($website['Website']['category']);
			$outgoing = $website['Account']['outgoing'];
			$incoming = $website['Account']['incoming'];
			$credits = $website['Account']['credits'];
			$return_rate = $incoming ? round((($outgoing/$incoming)*100), 2) : 0;

			$total_in = $website['Total']['incoming'];
			$total_out = $website['Total']['outgoing'];
			$total_rt = ( $website['Total']['incoming'] ? round(($website['Total']['outgoing']/$website['Total']['incoming']) * 100, 0) : 0 ) . "%";

			if (isset($website['Widget'])) {
				$wincoming = $website['Widget']['incoming'];
				$wdisplay = $website['Widget']['display'];
			} else {
				$wincoming = 0;
				$wdisplay = 0;
			}
			$wctr = $wdisplay ? round((($wincoming/$wdisplay)*100), 3) : 0;

			$line = array($id, $website_name, $hub, $category, $status, $outgoing, $incoming, $return_rate, $credits, $wincoming, $wdisplay, $wctr, $total_in, $total_out, $total_rt );
			$csv->addRow($line);

		}
	}
}


echo $csv->render('management_report');