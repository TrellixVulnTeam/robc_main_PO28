
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/jquery-ui.min.js" type="text/javascript"></script>
<?php /* <script src="/js/jquery-ui-1.8.custom.min.js" type="text/javascript"></script> */ ?>
<script type="text/javascript" src="/js/fileuploader/fileuploader.js"></script>
<script type="text/javascript" src="/js/jquery.Jcrop.js"></script>
<script type="text/javascript" src="/js/tag-it.min.js"></script>
<script type="text/javascript" src="/js/daterangepicker.jQuery.js"></script>
<?
	echo $this->element('crowdignite/analytics');
?>
<link rel="stylesheet" href="/css/fileuploader/fileuploader.css" type="text/css" />
<link rel="stylesheet" href="/js/jquery-smoothness/jquery-ui-1.8.21.custom.css" type="text/css" title="ui-theme" />
<link rel="stylesheet" href="/css/jquery.Jcrop.css" type="text/css" />
<link rel="stylesheet" href="/css/jquery.tagit.css"  type="text/css">
<link rel="stylesheet" href="/css/tagit.ui-zendesk.css" type="text/css">
<link rel="stylesheet" href="/css/ui.daterangepicker.css" type="text/css" />
<script src="http://<?php echo CDN_URL; ?>/js/handlebars-v1.3.0.js"></script>
<style>
#large_preview_wrapper {
	display: block;
	overflow: hidden;
	height: 172px;
	width: 300px;
}
.previewtabs { height:230px; font-size:11px; margin-top:10px; width:330px;}
.addimagetabs { font-size:11px; height: 150px; width:300px; }
.addimagetabs input[type="text"] { width:250px; margin:10px 0; }
.tabs-bottom { position: relative; }
.previewtabs .tabs-bottom .ui-tabs-panel { height: 300px; overflow: auto; }
.tabs-bottom .ui-tabs-nav { position: absolute !important; left: 0; bottom: 0; right:0; padding: 0 0.2em 0.2em 0; border-top:0!important; }
.tabs-bottom .ui-tabs-nav li { margin-top: -5px !important; margin-bottom: 1px !important; border-bottom-width: 1px; border-top:none; }
.tabs-bottom .ui-tabs-nav li a { font-weight: bold;}
.ui-tabs-selected { margin-top: -3px !important; }
div.ui-datepicker{ font-size:11px; }
.image_url { width:190px!important; }
.qq-uploader { margin-bottom:8px;}
.btn_get_image, .btn_expire_clear {
	color:#fff!important;
	display: inline-block;
	text-decoration:none;
	background: #DF6330;
    border-radius:8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    padding:4px 6px;
}
.padd.bordered {
	position: relative;
}
.error_label:before {
	content: '';
	height: 0;
	position: absolute;
	width: 0;
	border-top: 7px solid rgba(0, 0, 0, 0);
	border-right: 7px solid #F00;
	border-bottom: 7px solid rgba(0, 0, 0, 0);
	left: -7px;
	top: 5px;
}
.error_label {
	position: absolute;
	background: #F00;
	font-size: 12px;
	color: #FFF;
	height: 15px;
	width: 178px;
	padding: 5px;
	left: 316px;
	z-index: 999;
	top: 95px;
	text-align: center;
	display: none;
}
</style>
<script type="text/javascript">

	$(document).ready( function(){
		var jcrop_api;

		jQuery('.expire_date').daterangepicker({
			presetRanges: [
				{text: '1 week', dateStart: 'today+1week', dateEnd: 'today+1week' },
				{text: '2 week', dateStart: 'today+2week', dateEnd: 'today+2week' },
				{text: '4 week', dateStart: 'today+4week', dateEnd: 'today+4week' },
				{text: '2 months', dateStart: 'today+2months', dateEnd: 'today+2months' },
				{text: '3 months', dateStart: 'today+3months', dateEnd: 'today+3months' },
				{text: '6 months', dateStart: 'today+6months', dateEnd: 'today+6months' },
				{text: '1 year', dateStart: 'today+1year', dateEnd: 'today+1year' }
			]
		});
		jQuery('.btn_expire_clear').click(function(){
			jQuery('#' + jQuery(this).data('clear')).val('');
			return false;
		});

		var delay = (function(){
			var timer = 0;

			return function(callback, ms){
				clearTimeout (timer);
				timer = setTimeout(callback, ms);
			};
		})();

		$('.page_url').bind("keyup", function(){
			var number   = jQuery(this).data('number');
			var url      = jQuery('#page_url_' + number).val();
			var last_url = jQuery('#page_url_' + number).data('last-url');

			if (last_url == url) {
				return false;
			}

			delay(function(){
				jQuery('#page_url_' + number).data('last-url', url);
				var img = jQuery('#check_url_img_' + number);
				img.hide();

				if ('' != url) {
					img.attr('src', '/img/crowdignite/website_ajax_loader_grey.gif');
					img.show();
					validate_page_url_against_website(url);
					jQuery.ajax({
						type: "POST",
						url: '/pages/verify_page_url',
						data: {url: url}
					}).done(function(response){
						var response = jQuery.parseJSON(response);
						if (response.result) {
							img.attr('src', '/img/crowdignite/icon_deny.png');
						} else {
							img.attr('src', '/img/crowdignite/icon_accept.png');
						}
					});
				}
			}, 500);
		});

		function validate_page_url_against_website(url)
		{
			var domain = '<?php echo $website_url; ?>';
			var domain_length = domain.split('.').length;

			if (url.indexOf('://') === -1) {
				url = 'http://' + url;
			}

			var page = $('<a>').attr('href', url);
			var page_hostname = page.attr('hostname');
			page_hostname = page_hostname.split('.');
			var hostname_lenght = page_hostname.length;
			var hostname_result = [];

			for (var i = 0; i < domain_length; i++) {
				hostname_result.push(page_hostname.pop());
			}

			hostname_result = hostname_result.reverse();
			page_hostname = hostname_result.join('.');

			if (page_hostname !== domain) {
				$('#error_label_check_url_img_0').show();
			} else {
				$('#error_label_check_url_img_0').hide();
			}
		}

		jQuery( ".previewtabs" ).tabs().hide();
		jQuery( ".addimagetabs" ).tabs();
		jQuery( ".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *" )
			.removeClass( "ui-corner-all ui-corner-top" )
			.addClass( "ui-corner-bottom" );
		createUploader();

		jQuery(".btn_get_image").click(function() {
			var i=jQuery(this).data('number');
			jQuery("#turn_on_"+i).show();
			jQuery("#turn_off_"+i).hide();
			jQuery('#center_selection_wrap_'+i).hide();
			update_image(i);
			return false;
		});

		jQuery(".image_url").focus(function() {
			var i=jQuery(this).data('number');
			clear_box(i);
		});
		jQuery(".image_url").blur(function() {
			var i=jQuery(this).data('number');
			clear_box(i);
		});

		jQuery(".turn_on").click(function() {
			var i=jQuery(this).data('number');
			jQuery("#turn_on_"+i).hide();
			jQuery("#turn_off_"+i).show();
	        jQuery('#previewtabs_'+i).show();
	        jQuery('#centerSelection_'+i).attr('checked', false);
	        jQuery('#center_selection_wrap_'+i).fadeIn();
			crop(i);
		});

		jQuery(".turn_off").click(function() {
			var i=jQuery(this).data('number');
			jQuery("#turn_on_"+i).show();
			jQuery("#turn_off_"+i).hide();
			jQuery("#previewtabs_"+i).hide();
			jQuery('#center_selection_wrap_'+i).hide();
			reset_crop(i);
		});

		jQuery(".centerselection").click(function() {
			var i=jQuery(this).data('number');
			centerselection(i);
		});

		jQuery("#add_button").click( function(){
			var i=jQuery(this).data('number');
			jQuery('#add_button_wait').show();
			if( validate_form(i) ) { // submit
				var submit_options = {
					success: function(data){
						jQuery('#form_0')[0].reset();
						reset();
						var success = /<div.*?>.*?added succesfully<\/div>/;
						if (success.test(data)) {
							jQuery("#moderate_0").removeClass('red').addClass('green').html('The page was succesfully added.');
						} else {
							jQuery("#moderate_0").html(data);
						}
						jQuery('#add_button_wait').hide();
					}
				};
				$('#form_0').ajaxSubmit(submit_options);
				return false;
			} else {
				// prevent submit
				jQuery('#add_button_wait').hide();
				return false;
			}

		});

		jQuery('textarea[maxlength]').limitMaxlength();

		// add a sample url to empty image_url input boxes
		jQuery(".image_url").each(function(){
			if(jQuery(this).val()=="") {
				jQuery(this).val("http://mywebsite/img/example_image.jpg").css("color","#bbbbbb");
			}
		});

		/* Tags */
        <?php
			$active_tags = array();
	        foreach($all_tags as $tag){
	        	//	echo 'tags['.$tag['Tag']['id'].']="'.$tag['Tag']['name'].'"';
	        	$active_tags[] = '"'. addslashes($tag['Tag']['name']).'"';
	        }
	    ?>
        var active_tags = [<? echo implode(",", $active_tags); ?>];
        $('.page_tags').tagit({
            availableTags: active_tags,
            allowSpaces: true,
            removeConfirmation: true
        });

	});

	function validate_form(i){
		var image_url = jQuery("#image_url_"+i).val();
		var page_url = jQuery("#page_url_"+i).val();
		var page_title = jQuery("#page_title_"+i).val();
		var output = true;
		jQuery("#moderate_"+i).removeClass('green').addClass('red');
		if(image_url=="" || image_url=="http://mywebsite/img/example_image.jpg") {
			jQuery("#moderate_"+i).html('Please add a valid image URL.');
			output = false;
		}
		if(page_title =="") {
			jQuery("#moderate_"+i).html('Please add a title.');
			output = false;
		}
		if(page_url==""|| !validate_url(page_url) ) {
			jQuery("#moderate_"+i).html('Please add a valid page URL.');
			output = false;
		}
		jQuery("#moderate_"+i).addClass('red');
		return output;
	}

	function validate_url(url) {
		url = url.replace('[','%5B');
		url = url.replace(']','%5D');

		if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url)) {
  			return true;
		} else {
  			return false;
		}
	}

    function update_image(i) {
        var image_url = jQuery("#image_url_"+i).val();
        if(image_url==""||image_url=="http://mywebsite/img/example_image.jpg") return false;
        jQuery('#preview_image_busy').show();
        jQuery("#test_image_size_"+i).attr('src', image_url);
        jQuery("#test_image_size_"+i).load(function(){
        	if( jQuery(this).width()<300 || jQuery(this).height()<250 ) {
        		jQuery("#image_url_"+i).val('http://mywebsite/img/example_image.jpg').css('color','grey');
        		jQuery("#preview_image_"+i).attr('src', '');
				jQuery(this).attr('src', '');
				jQuery('.size_message').show();
				jQuery('#preview_image_busy').hide();
				return false;
        	}
        	jQuery('#preview_image_busy').hide();
        	jQuery('.size_message').hide();
        	jQuery('.qq-upload-list').hide();
        	jQuery("#preview_image_"+i).attr('src', image_url);
	        jQuery("#preview_outside_large_"+i).attr('src', image_url);
	        jQuery("#preview_outside_small_"+i).attr('src', image_url);
			jQuery("#preview_outside_large_wrap_"+i).css({
	        	width: '300px',
	        	height:'172px'
	        });
			jQuery("#preview_outside_small_wrap_"+i).css({
	        	width: '210px',
	        	height:'120px'
	        });
			jQuery("#moderate_"+i).html('');
	        reset_crop(i);
        });
    }

	function reset_crop(i) {
		jcrop_api = jQuery("#preview_image_"+i).data('Jcrop');
		if (jcrop_api != null) {
			jcrop_api.destroy();
		}
		jQuery("#image_"+i+"_x1").val(0);
		jQuery("#image_"+i+"_y1").val(0);
	 }

    function crop(i) {

		var adjust;
		var min_height;
		var min_width;
		min_height = 250;
		min_width = 330;

		var real_img = jQuery('#test_image_size_'+i);
		var real_height = real_img.height();
		var real_width = real_img.width();

		var prvw_img = jQuery('#preview_image_'+i);
		var prvw_height = prvw_img.height();
		var prvw_width = prvw_img.width();

		if(real_height > min_height || real_width > min_width){
			adjust_height = real_height / min_height;
			adjust_width = real_width / min_width;
		} else {
			adjust_height = 1;
			adjust_width = 1;
		}

		adjust = Math.max(adjust_height, adjust_width);
		var max_x = prvw_width / adjust;
		var max_y = prvw_height / adjust;

    	jcrop_api = $.Jcrop('#preview_image_'+i);
		jcrop_api.setOptions({
			onSelect: showCoords,
			onChange: showCoords,
			aspectRatio: 210/120,
			setSelect: [0, 0, 150, 200],
			minSize: [max_x,max_y],
			centerSelection: false,
			passthrough: i
		});
		jcrop_api.focus();

		jQuery("#preview_outside_large_wrap_"+i).css({
        	width: '300px',
        	height:'172px'
        });
		jQuery("#preview_outside_small_wrap_"+i).css({
        	width: '210px',
        	height:'120px'
        });
	}

    function reset() {
		jQuery('.page_title').val('');
		jQuery('.page_url').val('');
		jQuery('.PageDescription').val('');
		jQuery('.expire_date').val('');
		jQuery('.image_url').val('http://mywebsite/img/example_image.jpg').css('color','grey');

		// remove the image
		var images = 'img#preview_image_0';
		jQuery(images).attr("src", "data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==");

		jQuery('#add_button_wait').hide();
		jQuery('#add_button').show();
		jQuery('.previewtabs').hide();

		reset_crop(0);
		jQuery("#crop_0_dim").html('');
		jQuery('.page_tags').tagit('removeAll');

		load_page_subcategories();
	}

	function centerselection(i) {
		var do_center = false;
		if(jQuery('#centerSelection_'+i).is(':checked')) {
			do_center = true;
		}
		jcrop_api = jQuery("#preview_image_"+i).Jcrop({
					onSelect: showCoords,
					onChange: showCoords,
					aspectRatio: 210/120,
					setSelect:   [ 0, 0, 150, 200 ],
					centerSelection: do_center,
					passthrough: i
					});
	}

    function showCoords(c) {
		var adjust;
		var max_height;
		var max_width;
		var new_img = new Image();
		max_height = 250;
		max_width = 330;

		new_img.src = document.getElementById("preview_image_"+c.passthrough).src;
		var height = new_img.height;
		var width = new_img.width;

		if(height > max_height || width > max_width){
			adjust_height = height / max_height;
			adjust_width = width / max_width;
		} else {
			adjust_height = 1;
			adjust_width = 1;
		}

		adjust = Math.max(adjust_height, adjust_width);
		x1 = c.x * adjust;
		y1 = c.y * adjust;
		x2 = c.x2 * adjust;
		y2 = c.y2 * adjust;

		jQuery("#image_"+c.passthrough+"_x1").val(x1);
		jQuery("#image_"+c.passthrough+"_y1").val(y1);
		jQuery("#image_"+c.passthrough+"_x2").val(x2);
		jQuery("#image_"+c.passthrough+"_y2").val(y2);

		update_view_dimensions(y2 - y1, x2 - x1, c.passthrough);

		var thumb_width = jQuery('#preview_outside_large_wrap_'+c.passthrough).width();
		var thumb_height = jQuery('#preview_outside_large_wrap_'+c.passthrough).height();
		var thumb_sm_width = jQuery('#preview_outside_small_wrap_'+c.passthrough).width();
		var thumb_sm_height = jQuery('#preview_outside_small_wrap_'+c.passthrough).height();
		var crop_width = jQuery('#div_preview_image_'+c.passthrough+' .jcrop-holder img').width();
		var crop_height = jQuery('#div_preview_image_'+c.passthrough+' .jcrop-holder img').height();

		if (parseInt(c.w) > 0) {
		      var rx = thumb_width / (x2-x1)*adjust;
		      var ry = thumb_height / (y2-y1)*adjust;
			  var rx_sm = thumb_sm_width / (x2-x1)*adjust;
		      var ry_sm = thumb_sm_height / (y2-y1)*adjust;

		      jQuery('#preview_outside_large_'+c.passthrough).css({
		        width: Math.round(rx*crop_width) + 'px',
		        height: Math.round(ry*crop_height) + 'px',
		        marginLeft: '-' + Math.round(rx * c.x ) + 'px',
		        marginTop: '-' + Math.round(ry * c.y ) + 'px'
		      });

			  jQuery('#preview_outside_large_wrap_'+c.passthrough).css({
				marginLeft: '-'+Math.round( (thumb_width-300) / 2 ) + 'px'
			  });

		      jQuery('#preview_outside_small_'+c.passthrough).css({
		        width: Math.round(rx_sm*crop_width) + 'px',
		        height: Math.round(ry_sm*crop_height) + 'px',
		        marginLeft: '-' + Math.round(rx_sm * c.x ) + 'px',
		        marginTop: '-' + Math.round(ry_sm * c.y ) + 'px'
		      });
		}
	}

	function update_view_dimensions(height, width, i) {
		height = Math.round(height);
		width = Math.round(width);
		if (height < 250) {
			height_html = "<font color='red'>"+height+"</font>";
		} else {
			height_html = height;
		}

		if (width < 300) {
			width_html = "<font color='red'>"+width+"</font>";
		} else {
			width_html = width;
		}
		jQuery("#crop_"+i+"_dim").html(width_html+"x"+height_html);
	}

	function createUploader(){
		var uploader = new qq.FileUploader({
			element: document.getElementById('file-uploader'),
			action: '/pages/upload_image/',
			allowedExtensions: ['jpg', 'jpeg', 'png', 'gif'],
			debug: false,
			onComplete: function(id, fileName, responseJSON){
				if(!responseJSON.error){
					jQuery('#image_url_0').val('/img/'+responseJSON.success);
					update_image(0);
					//jQuery('#file-uploader').hide();
					//jQuery('#image_url_0').hide();
					//jQuery('.size_message').html('Image Loaded').css('color','black');
				} else {
					jQuery('.qq-upload-list').hide();
				}
			}
		});
	}

    function onEndCrop(coords, dimensions, i) {
		var entry;
		var adjust;
		var max_height;
		var max_width;
		var newImg = new Image();

		entry = document.getElementById("preview_image_"+i);
		max_width = 330;
		max_height = 250;

		newImg.src = entry.src;
		var height = newImg.height;
		var width = newImg.width;
	}

    function block_button() {
		jQuery('#add_button_wait').show();
        jQuery('#add_button').hide();
	}

	function nothing(e)	{
		e.stopPropagation();
		e.preventDefault();
		return false;
	};

    function clear_box(i) {
		var field = jQuery('#image_url_'+i).val();
		if( field == "http://mywebsite/img/example_image.jpg" ){
			jQuery("#image_url_"+i).val("");
			jQuery("#image_url_"+i).css("color", "black");
		} else if( field == "" ) {
			jQuery("#image_url_"+i).val("http://mywebsite/img/example_image.jpg").css("color","#bbbbbb");
		}
	}

	jQuery.fn.limitMaxlength = function(options){

	  var settings = jQuery.extend({
	    attribute: "maxlength",
	    onLimit: function(){},
	    onEdit: function(){}
	  }, options);

	  // Event handler to limit the textarea
	  var onEdit = function(){
	    var textarea = jQuery(this);
	    var maxlength = parseInt(textarea.attr(settings.attribute));

	    if(textarea.val().length > maxlength){
	      textarea.val(textarea.val().substr(0, maxlength));

	      // Call the onlimit handler within the scope of the textarea
	      jQuery.proxy(settings.onLimit, this)();
	    }

	    // Call the onEdit handler within the scope of the textarea
	    jQuery.proxy(settings.onEdit, this)(maxlength - textarea.val().length);
	  }

	  this.each(onEdit);

	  return this.keyup(onEdit)
	        .keydown(onEdit)
	        .focus(onEdit);
	}


</script>

<div class="row main">
<div id="content" class="column grid_12">

<?
	if ($is_admin) {
		echo $this->element("management_toolbar", array("tab" => "none"));
	} else {
		echo $this->element("dashboard_toolbar", array("tab" => "none"));
	}
?>
	<div class="column grid_12">

	<h3 class="topContent">Add Pages</h3>


	 <div class="row" id="content_area">
	 <div style="margin-top:12px; margin-left:12px" class="accordion">
<?
                if ($is_admin) { ?>
        <ul id='regex_tools'>
            <li><a id="rtool" href="/pages/moderate/<?=$website['Website']['id']?>">Moderate pending pages</a><?php echo $website['Website']['name'] . ' (' . $website['Website']['url'] . ')'; ?></li>
        </ul>
        <br class="clearfloat" />
<? } ?>

             <div class="page_add">

<?
		if ($over) {
?>
			<div id="goals" style="margin-left:20px; margin-top:10px">
			<center>
			  <div style="width: 500px; border:1px #000000 solid;height:auto;margin:12px; text-align:left; padding: 7px;">
			    <center>
			      Warning, you are over the recommended number of active links in the system. New links added are less likely to get approved.
			      </center>
			  </div>
			</center>
			</div>
	  <?

		}
        	$i = 0;
                echo $ajax->form('/pages/add', 'Post', array('url' => '/pages/add', 'before' => 'block_button()', 'complete' => 'reset()', 'update' => 'moderate_'.$i, 'model' => 'Pages', 'id'=>'form_'.$i));

		echo $form->hidden('Page.website_id', array("value" => $website['Website']['id']));
                if (!$is_admin) {

			echo $form->hidden('Page.demographic_sex', array("value" => $website['Website']['demographic_sex']));
			echo $form->hidden('Page.category', array("value" => $website['Website']['category']));
			echo $form->hidden('Page.content_rating', array("value" => $website['Website']['content_rating']));
		}

?>
			<table width=97% border=0>
			<tr>
			<td class="padd bordered">

			Page Title<br>

                <?

			 //		echo $form->hidden('Page.id', array('value' => $page['Page']['id']));

		echo $form->text('Page.title', array('size' => '40', 'id' => 'page_title_'.$i, 'class' => 'page_title'));
		echo $form->error('Page.title', NULL, array('class' => 'error_message'));
                ?>
                <br><br>Page URL
                <img style="display:none" width="16" height="16" id="check_url_img_<?php echo $i; ?>" src="/img/crowdignite/website_ajax_loader_grey.gif" /><br>
                <span id="error_label_check_url_img_<?php echo $i; ?>" class="error_label">This url is not part of the website</span>
                <?
			echo $form->text('Page.url', array('size' => '40', 'id' => 'page_url_'.$i, 'class' => 'page_url', 'data-number' => $i, 'data-last-url' => ''));
	        echo $form->error('Page.url', NULL, array('class' => 'error_message'));
                ?>
                <br><br>Page Description<br>

                <?
				echo $form->textarea('Page.description', array('escape' => 'true', 'class'=>'PageDescription', 'id' => 'page_description', 'maxlength'=>'250'));
				echo $form->error('Page.description', NULL, array('class' => 'error_message'));
                ?>
            	<br><br>


		 Expire Date (Optional)<br>
		<?
			echo $form->text('Page.expire', array('size' => '10', "class" => "expire_date", "id" => "expire_".$i, "value" => ''));
			echo '&nbsp;';
			echo $html->link('Clear', '#', array('class' => 'purple awesome btn_expire_clear', 'data-clear' => 'expire_'.$i));
		?>

		<? if ($is_admin) { ?>
					<div class="tag_container">
						<span>Tags</span> <input name="page_tags" class="page_tags" value="">
					</div>
		<? } ?>
                </td>
                <?
			if ($is_admin || 1) {
                ?>
		<td class="padd bordered">
				<? if ($is_admin) { ?>
		        <table class="details">
        		<tr>
	                	<td>Sex</td>
		                <td>
                                <?
	                	echo $form->select('Page.demographic_sex', $convert->demographic_sex_select(), $website['Website']['demographic_sex']);
                                ?>
        		        </td>
	        	</tr>
                        <tr>
		                <td>Content Rating</td>
		                <td>
                                <?
		                echo $form->select('Page.content_rating', $convert->content_rating_select(), $website['Website']['content_rating']);
                                ?>
		                </td>
	                	</tr>
                        <tr>
		                <td>Category</td>
		                <td>
                                <?
		                echo $form->select('Page.category', $convert->category_select(), $website['Website']['category'], array('class' => 'page_category', 'data-page' => 0));
                                ?>
		                </td>
                        </tr>
		                <?php
                            echo $this->element(
                                'crowdignite/pages/subcategories',
                                array(
                                    'page'     => array(
                                        'id'            => 0,
                                        'subcategories' => array(),
                                        'subcategory'   => '',
                                    )
                                )
                            );
                        ?>
	                </table>
	                <br>
	            <? } ?>
                Add an Image<br>

			<div id="addimagetabs_<?=$i?>" class="tabs-bottom addimagetabs">
				<ul>
					<li><a href="#tabs-1">From URL</a></li>
					<li><a href="#tabs-2">From Computer</a></li>
				</ul>
				<div id="tabs-1">
				  <div style="font-size: 14px">
				  <b>URL</b><br/>
				  </div>
					<?
                // Image
				echo $form->text('Page.image', array('size' => '40', "id" => "image_url_".$i, "data-number"=>$i, "class"=>"image_url" ));
					?>
					<a href="#" class="btn_get_image" data-number="<?=$i?>">Get Image</a>
					<br/>
				  <div style="font-size: 12px; color:red; display:none;" class="size_message">
				  Image should be at least <b>300x250</b> in size
				  </div>
				</div>
				<div id="tabs-2">
				  <div style="font-size: 14px">
				  <b>From Computer</b>
				  </div>
				  	<br/>
					<div id="file-uploader">
						<noscript>
							<p>Please enable JavaScript to use file uploader.</p>
						</noscript>
					</div>
				  <div style="font-size: 12px; color:red; display:none;" class="size_message">
				  Image should be at least <b>300x250</b> in size
				  </div>
				</div>
			</div>

                <?

	        echo $form->error('Page.image', NULL, array('class' => 'error_message'));

		echo $form->hidden('Page.x1', array("id" => "image_".$i."_x1"));
		echo $form->hidden('Page.y1', array("id" => "image_".$i."_y1"));
		echo $form->hidden('Page.x2', array("id" => "image_".$i."_x2"));
		echo $form->hidden('Page.y2', array("id" => "image_".$i."_y2"));
		?>

					<br>
	                <div>
						 <div id="turn_on_<?=$i?>" class="awesome purple crop turn_on" data-number="<?=$i?>">
						 	<a href="#" style="color:black" onClick="return false;">Crop Image</a>
						 </div>
						 <div id="turn_off_<?=$i?>" style="display:none" class="awesome purple crop turn_off" data-number="<?=$i?>">
						 	<a href="#" style="color:black" onClick="return false;">Turn Off Crop</a>
					     </div>

					     <div id="center_selection_wrap_<?=$i?>" style="display:none; margin:20px 0 0  20px; font-size:12px;" data-number="<?=$i?>">
					     	<input type="checkbox" name="centerSelection" id="centerSelection_<?=$i?>" class="centerselection" data-number="<?=$i?>"/> Expand selection from center<br>
					     </div>

	                </div>
		</td>
                <?
			  }
                ?>
                <td class="padd" width="330" rowspan="2">
                Image Preview
		<img style="display:none" id="preview_image_busy" src="/img/wait.gif">
		<div id="div_preview_image_<?=$i?>">
			<img id="preview_image_<?=$i?>"	style="width: expression( document.body.clientWidth > 329 ? '330px' : 'auto'); /* sets max-width for IE */
                                                        max-width:330px; /* this sets the max-width value for all standards-compliant browsers */
                                                        height: expression( this.scrollHeight > 329 ? '330px' : 'auto' ); /* sets max-height for IE */
                                                        max-height: 250px;"/>
		</div>
		<img id="test_image_size_<?=$i?>" style="display:none;"/>
		<div id="crop_<?=$i?>_dim"></div>

		<div id="previewtabs_<?=$i?>" class="previewtabs tabs-bottom">
			<ul>
				<li><a href="#ptabs-1">Large Preview</a></li>
				<li><a href="#ptabs-2">Small Preview</a></li>
			</ul>
			<div id="ptabs-1">
				<div id="large_preview_wrapper">
					<div id="preview_outside_large_wrap_<?=$i?>" style="width:300px;height:172px;overflow:hidden;">
						<img id="preview_outside_large_<?=$i?>"/>
					</div>
				</div>
			</div>
			<div id="ptabs-2">
				<div id="preview_outside_small_wrap_<?=$i?>" style="width:120px;height:120px;overflow:hidden;">
					<img id="preview_outside_small_<?=$i?>"/>
				</div>
			</div>
		</div>

		</td>
		</tr>
                <tr>
                        <td class="padd" colspan="2">
		                <table>
		                <tr>
		                        <td>
                                        <div style="display:none" id="add_button_wait">
                                			<img src="/img/wait.gif">
                                        </div>
                                        <div id="add_button" data-number="<?=$i?>">
        				  <?
	        				  echo $form->submit("Add",array("class" => "awesome purple btn_control accept"));
                                          ?>
                                        </div>
                                        <?
                                        echo $form->end();
                        		echo "</td><td>&nbsp;";

                        		echo "</td>";

                                        if ($is_admin || 1) {
				  ?>
					<td>

                                        </td>
				<?
					}
                                ?>
		                </tr>
		                </table>
                        </td>
                </tr>
                </table>
<?
		  echo $form->end();

?>
                        <div id="moderate_<?=$i?>" style="padding:5px 20px;">

                        </div>
                        <br>
                        <div class="site_info">
        		Website: <b><?=$website['Website']['name']?></b><br/>
        	        Website Status:
                        <?
                                if( $convert->website_status($website['Website']['status']) == 'Active' ) $status_color="green"; else $status_color="red";
				if ($is_admin) {
                        ?>
					<b class="<?=$status_color?>"><span>&bull;</span><a class="<?=$status_color?>" href="/websites/moderate/<?=$website['Website']['id']?>"><?=$convert->website_status($website['Website']['status'])?></a></b>
                        <?
                                } else {
                                        echo '<b class="'.$status_color.'"><span>&bull;</span>'.$convert->website_status($website['Website']['status']).'</b>';
                                }
                        ?>
                        </div>
        </div>
	</div>
	</div>
<?php echo $this->element('crowdignite/pages/tpl/subcategories'); ?>