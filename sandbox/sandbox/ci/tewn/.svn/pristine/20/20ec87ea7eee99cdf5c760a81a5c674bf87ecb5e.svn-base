<?php

namespace CI\Formulas;

class Widget
{
    protected $oSetting;
    /**
     * @codeCoverageIgnore
     */
    protected function getSettingObject()
    {
        if (empty($this->oSetting)) {
            $this->oSetting = new \CI\Config\System\Setting();
        }

        return $this->oSetting;
    }

    public function getWeightModifier($aAccount, $nRank, $nAccountCount, $bPaid = false)
    {
        $nReturn = 0;

        $oSetting = $this->getSettingObject();

        if ($nAccountCount !== 0) {
            $nWidgetAccountFallOffRate = $oSetting->get('WIDGET_ACCOUNT_FALLOFF_RATE');
            $nNumber                   = pow(($nAccountCount - $nRank), $nWidgetAccountFallOffRate);
            $nDenom                    = pow($nAccountCount, $nWidgetAccountFallOffRate);
            $nReturn                   = 1 - ($nNumber/$nDenom);
        } else {
            $nReturn = 1;
        }

        // Click-Through to Service
        // Level Agreement Ratio is a
        // tunable for how much we
        // care about meeting SLA
        // requirements vs getting
        // visitors into Crowd Ignite
        $nReturn = (1 - ($nReturn * $oSetting->get('WIDGET_SLA_TO_CTR_RATIO')));

        if ($nRank == 0) {
            // The top account gets a
            // bonus and gets an "increment"
            $nReturn += $oSetting->get('WIDGET_ACCOUNT_TOP_BONUS');
        }

        // Featured accounts get a bonus
        if ($aAccount['featured'] && $oSetting->get('WIDGET_GIVE_FEATURED_BONUS')) {
            $nReturn += $aAccount['featured'];
        }

        // Find out if website which is going to show the
        // page's is buying traffic
        $bBuyer = $aAccount['buying'];
        if ($bBuyer) {
            $nReturn += $oSetting->get('WIDGET_BUYER_BONUS');
        }

        // If we have a buyer & seller match,
        // give more bonuses
        if ($bPaid && $bBuyer) {
            $nReturn += $oSetting->get('WIDGET_PAID_MATCH_BONUS');
        }

        return $nReturn;
    }
}