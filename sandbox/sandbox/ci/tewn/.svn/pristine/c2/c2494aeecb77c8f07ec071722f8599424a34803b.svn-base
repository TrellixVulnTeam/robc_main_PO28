<?php

namespace CI\Content\Provider;
use CI\Content\Provider;
use CI\Http\Facade\Server;
use CI\Facade\DebugBar;

class Zemanta implements Provider
{
    public function provide(array $aOptions)
    {
        $sPlatform = '';
        if (isset($_SERVER['HTTP_USER_AGENT'])) {
            $oClient   = get_browser();
            $sPlatform = $oClient->platform;
        }
        $oOptions = new \CI\ArrayManipulator($aOptions);
        $oContext = new \CI\ArrayManipulator($oOptions->get('clicked_page', array()));
        if (is_array($oContext->get('Page', false))) {
            $oContext = new \CI\ArrayManipulator($oContext->get('Page', array()));
        }

        $oService = new \CI\Http\Service\Zemanta(
            array(
                'test'     => $oOptions->get('test', false),
                'platform' => $sPlatform,
                'context'  => array(
                    'url'     => Server::getCurrentUrl(),
                    'title'   => $oContext->get('title'),
                    'excerpt' => $oContext->get('description'),
                ),
            )
        );

        $aData = $oService->query()->getData();
        $aItem = array();

        if (!empty($aData['data']['results'][0])) {
            $aData = $aData['data']['results'][0];
            $aItem = array(
                'title'       => $aData['title'],
                'description' => $aData['excerpt'],
                'image'       => $aData['thumbnail_url'],
                'link'        => $aData['url'],
                'extra'       => '',
            );
        }
        return $aItem;
    }
}