<?php

namespace CI\Http;

class Referer
{
    protected $sHttpReferer;
    protected $oHttpServer;

    public function __construct()
    {
        $this->init();
        $this->sHttpReferer = $this->oHttpServer->getElement('HTTP_REFERER');

        if (empty($sReturn)) {
            echo("<!-- refer empty -->");
        } else {
            $this->sHttpReferer = trim($this->sHttpReferer);
        }
    }

    public function getUtmSourceReferer()
    {
        return $this->getParamQueryReferer('utm_source');
    }

    public function getUtmCampaignReferer()
    {
        return $this->getParamQueryReferer('utm_campaign');
    }

    public function getUtmMediumReferer()
    {
        return $this->getParamQueryReferer('utm_medium');
    }

    public function getParamQueryReferer($sParamName)
    {
        $sReturn = '';

        if (!empty($this->sHttpReferer)) {
            $oUrlFixer = new \CI\Filter\Url\Fixer();
            $sHttpReferer = $oUrlFixer->filter($this->sHttpReferer);
            $aParams = parse_url($sHttpReferer);

            if (isset($aParams['query'])) {
                parse_str($aParams['query'], $aQuery);
                $sReturn = isset($aQuery[$sParamName]) ? str_replace(',', '_', $aQuery[$sParamName]) : '';
            }
        }

        return $sReturn;
    }

    protected function init()
    {
        if (empty($this->oHttpServer)) {
            $this->oHttpServer = new \CI\Http\Server();
        }
    }
}