<?php

class StatsPage extends AppModel
{
    public $useTable = 'stats_page';
    public $useDbConfig = 'warehouse';

    protected $validator = null;

    public function __construct($id = false, $table = null, $ds = null)
    {
        $fields = array(
            'id'         => 'required|numeric',
            'website_id' => 'required|numeric',
        );

        $this->validator = new CI\Validator\Options($fields);
        parent::__construct($id, $table, $ds);
    }

    /**
     * validate the widget information
     *
     * @param  array  $widget Widget information
     *
     * @return boolean True if the data is valid in the array
     */
    private function _is_valid(array $page)
    {
        return $this->validator->isValid($page);
    }

    /**
     * Increment the stats or create the registry of a stats in stats_widgets_account
     *
     * @param  string  $created     The date of this increment
     * @param  array   $page        The page information with id, and website_id
     * @param  integer $impressions The impressions to increment
     *
     * @return boolean True if the increment was applied
     */
    public function increment_stats($created, $page, $impressions = 1) {
        if (empty($page)) {
            return false;
        }
        $result = false;
        if ($this->_is_valid($page) && strtotime($created)) {
            $impressions = intval($impressions);
            $query = "INSERT INTO stats_page (created, page_id, website_id, impressions)
                VALUES (
                    UNIX_TIMESTAMP('{$created}'), {$page['id']}, {$page['website_id']}, {$impressions}
                ) ON DUPLICATE KEY UPDATE impressions = impressions + {$impressions}";
            $result = $this->query($query);
        }
        return $result;
    }
}