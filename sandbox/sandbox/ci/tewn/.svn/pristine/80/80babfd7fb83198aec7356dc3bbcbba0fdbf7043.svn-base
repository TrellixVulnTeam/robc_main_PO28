<?php
class HistoryStat extends AppModel {

	var $useTable = false;
	var $name = 'HistoryStat';

	/* Memcached functions */
	function get_tpm_stats_cache($website_id, $date) {
		App::import('Component', 'CakeMemcache');
		$this->CakeMemcache =& new CakeMemcacheComponent(null);
		
		$key = $this->website_stats_tpm_key($website_id, $date);

		$json = $this->CakeMemcache->get($key);

		if ($json) {
			// Decode JSON
			$decoded = json_decode($json, 1);

			// Convert from stdClass
			$out = (array) $decoded;
			
			return $out;
		} else {
			return 0;
		}
	}

	function set_tpm_stats_cache($website_id, $date, $stats) {
		App::import('Component', 'CakeMemcache');
		$this->CakeMemcache =& new CakeMemcacheComponent(null);

		$oDate = new \CI\Date();
		if (false === $oDate->isToday($date)) {
			$key = $this->website_stats_tpm_key($website_id, $date);
			$value = json_encode($stats);
			$this->CakeMemcache->set($key, $value, false);
		}
	}

	function clear_tpm_stats_cache($website, $date) {
		App::import('Component', 'CakeMemcache');
		$this->CakeMemcache =& new CakeMemcacheComponent(null);

		$key = $this->website_stats_tpm_key($website['Website']['id'], $date);

		$this->CakeMemcache->delete($key);
	}

	function get_tpm_chart_cache($point) {
		$key = $this->website_chart_tpm_key($point);
		return $this->memcached_get_json($key);
	}

	function set_tpm_chart_cache($point, $stats) {
		$oDate = new \CI\Date();
		if (false === $oDate->isToday($point)) {
			$key = $this->website_chart_tpm_key($point);
			$this->memcached_set_json($key, $stats);
		}
	}

	function clear_tpm_chart_cache($point) {
		$key = $this->website_chart_tpm_key($point);

		$this->memcached_delete($key);
	}

	function get_chart_cache_domain($point, $domain_id) {
		if (UNIT_TEST) {
			return 0;
		}

		$key = $this->website_chart_domain_tpm_key($point, $domain_id);

		return $this->memcached_get_json($key);
	}

	function set_chart_cache_domain($point, $stats, $domain_id) {
		if (UNIT_TEST) {
			return 0;
		}

		$oDate = new \CI\Date();

		if (false === $oDate->isToday($point)) {
			$key = $this->website_chart_domain_tpm_key($point, $domain_id);
			$this->memcached_set_json($key, $stats);
		}
	}

	function clear_chart_cache_domain($point, $domain_id) {
		$key = $this->website_chart_domain_tpm_key($point, $domain_id);

		$this->memcached_delete($key);
	}

	/* Cache Key function */
	function website_stats_tpm_key($website_id, $date) {
		return "website_stats_tpm::".$website_id.":".$date;
	}

	function website_chart_tpm_key($point) {
		return "website_chart_tpm::".$point;
	}

	function website_chart_domain_tpm_key($point, $domain_id) {
		return "website_chart_domain_tpm::".$point.":".$domain_id;
	}

}
?>