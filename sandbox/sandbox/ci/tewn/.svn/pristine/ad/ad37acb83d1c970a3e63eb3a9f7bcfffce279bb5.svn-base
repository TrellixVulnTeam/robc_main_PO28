
<!-- <link rel="stylesheet" type="text/css" href="/css/jquery-ui-1.8.custom.css" /> -->
<link href="/js/jqtransformplugin/jqtransform.css" rel="stylesheet" type="text/css" />
<link href="/js/jquery.crayonbox.css" rel="stylesheet" type="text/css" />
<link href="/js/qtip2/jquery.qtip.min.css" rel="stylesheet" type="text/css" />
<link href="/css/widget_creation_redesign.css" rel="stylesheet" type="text/css" />
<!--[if lt IE 8]>
<link href="/css/widget_creation_redesign_ie.css" rel="stylesheet" type="text/css" />
<![endif]-->
<link href='http://fonts.googleapis.com/css?family=Arvo:700&v2' rel='stylesheet' type='text/css'>
<!-- <script src="/js/jquery.blockUI.min.js" type="text/javascript"></script>
<script src="/js/jquery-ui-1.8.custom.min.js" type="text/javascript"></script> -->
<script type="text/javascript" src="/js/jqtransformplugin/jquery.jqtransform.js"></script>
<script type="text/javascript" src="/js/jquery.crayonbox.js"></script>
<script type="text/javascript" src="/js/qtip2/jquery.qtip.min.js"></script>
<?
	echo $this->element('crowdignite/analytics');
?>
<script type="text/javascript" >
jQuery.noConflict();
jQuery(document).ready(function() {
    jQuery("form.jqtransform").jqTransform();

	if(	jQuery('#widget_rows').val() == 0 &&
		jQuery('#widget_columns').val() == 0 &&
		jQuery('#widget_width').val() == 0 &&
		jQuery('#widget_width').val() == 0 &&
		jQuery('#widget_image_width').val() == 0 &&
		jQuery('#widget_image_height').val() == 0 ) { // New widget
			jQuery('#step2').children('.advanced').children('.control').hide();
			jQuery('#step2').hide();
			jQuery('#step3').hide();
                        jQuery('#text_color').val("#000000");
                        jQuery('#background_color').val("transparent");
                        jQuery('#border_color').val('none');
                        jQuery('#image_border_color').val('#999999');
                        jQuery('#widget_font_size').val('12');
                        jQuery("#widget_font_size_select div.jqTransformSelectWrapper span").text('12');
                        jQuery('#ci_link').find('a.jqTransformCheckbox').addClass('jqTransformChecked');
	} else { // Existing widget, go to step 2
                        //check the colors from the existing widget
                        var bgcolor = validateHexColor( jQuery('#background_color').val(), 'transparent' );
                        jQuery('#background_color').val( bgcolor );

                        var text_color = validateHexColor( jQuery('#text_color').val(), '#000000' );
                        jQuery('#text_color').val( text_color );

                        var border_color = validateHexColor( jQuery('#border_color').val(), 'none' );
                        jQuery('#border_color').val( border_color );

                        var image_border_color = validateHexColor( jQuery('#image_border_color').val(), 'none' );
                        jQuery('#image_border_color').val( image_border_color );

			jQuery('.dimension').removeClass('selected').addClass('customized');
			jQuery('.layout').removeClass('selected').addClass('customized');
                        jQuery('.alignment').addClass('customized');

                        // if there are custom styles, get alignment
                        var customstyles = jQuery('#widget_custom_css').val();                        
                        if( customstyles.search('left aligned') != -1 ) {
                            jQuery('.alignment').removeClass('selected');
                            jQuery('div.alignment').each(function() {
                                if(jQuery(this).hasClass('left')) jQuery(this).addClass('selected');
                            });
                        }
                        if( customstyles.search('right aligned') != -1 ) {
                            jQuery('.alignment').removeClass('selected');
                            jQuery('div.alignment').each(function() {
                                if(jQuery(this).hasClass('right')) jQuery(this).addClass('selected');
                            });
                        }

                        var font_style = jQuery("#font_style").val();
                        if(font_style == "1" || font_style == "3" || font_style == "5" || font_style == "7") jQuery("#font_bold").addClass('selected');
                        if(font_style == "2" || font_style == "3" || font_style == "6" || font_style == "7") jQuery("#font_italic").addClass('selected');
                        if( Number(font_style) > 3)  jQuery("#font_underline").addClass('selected');
                        
			jQuery('#step1').hide();
			jQuery('#step3').hide();
			jQuery('.tab').removeClass('selected');
			jQuery('#tab2').addClass('selected');
			jQuery('#step2').children('.advanced').css('height','auto');
			jQuery('#step2').children('.advanced').children('.button').hide();
                        jQuery('#get_code_button').addClass('save');
	}
	jQuery('#widget_code').hide();
	jQuery('#preloader').hide();

	jQuery('#step2').children('.advanced').bind('click', function() {
		jQuery(this).children('.button').hide();
		jQuery(this).children('.control').fadeIn();
		jQuery(this).animate({
				height: '260px'
		  	}, 500, function() {				
                                jQuery('#step2').children('.advanced').css('height','auto');
		});
                jQuery('#step2').children('.advanced').unbind('click');
	});


/* Color boxes */
	jQuery('input.colorboxed').each( function(index, boxId) {
    	jQuery(boxId).crayonbox({
			colors: new Array( // this is the color palette
'#ffffcc','#ffff66','#ffcc66','#f2984c','#e1771e','#b47b10','#a9501b','#6f3c1b','#804000','#cc0000','#940f04','#660000','#c3d9ff','#99c9ff','#66b5ff','#3d81ee','#0066cc','#6c82b5','#32527a','#2d6e89','#006699','#215670','#003366','#000033','#caf99b','#80ff00','#00ff80','#78b749','#78b749','#2ba94f','#38b63c','#0d8f63','#2d8930','#1b703a','#11593c','#063e3f','#ffbbe8','#e895cc','#ff6fcf','#c94093','#9d1961','#800040','#800080','#72179d','#6728b2','#6131bd','#341473','#400058','#ffffff','#e6e6e6','#cccccc','#b3b3b3','#999999','#808080','#7f7f7f','#666666','#4c4c4c','#333333','#191919','#000000'
			),
			onSelection: function(){
                                switch( jQuery(boxId).attr('id') ) {
                                    case 'border_color':jQuery('#border_color_clear').show(); break;
                                    case 'image_border_color':jQuery('#image_border_color_clear').show(); break;
                                    case 'background_color':jQuery('#background_color_clear').show(); break;
                                }
				changeWidget();
			}
		});
  	});

	jQuery('div.colorbox').click(function() {
		jQuery(this).parent().children('.crayonbox').slideToggle();
	} );

        jQuery('input.colorboxed').blur( function(){
             var id = jQuery(this).attr('id');
             var defaultcolor = '#FFFFFF';
             switch(id) {
                case 'text_color':          defaultcolor='#000000'; break;
                case 'border_color':        defaultcolor='none'; break;
                case 'image_border_color':  defaultcolor='#999999'; break;
                case 'background_color':
                default:break;
             }
             var color = jQuery(this).val();
             var newcolor = validateHexColor(color, defaultcolor);
             jQuery(this).val(newcolor);

             if(getHexBrightness(newcolor) > 50 || newcolor == 'transparent' || newcolor == 'none' ){
                    jQuery(this).css("color", "#000000" );
                    jQuery(this).parent().css("color", "#000000" );
                    if( newcolor == 'transparent' || newcolor == 'none' ) newcolor = "#FFFFFF";
             } else {
                    jQuery(this).css("color", "#FFFFFF" );
                    jQuery(this).parent().css("color", "#FFFFFF" );
             }

             jQuery(this).parent().css('background-color',newcolor);
             changeWidget();
        });


	jQuery('#border_color_clear').click(function(){
		jQuery('#border_color').val('none');
		jQuery('#border_color').parent().css('background',"#FFFFFF");
                jQuery('#border_color').parent().parent().children('.crayonbox').slideUp();
                jQuery(this).hide();
		changeWidget();
		return false;
	});
	jQuery('#image_border_color_clear').click(function(){
		jQuery('#image_border_color').val('none');
		jQuery('#image_border_color').parent().css('background',"#FFFFFF");
                jQuery('#image_border_color').parent().parent().children('.crayonbox').slideUp();
                jQuery(this).hide();
		changeWidget();
		return false;
	});
	jQuery('#background_color_clear').click(function(){
		jQuery('#background_color').val('transparent');
		jQuery('#background_color').parent().css('background',"#FFFFFF");
                jQuery('#background_color').parent().parent().children('.crayonbox').slideUp();
                jQuery(this).hide();
		changeWidget();
		return false;
	});
        
        function validateHexColor( hexcolor, defaultc ){
            if( hexcolor.length == 6 || hexcolor.length == 3 ) {
                if( hexcolor.indexOf("#") == -1 ) hexcolor = '#'+hexcolor;
            }
            if ( /^#[a-f0-9]{6}$/i.test(hexcolor) || hexcolor == 'transparent' || hexcolor == 'none' ) {
                return hexcolor;
            } else {
                return defaultc;
            }
        }
        function getHexBrightness(hex) {
                var hex = hex.replace('#','');		 
                var c_r = hexDec(hex.substr(0, 2));
                var c_g = hexDec(hex.substr(2, 2));
                var c_b = hexDec(hex.substr(4, 2));

                return ((c_r * 299) + (c_g * 587) + (c_b * 114)) / 1000;
        }
        function hexDec(hex_string){
                hex_string = (hex_string+'').replace(/[^a-f0-9]/gi, '');
                return parseInt(hex_string, 16);
        }

/* 1st Step */
	jQuery('.layout').click(function(){
		var isCustom = jQuery('.layout').hasClass('customized');
		var change = true;
		if( isCustom ) {
			change = confirm("This will change the customized widget dimensions. Do you want to proceed?");
			if(change==true) {
				jQuery('.dimension').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.layout').removeClass('customized').removeClass('selected'); //remove custom and select
                                jQuery('.alignment').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.dimension.large').addClass('selected');
                                jQuery('.alignment.center').addClass('selected');
				jQuery(this).addClass('selected');
				changeWidget();
			}
		} else {
			jQuery('.layout').removeClass('selected');
			jQuery(this).addClass('selected');
			changeWidget();
		}
		return false;
	} );

	jQuery('.dimension').click(function(){
		var isCustom = jQuery('.dimension').hasClass('customized');
		var change = true;
		if( isCustom ) { //
			change = confirm("This will change the customized widget dimensions. Do you want to proceed?");
			if(change==true) {
				jQuery('.layout').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.dimension').removeClass('customized').removeClass('selected'); //remove custom and select
                                jQuery('.alignment').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.layout.rectangle').addClass('selected');
                                jQuery('.alignment.center').addClass('selected');
				jQuery(this).addClass('selected');
				changeWidget();
			}
		} else {
			jQuery('.dimension').removeClass('selected');
			jQuery(this).addClass('selected');
			changeWidget();
		}
		return false;
	} );

	jQuery('.alignment').click(function(){
		var isCustom = jQuery('.alignment').hasClass('customized');
		var change = true;
		if( isCustom ) { //
			change = confirm("This will change the customized widget dimensions. Do you want to proceed?");
			if(change==true) {
				jQuery('.layout').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.dimension').removeClass('customized').removeClass('selected'); //remove custom and select
                                jQuery('.alignment').removeClass('customized').removeClass('selected'); //remove custom and select
				jQuery('.layout.rectangle').addClass('selected');
                                jQuery('.dimension.large').addClass('selected');
				jQuery(this).addClass('selected');
				changeWidget();
			}
		} else {
			jQuery('.alignment').removeClass('selected');
			jQuery(this).addClass('selected');
			changeWidget();
		}
		return false;
	} );
/* eo 1st Step */

/* 2nd Step */
	jQuery("#widget_name").focus(function() {
		if( this.value == this.defaultValue ) {
			this.value = "";
		}
	}).blur(function() {
		if( !this.value.length ) {
			this.value = this.defaultValue;
		}
	});

	jQuery("#widget_font_select div.jqTransformSelectWrapper ul li a").click(function(){
                var value= jQuery("#widget_font_select div.jqTransformSelectWrapper span").text()
                jQuery("#widget_font").val(value);
		changeWidget();
		return false;
	});
	jQuery("#widget_font_size_select div.jqTransformSelectWrapper ul li a").click(function(){
                var value= jQuery("#widget_font_size_select div.jqTransformSelectWrapper span").text()
                jQuery("#widget_font_size").val(value);
		changeWidget();
		return false;
	});

	jQuery("#ci_link a").click(function(){
		changeWidget();
		return false;
	});

	jQuery('.custominput').change(function(){
		jQuery('.layout').removeClass('selected').addClass('customized');
		jQuery('.dimension').removeClass('selected').addClass('customized');
                jQuery('.alignment').addClass('customized');
		changeWidget();
		return false;
	});

        jQuery(".jqTransformButton").click(function(){
                jQuery(this).toggleClass("selected");
                var style = 0;
                if (jQuery("#font_bold").hasClass("selected")) style+=1;
                if (jQuery("#font_italic").hasClass("selected")) style+=2;
                if (jQuery("#font_underline").hasClass("selected")) style+=4;
                jQuery("#font_style").val(style);
                changeWidget();
                return false;
        });

	jQuery("#widget_image_padding_select div.jqTransformSelectWrapper ul li a").click(function(){
                var value= jQuery("#widget_image_padding_select div.jqTransformSelectWrapper span").text()
                jQuery("#widget_image_padding").val(value);
		changeWidget();
		return false;
	});  

/* eo 2nd Step */

/* 3rd Step */
	jQuery('#get_code_button').click(function() {
		jQuery("form#widget_create_form").submit();
		return false;
	});

	jQuery('#goto_dashboard_button').click(function() {
            var leave = true;
            if( jQuery('#widget_code').css('display') == "none" ) {
                leave = confirm("Do you want to return to the dashboard now and lose your changes? ");
            }
            if(leave) window.location.replace("http://crowdignite.com/dashboard/widgets");
	});

/* eo 3rd Step */

/* Steps Nav */
	jQuery('.tab').click(function() {
		var selectStep = jQuery(this).attr('id').charAt(3);
		gotoStep(selectStep);
		return false;
	} );

	function gotoStep( step ){
		if( parseInt(step)-1 == 2) {
			if (jQuery("#widget_name").val() == "Type in your Widget name" || jQuery("#widget_name").val().trim() == "" ) {
				alert ( "Please provide a valid Widget name" );
				jQuery("#widget_name").focus();
				return false;
			}
			if( jQuery("#WidgetWebsiteId").val() == "0"   ){
				alert ( "Please select your Website" );
				jQuery("#WidgetWebsiteId").focus();
				return false;
			}
		}
		if( step <=3 ) {
			jQuery('.step').hide();
			jQuery('#step'+step).show();
			jQuery('.tab').removeClass('selected');
			jQuery('.tab').children('.nextarrow').fadeOut('slow');
			jQuery('#step_tabs').children('#tab'+step).addClass('selected');
		}
                if( step > 3 ) {
                    var leave = true;                    
                    if( jQuery('#widget_code').css('display') == "none" ) {
                        leave = confirm("Don't forget to Get the Widget Code to keep your changes.\nDo you want to continue? ");
                    }
                    if(leave) window.location.replace("http://crowdignite.com/dashboard/widgets");
                }
	}

	jQuery('.tab').children('.icon').mouseover(function() {
		jQuery(this).parent().parent().children('.selected').children('.nextarrow').stop(true, true).fadeIn('slow');
	})

        /*
	jQuery('#btn_next').click(function(){
		var selectedStep = jQuery('#step_tabs').children('.selected').attr('id').charAt(3);
		var nextStep = parseInt(selectedStep)+1;
		gotoStep(nextStep);
	});

	jQuery('#btn_next').mouseover(function(){
		jQuery(this).stop().animate({
			opacity: 1,
			right: '-20'
		  }, 'fast');
		  jQuery('#step_tabs').children('.selected').children('.nextarrow').stop(true, true).fadeIn('slow');
	}).mouseout(function(){
		jQuery(this).stop().animate({
			opacity: 0.75,
			right: '-10'
		  }, 'fast');
		  jQuery('#step_tabs').children('.selected').children('.nextarrow').stop(true, true).fadeOut('slow');
	});*/

/* eo Steps nav*/


	jQuery("form#widget_create_form").submit( function(){ // Form submit
		// store the values from the form input boxes to then send via ajax
        var website_id       = jQuery('#WidgetWebsiteId').attr('value');
        var widgetname       = jQuery('#widget_name').attr('value');
        var font             = jQuery('#widget_font').attr('value');
        var font_size        = jQuery('#widget_font_size').attr('value');
        var font_style       = jQuery('#font_style').attr('value');
        var text_color       = jQuery('#text_color').attr('value');
        var background_color = jQuery('#background_color').attr('value');
        var border           = jQuery('#border_color').attr('value');
        var image_border     = jQuery('#image_border_color').attr('value');
        var image_padding    = jQuery('#widget_image_padding').attr('value');
        var width            = jQuery('#widget_width').attr('value');
        var height           = jQuery('#widget_height').attr('value');
        var image_width      = jQuery('#widget_image_width').attr('value');
        var image_height     = jQuery('#widget_image_height').attr('value');
        var cols             = jQuery('#widget_columns').attr('value');
        var rows             = jQuery('#widget_rows').attr('value');
        var customcss        = jQuery('#widget_custom_css').attr('value');
        var account_id       = jQuery('#website_account_id').attr('value');
        var widgetid         = 0;
        var widgetstyleid    = 0;
        var powered          = 0;
        var widget_variety   = 0;

                if( jQuery('#widget_id').length > 0 ) { var widgetid = jQuery('#widget_id').attr('value'); }
                if( jQuery('#widgetstyle_id').length > 0 ) { var widgetstyleid = jQuery('#widgetstyle_id').attr('value'); }
                if( jQuery('#ci_link').find('a.jqTransformCheckbox').hasClass('jqTransformChecked') ) {
                    var powered = 1;
                }

               if ( jQuery( "#widget_variety" ).prev().hasClass( 'jqTransformChecked' ) ) {
                    widget_variety = 1;
               }
                jQuery('#goto_dashboard_button').hide();
		jQuery('#get_code_button').hide(function() { jQuery('#preloader').show(); });

			jQuery.ajax({
				type: "POST",
				dataType: 'json',
				url: "/widgets/create",
				data: "action=addWidget&widgetid="+widgetid+"&widgetstyleid="+widgetstyleid+"&website_id="+ website_id +"&widgetname="+ widgetname+"&font="+ font+"&text_color="+ text_color+"&background_color="+ background_color+"&border="+ border+"&image_border="+ image_border+"&powered="+ powered+"&width="+ width+"&height="+ height+"&image_width="+image_width+"&image_height="+image_height+"&cols="+cols+"&rows="+rows+"&customcss="+customcss+"&font_size="+font_size+"&font_style="+font_style+"&image_padding="+image_padding + "&widget_variety=" + widget_variety,
				success: function(j){
					jQuery('#preloader').remove();
					jQuery('#widget_code').fadeIn('slow');
                                        jQuery('#goto_dashboard_button').fadeIn('slow');
                                        jQuery('#widget_code_instructions').html('Paste the following code in the body of the website where you want to position your new widget.');
					if(j.error)	{
						jQuery('#widget_code').val("Due an error, your widget creation has failed. Please try again. ("+j.msg+")");
					} else {
						<?=$this->element('widget_async_start')?>
						async_code += j.msg;
						<?=$this->element('widget_async_end')?>
					    if (powered) { // fixed
						var widget_powered_text = "<?=$this->element('widget_powered')?>";
						async_code += "<div id='widget_powered_div' style='width: "+width+"px; background-color: "+background_color+"'><a href='http://<?=SITE_URL?>/account/"+account_id+"' style='font: "+font+"; color:"+text_color+";' target=_blank>"+widget_powered_text+"</a></div>";
					    }
					    jQuery('#widget_code').val(async_code);
					}
				}
			}); //ajax
                
		return false;
	});

        function fill_custom_css( width, height, imageW, imageH, cols, rows, alignment ) {
            /* Fills custom_css text area with the styles for proper image alignment */            
var alignment_css = "/*FLAGCOMMENT*/BR"+
"#WIDGETID table {BR"+
"    border-spacing:0;BR"+
"    display:block;BR"+
"    table-layout:fixed;BR"+
"}BR"+
"#WIDGETID table tr {BR"+
"    height:TRHEIGHTpx;BR"+
"    width:TRWIDTHpx;BR"+
"    display:inline-block;BR"+
"    float:left;BR"+
"    margin:0;BR"+
"    padding:0;BR"+
"}BR"+
"#WIDGETID table tr td {BR"+
"    height:TDHEIGHTpx;BR"+
"    min-width:TDWIDTHpx;BR"+
"    width:TDWIDTHpx;BR"+
"    display:block;BR"+
"    float:left;BR"+
"    margin:0;BR"+
"    padding:5px 0 0 5px;BR"+
"    text-align:left;BR"+
"}BR"+
"#WIDGETID table tr td>br {BR"+
"    display:none;BR"+
"}BR"+
"#WIDGETID table tr td>a {BR"+
"    float:FLOATALIGN;BR"+
"    margin-right:5px;BR"+
"}BR"+
"#WIDGETID table tr td>div {BR"+
"    margin:MARGINTOPpx 0 0 5px!important;BR"+
"    width:DIVWIDTHpx!important;BR"+
"    clear:none!important;BR"+
"    display: block;BR"+
"    float:left;BR"+
"}BR"+
"#WIDGETID table tr td>div a{BR"+
"    display:inline;BR"+
"}";
            
            var mtop = 5;
            var float_align = "left";
            if( imageH <= 50 ) mtop = 3;
            if(alignment == "right") float_align = "right";

            var widget_id = "<?php echo $this->data['Widget']['id']; ?>";
            if(widget_id == "") {
                widget_id = "_CI_widget_1";
            } else {
                widget_id = "_ci_widget_div_<?php echo $this->data['Widget']['id']; ?>";
            }
            alignment_css = alignment_css.replace("FLAGCOMMENT", alignment+" aligned" );
            alignment_css = alignment_css.replace(RegExp('WIDGETID',"g"), widget_id );
            alignment_css = alignment_css.replace(RegExp('TRHEIGHT',"g"), imageH+5 ).replace(RegExp('TRWIDTH',"g"), width );
            alignment_css = alignment_css.replace(RegExp('TDHEIGHT',"g"), imageH+5 ).replace(RegExp('TDWIDTH',"g"), (width/cols)-5 );
            alignment_css = alignment_css.replace(RegExp('DIVWIDTH',"g"), imageW*1.6 ).replace(RegExp('MARGINTOP',"g"), mtop );
            alignment_css = alignment_css.replace(RegExp('FLOATALIGN',"g"), float_align);
            alignment_css = alignment_css.replace(RegExp("BR","g"), "\n");
            
            jQuery('#widget_custom_css').val(alignment_css);
        }

	function changeWidget() {
		var widget_rows = jQuery('#widget_rows').val();
		var widget_cols = jQuery('#widget_columns').val();
		var widget_imageW = jQuery('#widget_image_width').val();
		var widget_imageH = jQuery('#widget_image_height').val();
		var widget_height = jQuery('#widget_height').val();
		var widget_width = jQuery('#widget_width').val();

		var widget_border = jQuery('#border_color').val();
		var widget_background = jQuery('#background_color').val();
		var widget_fontcolor = jQuery('#text_color').val();
		var widget_imageborder = jQuery('#image_border_color').val();
                var widget_imagepadding = jQuery('#widget_image_padding').val();
		var widget_font = jQuery('#widget_font').val(); //jQuery("#widget_font div.jqTransformSelectWrapper span").text();
                var widget_font_size = jQuery('#widget_font_size').val();
                var widget_font_style = jQuery("#font_style").val();
		var ci_link = jQuery("#ci_link span a").hasClass('jqTransformChecked');
		if( ci_link == true ) var ci_link_add=30; else var ci_link_add=0;

		var customized = false;
		if( jQuery('.layout').hasClass('customized') == true || jQuery('.dimension').hasClass('customized') == true || jQuery('.alignment').hasClass('customized') == true ) customized = true;

		if( !customized ) {
			var layout = jQuery('.layout.selected').attr('class').split(' ')[1];
			var dimension = jQuery('.dimension.selected').attr('class').split(' ')[1];
                        var alignment = jQuery('.alignment.selected').attr('class').split(' ')[1];

                        var preLayouts = {
                                'single': {
                                    'large': {
                                        'center': function() { widget_rows = 1; widget_cols = 1; widget_imageW = 120; widget_imageH = 74; widget_width = 125; widget_height = 125; },
                                        'left': function() { widget_rows = 1; widget_cols = 1; widget_imageW = 50; widget_imageH = 50; widget_width = 300; widget_height = 70; },
                                        'right': function() { widget_rows = 1; widget_cols = 1; widget_imageW = 50; widget_imageH = 50; widget_width = 300; widget_height = 70; }
                                    }
                                },
                                'row': {
                                    'large': {
                                        'left': function() { widget_rows = 1; widget_cols = 3; widget_imageW = 80; widget_imageH = 80; widget_width = 728; widget_height = 90; },
                                        'right': function() { widget_rows = 1; widget_cols = 3; widget_imageW = 80; widget_imageH = 80; widget_width = 728; widget_height = 90; }
                                    }
                                },
                                'col': {
                                    'medium': {                                        
                                        'left': function() { widget_rows = 4; widget_cols = 1; widget_imageW = 55; widget_imageH = 55; widget_width = 300; widget_height = 250;},
                                        'right': function() { widget_rows = 4; widget_cols = 1; widget_imageW = 55; widget_imageH = 55; widget_width = 300; widget_height = 250;}
                                    },
                                    'large': {
                                        'center': function() { widget_rows = 4; widget_cols = 1; widget_imageW = 100; widget_imageH = 90; widget_width = 120; widget_height = 600;},
                                        'left': function() { widget_rows = 13; widget_cols = 1; widget_imageW = 40; widget_imageH = 40; widget_width = 160; widget_height = 600;},
                                        'right': function() { widget_rows = 13; widget_cols = 1; widget_imageW = 40; widget_imageH = 40; widget_width = 160; widget_height = 600;}
                                    }
                                },
                                'square': {
                                    'large': { 
                                        'center': function() { widget_rows = 2; widget_cols = 2; widget_imageW = 120; widget_imageH = 74; widget_width = 250; widget_height = 250;}                                        
                                    }
                                },
                                'rectangle': {
                                    'large':{
                                        'center': function() { widget_rows = 2; widget_cols = 3; widget_imageW = 90; widget_imageH = 70; widget_width = 300; widget_height = 250;},
                                        'left': function() { widget_rows = 2; widget_cols = 3; widget_imageW = 70; widget_imageH = 70; widget_width = 600; widget_height = 160;},
                                        'right': function() { widget_rows = 2; widget_cols = 3; widget_imageW = 70; widget_imageH = 70; widget_width = 600; widget_height = 160;}
                                    }
                                }
                        }

                        if ( layout in preLayouts && dimension in preLayouts[layout] && alignment in preLayouts[layout][dimension] ) {
                            preLayouts[layout][dimension][alignment]();
                        } else {
                        
                            // calculate widget size using predefined image sizes
                            switch( layout ) {
                                    case "single": 		widget_rows = 1; widget_cols = 1; break;
                                    case "row": 		widget_rows = 1; widget_cols = 3; break;
                                    case "col": 		widget_rows = 3; widget_cols = 1; break;
                                    case "square": 		widget_rows = 2; widget_cols = 2; break;
                                    case "rectangle":           widget_rows = 2; widget_cols = 3; break;
                                    default: break;
                            }
                                
                            if( alignment=="center" ) {
                                switch( dimension ) {
                                        case "small": 		widget_imageW = 50;  widget_imageH = 50; break;
                                        case "medium": 		widget_imageW = 80;  widget_imageH = 80; break;
                                        case "large": 		widget_imageW = 100; widget_imageH = 100; break;
                                        case "xlarge": 		widget_imageW = 120; widget_imageH = 120; break;
                                        case "xxlarge":         widget_imageW = 150;  widget_imageH = 150; break;
                                        default: break;
                                }
                                
                                widget_height = (widget_rows * widget_imageH) + (50 * widget_rows ) + ci_link_add;
                                widget_width = widget_cols * widget_imageW + 15;

                            } else { // image aligned to left or right
                                switch( dimension ) {
                                        case "small": 		widget_imageW = 50;  widget_imageH = 50; break;
                                        case "medium": 		widget_imageW = 60;  widget_imageH = 60; break;
                                        case "large": 		widget_imageW = 90; widget_imageH = 90; break;
                                        case "xlarge": 		widget_imageW = 100; widget_imageH = 100; break;
                                        case "xxlarge":         widget_imageW = 110;  widget_imageH = 110; break;
                                        default: break;
                                }
                                widget_height = (widget_rows * (widget_imageH+5) )+5 + ci_link_add;
                                widget_width = (widget_imageW * 2.8 + 15) * widget_cols;

                            }
                        }                        
			jQuery('#widget_image_width').val(widget_imageW);
			jQuery('#widget_image_height').val(widget_imageH);
			jQuery('#widget_rows').val(widget_rows);
			jQuery('#widget_columns').val(widget_cols);

			jQuery('#widget_height').val(widget_height);
			jQuery('#widget_width').val(widget_width);

                        if( alignment!="center" ) {
                            fill_custom_css( widget_width, widget_height, widget_imageW, widget_imageH, widget_cols, widget_rows, alignment );
                        } else {
                            jQuery('#widget_custom_css').val("");
                        }


		} else {
                        var alignment = jQuery('.alignment.selected').attr('class').split(' ')[1];
                        
			// check and correct custom values
			if( widget_height == 0 ) { widget_height = (widget_rows * widget_imageH) + (50 * widget_rows ); }
			if( widget_width == 0 ) { widget_width = widget_cols * widget_imageW + 15; }
			if( widget_height < 50 ) { widget_height = 50; }
			if( widget_width < 50 ) { widget_width = 50; }
			if( widget_height > 900 ) { widget_height = 900; }
			if( widget_width > 900 ) { widget_width = 900; }

			jQuery('#widget_height').val( widget_height );
			jQuery('#widget_width').val(widget_width);

			if( widget_imageW < 20 ) { widget_imageW = 20;  }
			if( widget_imageH < 20 ) { widget_imageH = 20;  }
			if( widget_imageW > 900 ) { widget_imageW = 900;  }
			if( widget_imageH > 900 ) { widget_imageH = 900;  }

                        jQuery('#widget_image_width').val(widget_imageW);
                        jQuery('#widget_image_height').val(widget_imageH);

			if( widget_rows < 1 ) { widget_rows = 1; }
			if( widget_cols < 1 ) { widget_cols = 1; }
			if( widget_rows > 20 ) { widget_rows = 20; }
			if( widget_cols > 20 ) { widget_cols = 20; }
			jQuery('#widget_rows').val(widget_rows);
			jQuery('#widget_columns').val(widget_cols);
		}
		buildWidget( widget_cols, widget_rows, widget_fontcolor, widget_font, widget_font_size, widget_font_style, widget_background, widget_border, widget_imageborder, widget_imagepadding, widget_width, widget_height, widget_imageW, widget_imageH, ci_link, alignment );
	}

	/* buildWidget  */
	function buildWidget( cols, rows, forecolor, font, font_size, font_style, backcolor, bordercolor, imageborder, imagepadding, widgetW, widgetH, imageW, imageH, ci_link, alignment ) {
		if(bordercolor!="none") {
			bordercolor='1px solid '+bordercolor;
			//widgetW=widgetW-1;
			//widgetH=widgetH-1;
		}
		if(imageborder!="none") image='1px solid '+imageborder;

		jQuery('#your_widget').empty();
		jQuery('#your_widget').css("color", forecolor).css("background", backcolor).css("border", bordercolor).css("width", widgetW).css("height", widgetH).css("font-family", font);

                var font_style_css = "";
                if(font_style == "1" || font_style == "3" || font_style == "5" || font_style == "7") font_style_css+= "font-weight:bold; ";
                if(font_style == "2" || font_style == "3" || font_style == "6" || font_style == "7") font_style_css+= "font-style:italic; ";
                if( Number(font_style) > 3)  font_style_css+= "text-decoration:underline; ";

		jQuery('#your_widget').append ('<table width="100%" cellpadding="3" border="0" align="center" id="widget_links" style="font-size:'+font_size+'px;"/>');

                var c=1;
		for (var row=0; row<rows; row++) {
			var tr = jQuery("<tr/>");
			for(var col=0; col<cols; col++){
				var td = jQuery("<td/>").attr("align", "center").attr("valign", "top");				
				var img = jQuery("<img/>").attr("src", "/img/widget_creation/adsample.jpg").css("width", imageW ).css("height", imageH ).css("border","1px solid "+imageborder).css("padding",imagepadding+"px");
				var text = jQuery("<div/>").attr("style", "clear:both; color:"+forecolor+"; "+font_style_css ).html("Sample<br>Text<br>Here");
				td.append(img);
				td.append(text);
				tr.append(td);
                                c=c+1;
                                if(c>12) c=1;
			}
			jQuery('#widget_links').append(tr);
		}
                
                jQuery('#your_widget').removeClass('aligned');
                if(alignment == "left" || alignment == "right" ) {
                    jQuery('#your_widget').addClass('aligned');
                    jQuery('#your_widget table tr').css({ 'height': (Number(imageH)+Number(imagepadding*2)+5) +'px' });
                    jQuery('#your_widget table tr td').css({ 'height':(Number(imageH)+5) +'px' , 'width': (Number(widgetW) / Number(cols) )-5 +'px'});
                    jQuery('#your_widget table tr td div').css({ 'width':(Number(imageW)*1.6)+'px'});
                    if(alignment == "right") {
                        jQuery('#your_widget table tr td img').css({ 'float':'right'});
                    }

                    if( imageH <= 50 ) {
                        jQuery('#your_widget table tr td div').text("Sample Text");
                        jQuery('#your_widget table tr td div').css("margin","3px 0 0 5px");
                    }
                }

                jQuery('#cilinkdiv').empty();
                jQuery('#cilinkdiv').removeAttr('style');
		if(ci_link==1) {
                        jQuery('#your_widget').css("border-bottom", "none");                                               
                        jQuery('#cilinkdiv').css("border",bordercolor);
                        jQuery('#cilinkdiv').css("border-top", "none");
                        jQuery('#cilinkdiv').css("width",widgetW).css("background-color",backcolor);
                        jQuery('#cilinkdiv').append ("<a href='#' style='font-family: "+font+"; color:"+forecolor+"; font-size:"+font_size+"px'>Powered by Crowd Ignite.com</a>");
                        //jQuery('#widget_links').append('<tr><td colspan="'+ cols +'" textalign="center" height="30" id="powered_by">Powered by Crowd Ignite.com</td></tr>');
		}
		jQuery('#widget_size').empty();
		jQuery('#widget_size').append('WIDTH: <span>'+widgetW+'px</span><br/>HEIGHT: <span>'+widgetH+'px</span>');
	}

	changeWidget();

	jQuery(".tooltip").qtip({
		position: {
			my:'top center',
			at:'bottom center'
		},
		style: {
			classes: 'ui-tooltip-light'
		}
	});
});

var isInitialPageLoad = true;
var sizeOffset = 0;

</script>  
<!--[if lt IE 9]>
<script type="text/javascript" >
if(typeof String.prototype.trim !== 'function') {
  String.prototype.trim = function() {
    return this.replace(/^\s+|\s+$/g, '');
  }
}
</script>
<![endif]-->
<form id="widget_create_form" method="post" class="jqtransform">
<div class="row">
<div id="content" class="column grid_12">
<h3 class="topContent">Crowd Ignite Widget Creation</h3>
<div id="content_area">
<div class="grid_12">

    <div id="step_tabs" class="grid_12">
        <div id="tab1" class="tab selected"><span class="icon"></span><a href="#">Select your Widget Type</a><div class="nextarrow"></div></div>
        <div id="tab2" class="tab"><span class="icon"></span><a href="#">Customize your Widget</a><div class="nextarrow"></div></div>
        <div id="tab3" class="tab"><span class="icon"></span><a href="#">Publish your New Widget</a><div class="nextarrow"></div></div>
    </div>
	<div class="clear"></div>

    <div id="wrapper" class="grid_12">
    	<?php /* <div id="btn_next"></div> */ ?>
        <div id="step_container" >

                <div id="step1" class="step">
                    <div id="white_arrow"></div>
                    <div class="step_row grid_12" >
                        <div class="name tooltip" title="Select the basic layout for your widget">Widget Layout</div>
                        <div class="control">
							<div class="layout single">
                            	<a href="#"></a><br/>
                                <span>Single</span>
                            </div>
							<div class="layout row">
                            	<a href="#"></a><br/>
                                <span>Row</span>
                            </div>
							<div class="layout col">
                            	<a href="#"></a><br/>
                                <span>Column</span>
                            </div>
							<div class="layout square">
                            	<a href="#"></a><br/>
                                <span>Square</span>
                            </div>
							<div class="layout rectangle selected">
                            	<a href="#"></a><br/>
                                <span>Rectangle</span>
                            </div>

                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="step_row alt grid_12" >
                        <div class="name tooltip" title="Select the size of your widget. You can adjust later.">Dimensions</div>
                        <div class="control">
							<div class="dimension small">
                            	<a href="#"></a><br />
                                <span>Small</span>
                            </div>
							<div class="dimension medium">
                            	<a href="#"></a><br/>
                                <span>Medium</span>
                            </div>
							<div class="dimension large selected">
                            	<a href="#"></a><br/>
                                <span>Large</span>
                            </div>
							<div class="dimension xlarge">
                            	<a href="#"></a><br/>
                                <span>XL</span>
                            </div>
							<div class="dimension xxlarge">
                            	<a href="#"></a><br/>
                                <span>XXL</span>
                            </div>
                        </div>
                        <div class="clear"></div>

                    </div>

                    <div class="step_row grid_12" >
                        <div class="name tooltip" title="How would you like to position the image and text?">Image Alignment</div>
                        <div class="control">
                            <div class="alignment center selected">
                            	<a href="#"></a><br />
                                <span>Center</span>
                            </div>
                            <div class="alignment left">
                            	<a href="#"></a><br/>
                                <span>Left</span>
                            </div>
                            <div class="alignment right">
                            	<a href="#"></a><br/>
                                <span>Right</span>
                            </div>

                        </div>
                        <div class="clear"></div>

                    </div>
                </div><!-- step 1 -->

                <div id="step2" class="step">
                    <div id="white_arrow"></div>
                    <div class="step_row grid_12" >
                        <div class="name tooltip" title="Give your widget a name.">Widget Name</div>
                        <div class="control">
                         <?php
                                     // Figure out the default website
                                     if (isset($this->data['Widget']['website_id'])) {
                                             $website_id_default = $this->data['Widget']['website_id'];

                                             // Print out all the websites
                                             foreach($websites as $website) {
                                                     if ($website['Website']['id'] == $website_id_default) {
                                                             echo $convert->get_website_name($website);
                                                             break;
                                                     }
                                             }
                                             echo $form->hidden("Widget.website_id");
                                     } else {
                                             $website_id_default = $websites[0]['Website']['id'];

                                             $dropdown = array();
                                             $dropdown += array('0'=>'Please select your Website');
                                             foreach($websites as $website) {
                                                     $dropdown += array($website['Website']['id'] => $convert->get_website_name($website));
                                             }

                                             echo $form->select("Widget.website_id", $dropdown, null, array("showParents" => false), false);
                                     }
                        ?>
                        </div>
                        <div class="control">
                        <?php
                            echo $form->text('Widget.name', array('size' => "30", 'id' => 'widget_name'));
                        ?>
                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="step_row alt grid_12" >
                        <div class="name tooltip" title="Customize the text links in your widget.">Font Options</div>
                        <div class="control fleft">
                            <div id="widget_font_select">
                            <?php
                            $font_options = array('Arial' => 'Arial', 'Times' => 'Times', 'Courier' => 'Courier', 'Times' => 'Times', 'Tahoma' => 'Tahoma', 'Verdana' => 'Verdana');
                            echo $form->select("WidgetStyle.font", $font_options, null, array("escape" => false, "id"=>"widget_font"), false);
                            ?>
                            </div>
                            <div id="widget_font_size_select">
                            <div class="spacemaker"></div>
                            <?php
                            $font_sizes = array('8' => '8', '9' => '9', '10' => '10', '11' => '11', '12' => '12', '13' => '13', '14' => '14','15' => '15','16' => '16','17' => '17','18' => '18');
                            echo $form->select("WidgetStyle.font_size", $font_sizes, null, array("escape" => false, "id"=>"widget_font_size"), false);
                            ?>
                            </div>
                        </div>
                        <div class="control">
                            <input type="button" id="font_bold" value="Bold"/>
                            <input type="button" id="font_italic" value="Italic"/>
                            <input type="button" id="font_underline" value="Underline"/>
                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="step_row grid_12" >
                        <div class="name tooltip" title="Add borders and background colors to the widget and images.">Borders & Colors</div>
                        <div class="columnr">
                        <div class="control fleft">
                            <div class="colorbox">
                                <span>Font color</span>
                                <?php
				echo $form->text('WidgetStyle.text_color', array('size' => "8", 'id' => 'text_color', 'class' => 'colorboxed jqtranformdone'));
                                ?>
                                <div class="clear"></div>
                            </div>
                        </div>
                            <div class="control fleft bot">
                                <div class="colorbox">
                                    <span>Background color</span>
                                    <?php
                                    echo $form->text('WidgetStyle.background_color', array('size' => "8", 'id' => 'background_color', 'class' => 'colorboxed jqtranformdone'));
                                    ?>
                                    <div class="clear"></div>
                                </div>
                                <a id="background_color_clear" class="colorbox_clear_button" href="#"></a>
                            </div>
                        </div>
                        <div class="columnr">
                            <div class="control">
                                <div class="colorbox">
                                    <span>Widget border color</span>
                                    <?php
                                    echo $form->text('WidgetStyle.border', array('size' => "8", 'id' => 'border_color', 'class' => 'colorboxed jqtranformdone'));
                                    ?>
                                    <div class="clear"></div>
                                </div>
                                <a id="border_color_clear" href="#" class="colorbox_clear_button"></a>
                            </div>
                            <div class="control bot">
                                 <div class="colorbox">
                                    <span>Image border color</span>
                                    <?php
                                    echo $form->text('WidgetStyle.image_border', array('size' => "8", 'id' => 'image_border_color', 'class' => 'colorboxed jqtranformdone'));
                                    ?>
                                    <div class="clear"></div>
                                </div>
                                <a id="image_border_color_clear" href="#" class="colorbox_clear_button"></a>
                            </div>
                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="step_row alt grid_12" >
                        <div class="name tooltip" title="This might help you get more traffic :)">Crowd Ignite Link</div>
                        <div id="cilink_desc"class="control fleft">
                            Get <?=(DEFAULT_REFER_TRANSFER_RATE*100)?>% of the traffic of the websites referred through this link
                        </div>
                        <div id="ci_link" class="control fleft">
                                <?php
                                echo $form->checkbox("Widget.powered", array("id" => "powered"));
                                ?>
                                <span id="cilink_label">Show Crowd Ignite Link</span>
                        </div>
                        <div class="clear"></div>
                    </div>

                    <div class="step_row grid_12 advanced" >
                        <div class="name tooltip" title="You can customize your widget even more by adding extra CSS.">Advanced</div>
                        <span class="button"></span>
                        <div class="control title fleft">
                            Widgets variety
                        </div>
                        <div class="control fleft">
                            <?php
                                $chkbox_options = array("id" => "widget_variety");
                                if (isset($website['Widget']['widget_variety']) && $website['Widget']['widget_variety'] == 1) {
                                    $chkbox_options['checked'] = 1;
                                }

                                echo $form->checkbox('Widget.widget_variety', $chkbox_options);
                            ?>
                        </div>
                        <div class="clear"></div>
                        <div class="name" title="">&nbsp;</div>
                        <div class="control title fleft">
                            Custom Widget Size
                        </div>
                        <div class="control fleft">
                                <span>Width</span>
                                <?php
                                echo $form->text('Widget.width', array('size' => "4", 'id' => 'widget_width', 'class' => 'custominput'));
                                ?>                                
                                <span>Height</span>
                                <?php
                                echo $form->text('Widget.height', array('size' => "4", 'id' => 'widget_height', 'class' => 'custominput'));
                                ?>
                                <span>px</span>
                        </div>
                        <div class="clear"></div>
                        <div class="name" title="">&nbsp;</div>
                        <div class="control title fleft">
                            Custom Image Size
                        </div>
                        <div class="control fleft">
                                <span>Width</span>
                                <?php
                                echo $form->text('Widget.image_width', array('size' => "4", 'id' => 'widget_image_width', 'class' => 'custominput'));
                                ?>
                                <span>Height</span>
                                <?php
                                echo $form->text('Widget.image_height', array('size' => "4", 'id' => 'widget_image_height', 'class' => 'custominput'));
                                ?>
                                <span>Padding</span>
                                <div id="widget_image_padding_select">
                                <?php
                                    $padding_options = array('0' => '0','1' => '1', '2' => '2', '3' => '3', '4' => '4', '5' => '5');
                                    echo $form->select("WidgetStyle.image_padding", $padding_options, null, array("escape" => false, "id"=>"widget_image_padding"), false);
                                ?>
                                <span>px</span>
                                </div>
                        </div>
                        <div class="clear"></div>

                        <div class="name" title="">&nbsp;</div>
                        <div class="control title fleft">
                            Custom Layout
                        </div>
                        <div class="control fleft">
                                <span>Columns</span>
                                <?php
                                echo $form->text('Widget.columns', array('size' => "3", 'id' => 'widget_columns', 'class' => 'custominput'));
                                ?>
                                <span>Rows</span>
                                <?php
                                echo $form->text('Widget.rows', array('size' => "3", 'id' => 'widget_rows', 'class' => 'custominput'));
                                ?>
                        </div>
                        <div class="clear"></div>

                        <div class="name" title="">&nbsp;</div>
                        <div class="control title fleft">
                            Custom CSS
                        </div>
                        <div class="control fleft">
                                <?php
                                echo $form->textarea('WidgetStyle.customcss', array('id' => 'widget_custom_css','class' => 'customcss'));
                                ?>
                        </div>
                        <div class="clear"></div>
                    </div>

                </div><!-- step 2 -->

                <div id="step3" class="step">
                    <div id="white_arrow"></div>
                    <div class="step_row grid_12" >
                    	<div class="columnr">
                            <div class="name">
                                Widget Code
                            </div>
                            <span id="widget_code_instructions">Click on the button to save your changes and get the widget code.</span>
                        </div>
                        <div class="control">
                        	<div id="preloader">Finding best links for your widget. Could take a few minutes. </div>
                        	<a id="get_code_button" href="#"></a>
                                <a id="goto_dashboard_button" href="#"></a>
                        	<textarea class="jqtransformdone" id="widget_code" name="widget_code" readonly onclick="this.focus();this.select()"></textarea>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>  <!-- step 3 -->

                <div id="widget_preview">
                    <div id="widget_size">
                    </div>
                    <div id="your_widget" >                        
                    </div>
                    <div id="cilinkdiv" >
                    </div>
                </div><!-- widget_preview -->
                <div class="clear"></div>

        </div><!-- step container -->
    </div> <!-- wrapper -->

</div>

</div> <!-- end grid_12 -->
</div>  <!-- end content area -->
</div> <!-- end content column -->
</div> <!-- end content row -->
<?php
	if (isset($this->data['WidgetStyle']['id'])) {
            echo $form->hidden("WidgetStyle.id", array("id" => "widgetstyle_id"));
	}

	if (isset($this->data['Widget']['id'])) {
            echo $form->hidden("Widget.id", array("id" => "widget_id") );
	}

        if ( isset($website['Website']['account_id']) ) {
            echo '<input type="hidden" name="website_account_id" id="website_account_id" value="'. $website['Website']['account_id'] .'">';
        }
        
        echo $form->hidden("WidgetStyle.font_style", array('size' => "2", 'id' => 'font_style'));
?>
</form>
</body></html>