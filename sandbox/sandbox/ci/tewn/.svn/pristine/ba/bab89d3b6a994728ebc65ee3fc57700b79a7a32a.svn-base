jQuery(function () {

    function format(n, sep) {
        n = parseFloat(n);
        sep = sep || "."; // Default to period as decimal separator
        return n.toLocaleString().split(sep)[0];;
    }

    Handlebars.registerHelper('date', function (date) {
        return moment(date).format('MMM Do YY');
    });

    Handlebars.registerHelper('number', function (number) {
        return format(number);
    });

    var TplError = Handlebars.compile($('#error-tpl').html());
    var TplCategories = Handlebars.compile($('#categories-tpl').html());
    var TplCategoriesByDay = Handlebars.compile($('#categories-byday-tpl').html());

    $.tablesorter.addParser({
        id: 'thousands',
        is: function (s) {
            return false;
        },
        format: function (s) {
            return s.replace(/,/g, '');
        },
        type: 'numeric'
    });

    // here all the custom javascript
    $('.multiselect').multiselect({
        nonSelectedText: 'All selected'
    });

    jQuery('#start_daterangepicker').val( Date.parse('today-7').toString("M/d/yyyy") );
    jQuery('#end_daterangepicker').val( Date.parse('today').toString("M/d/yyyy") );

    jQuery('#start_daterangepicker, #end_daterangepicker').daterangepicker( {
        datepickerOptions: { minDate: Date.parse('-3months'), maxDate: Date.parse('today') }
    });

    $('form').on('submit', function () {
        var categories = $('select[name=categories]').val();
        var params = {
            categories: categories ? categories.join(',') : '',
            start: moment($('#start_daterangepicker').val()).format('YYYY-MM-DD'),
            end: moment($('#end_daterangepicker').val()).format('YYYY-MM-DD'),
            day_by_day: $('input[name=day_by_day]').is(':checked') ? 'detailed' : ''
        };

        $('#analytic-results').html('<div class="text-center"><img src="/img/wait.gif"></div>');
        $.post('/analysis/action/get_traffic_categories', params, function (data) {
            console.log(data);
            if (data.status == 'ok') {
                $('#analytic-results').html(data.by_day ? TplCategoriesByDay(data) : TplCategories(data));
                if (data.by_day) {
                    $('#analytic-results table').tablesorter({
                        headers: {
                            0: {sorter: false},
                            2: {sorter: 'thousands'},
                            3: {sorter: 'thousands'},
                            4: {sorter: 'thousands'},
                            5: {sorter: 'thousands'},
                        }
                    });
                } else {
                    $('#analytic-results table').tablesorter({
                        headers: {
                            1: {sorter: 'thousands'},
                            2: {sorter: 'thousands'},
                            3: {sorter: 'thousands'},
                            4: {sorter: 'thousands'},
                            5: {sorter: 'thousands'},
                            6: {sorter: 'thousands'},
                        }
                    });
                }
            } else {
                $('#analytic-results').html(TplError('There were not results'));
            }
        }, 'json');
        return false;
    });

    $('#export_pdf').on('click', function () {
        var categories = $('select[name=categories]').val();
        var params = {
            categories: categories ? categories.join(',') : '',
            start: moment($('#start_daterangepicker').val()).format('YYYY-MM-DD'),
            end: moment($('#end_daterangepicker').val()).format('YYYY-MM-DD'),
            day_by_day: $('input[name=day_by_day]').is(':checked') ? 'detailed' : ''
        };
        var href = $(this).attr('href');
        $(this).attr('href', href + '?' + $.param(params));
    });
});