<?
$infinite_scroll = 0;
$infinite_scroll_active = 0;
if (!isset($style)) {
    $style = '';
}
switch ($style) {
    default:
    case "list":
        // List
        echo $this->element("layouts/template2");
        echo $this->element("layouts/".DOMAIN."/template2");

        $all_pages[0] = $featured_pages;
        $all_pages[1] = $pages;

        $group_grid[0] = "grid_3";
        $group_grid[1] = "grid_5";

        $group_image_width[0] = 300;
        $group_image_height[0] = 170;
        $group_image_width[1] = 140;
        $group_image_height[1] = 80;
        break;
    case "grid":
        // Grid
        echo $this->element("layouts/template1");
        echo $this->element("layouts/".DOMAIN."/template1");

        $merged_pages = array_merge($pages);
        $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 190;
        $group_image_height[0] = 108;

        break;
    case "grid_full_ad_top":
    case "grid_full_small_header":
    case "grid_full":
        // Grid Full
        if ($page_number == 1) {
            echo $this->element("layouts/".$style);
            echo $this->element("layouts/".DOMAIN."/".$style);
        }

        $merged_pages = array_merge($pages);
        $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 300;
        $group_image_height[0] = 250;

        if (DOMAIN == "crowdignite" || DOMAIN == "craveonline" || DOMAIN == "gamerevolution" || DOMAIN == "totallyhers" || DOMAIN == "totallyhers" || DOMAIN == "sk_migration" || DOMAIN == "sheknows" || DOMAIN == "momtastic" || DOMAIN == "thefashionspot" || DOMAIN == "news" || DOMAIN == "es" ) { // infinite scroll
            $infinite_scroll = 1;
            $infinite_scroll_group_count = "links_content>.grid_5";
            $infinite_scroll_grid = ".grid_5";
        }

        break;
    case "small_grid":
        // small_grid
        echo $this->element("layouts/small_grid");
        echo $this->element("layouts/".DOMAIN."/small_grid");

                $merged_pages = array_merge($pages);
                $all_pages[0] = $featured_pages;
                $all_pages[1] = $merged_pages;

        $group_grid[0] = "grid_7";
        $group_grid[1] = "grid_5";

        $group_image_width[0] = 300;
        $group_image_height[0] = 250;
        $group_image_width[1] = 210;
        $group_image_height[1] = 105;

        break;
    case "masonry":
        // masonry
        echo $this->element("layouts/masonry");
        echo $this->element("layouts/".DOMAIN."/masonry");

                $merged_pages = array_merge($pages);
                $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 300;
        $group_image_height[0] = 250;
        break;
    case "masonry2":
        // masonry
        echo $this->element("layouts/masonry2");
        echo $this->element("layouts/".DOMAIN."/masonry2");

                $merged_pages = array_merge($pages);
                $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 420;
        $group_image_height[0] = 340;
        break;
    case "gridwall":
        // gridwall
        echo $this->element("layouts/gridwall");
        echo $this->element("layouts/".DOMAIN."/gridwall");

                $merged_pages = array_merge($pages);
                $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 360;
        $group_image_height[0] = 310;
        break;
    case "pinterest":
        // pinterest
        echo $this->element("layouts/pinterest");
        echo $this->element("layouts/".DOMAIN."/pinterest");

        $merged_pages = array_merge($pages);
        $all_pages[0] = $merged_pages;

        $group_grid[0] = "grid_5";

        $group_image_width[0] = 300;
        $group_image_height[0] = 250;

        if ( DOMAIN == "crowdignite" || DOMAIN == "craveonline" ) { // infinite scroll
            $infinite_scroll = 1;
            $infinite_scroll_group_count = "links_content>.grid_5";
            $infinite_scroll_grid = ".grid_5";
        }
        break;
}

$link_append = "";
?>

<?
if ($infinite_scroll && $infinite_scroll_active == 0 && $page_number == 1) {
?>

<script src="http://<?=CDN_URL?>/js/jquery.infinitescroll.2.0b2.modified.js"></script>
<script type="text/javascript">
jQuery(document).ready(function(){
    jQuery('#<?=$infinite_scroll_group_count?>').infinitescroll({
        <?php if (!empty($widget_analytic_id)) : ?>
        params: {widget_analytic_id: <?php echo $widget_analytic_id; ?>},
        <?php endif; ?>
        navSelector  : "#paginate",
        // selector for the paged navigation (it will be hidden)
        nextSelector : "#paginate a",
        // selector for the NEXT link (to page 2)
        itemSelector : "<?=$infinite_scroll_grid?> .item",
        // selector for all items you'll retrieve
        loadingText: 'Loading the next page',
        speed: 'fast',
        bufferPx: 50,
        donetext: '<br>Want more?  <a style="color:#fff" href="/">Click here</a>',
        debug: false,
        animate: false,
        //loadingImg: 'http://<?=CDN_URL?>/img/ajax-loader2.gif'
        loadingImg: '/img/ajax-loader2.gif'

    <? if($style == "pinterest") { // append new items in pinterest style ?>
    },function(arrayOfNewElems){
        var $newElems = $( arrayOfNewElems ).css({ opacity: 0 });
        $newElems.imagesLoaded(function(){
          $newElems.animate({ opacity: 1 });
          jQuery('#links_content').masonry( 'appended', $newElems, true );
        });
    <?php } else {?>
    },function(arrayOfNewElems){
        var lenght = arrayOfNewElems.length;
        var limit  = <?php echo DEFAULT_HOMEPAGE_LINKS; ?>;
        if (lenght != limit ) {
            $(window).unbind('.infscr');
        }
    <?php }?>
    });
});

</script>
<? } ?>

<div class="main">
<div id="page_body" class="container_12">
    <div class="grid_12 top_content_spacer"></div>

    <div id="content" class="grid_12">
    <div id="interior_content">
    <div id="links_content" class="grid_12">

<?
    $count = 0;
    $group_count = 0;
    $image_assets = new \CI\Asset\Image();

    foreach ($all_pages as $group_pages) {

        $grid = $group_grid[$group_count];
        $image_width = $group_image_width[$group_count];
        $image_height = $group_image_height[$group_count];
        $group_count++;

        echo "<div class='".$grid."'>";

            foreach ($group_pages as $page) {
                $link = $page['Page']['ctr_link'];

                $image_html = $image_assets->getUrl(
                    array(
                        'page_id' => $page['Page']['id'],
                        'type' => \CI\Asset\Image::URL_CROP_FULL,
                        'image' => $page['Page']['image'],
                        'width' => $image_width,
                        'height' => $image_height,
                        'extra_dirs' => array(
                            DOMAIN_ID,
                        ),
                        'extra_parameters' => array(
                            't' => strtotime($page['Page']['moderator_modified']),
                        )
                    )
                );

                $page_tracker = $convert->outbound_tracker($link);

                if ($count++ % 2) {
                    $alt = "";
                } else {
                    $alt = "alt";
                }
                if (isset($page['Page']['description'])) {
                    $page_description = $page['Page']['description'];
                } else {
                    $page_description = "";
                }
                echo $this->element("item", array("grid" => $grid,
                                                  "alt" => $alt,
                                                  "link" => $link,
                                                  "image_html" => $image_html,
                                                  "page_tracker" => $page_tracker,
                                                  "title" => htmlentities($page['Page']['title']),
                                                  "description" => $page_description,
                                                  "style" => $style));
            }
        echo "</div>";
    }

    echo "</div> <!-- /links_content -->";
    echo "</div> <!--  /interior_content -->";
?>
        <div class="bottom_content_spacer grid_12">
            <div id="paginate">
<?
                        if (DOMAIN != 'globetrotting') {
                            echo $this->element('paginate');
                        } else {
                            echo $this->element(DOMAIN . '/paginate');
                        }
?>
            </div>
        </div>

</div> <!--  /page_body -->

</div> <!--  /main -->

