$(document).ready(function() {
    var tpl_row_collector = Handlebars.compile($('#tpl-row-collector').html());

    function switchChange(event, state) {
        var $checkbox = $(this);
        $.post('/developers/action/switch_collector', {id: $checkbox.data('id'), state: state}, function (response) {
            $('#collectors_param').val(response.data.collectors_param);
            updateActivationList();
        }, 'json');
    }

    function updateActivationList() {
        $('#activate-list .do-activate').each(function () {
            var $link = $(this);
            $link.attr('href', $link.data('href') + $('#collectors_param').val());
        });
    }

    $('.do-add-collector').on('click', function (event) {
        var name = $('#name-collector').val();
        $.post('/developers/action/add_collector', {name: name}, function (response) {
            $('#name-collector').val('');
            $('#collectors-list').append(tpl_row_collector(response.data.collector));
            $('#collectors-list input.switch').last().bootstrapSwitch();
            $('#collectors-list input.switch').last().on('switchChange.bootstrapSwitch', switchChange)
            $('#modal-add-collector').modal('hide');
        }, 'json');
    });

    $('input.switch').on('switchChange.bootstrapSwitch', switchChange);

    // ------------- Delete this after migrate the saved reports
    $('#migrate-saved-reports').on('click', function(){
        $btn = $(this);
        $btn.find('i').removeClass('fa fa-warning').addClass('fa fa-spinner fa-pulse');

        $.get(
            '/reports/action/migrate',
            function(response) {
                if (response.status == "ok") {
                    $btn.attr('disabled', 'disabled');
                } else {
                    console.error(response);
                }

                $btn.find('i').removeClass('fa fa-spinner fa-pulse').addClass('fa fa-warning');
            }
        );
    });
    // ------------- Delete this after migrate the saved reports

    updateActivationList();
});