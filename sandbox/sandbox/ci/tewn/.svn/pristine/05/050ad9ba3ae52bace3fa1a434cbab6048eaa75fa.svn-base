<?php
class Analytic extends AppModel {

	var $name = 'Analytic';
	var $validate = array(
			      'domain_bitfield' => array("rule" => 'numeric',
							 "message" => "The Hub for this Landing Page must be selected"),
			      'category' => array('numeric')
			      );

	function update_count($id) {
		$query = "UPDATE analytics SET num_display = num_display + 1 WHERE id = '".$id."'";

		return $this->query($query);
	}

	function update_ctr($id) {
		$query = "UPDATE analytics SET num_ctr = num_ctr + 1 WHERE id = '".$id."'";

		return $this->query($query);
	}

	function get_ctr_rank($category, $domain_bit) {
		$query = "SELECT * FROM analytics AS Analytic WHERE category = ".$category." AND domain_bitfield & ".$domain_bit." AND visible = 1 ORDER BY (num_ctr / num_display) DESC";

		return $this->query($query);
	}

	function pause($id) {
		$this->id = $id;
		$this->saveField("visible", false);
	}

	function resume($id) {
		$analytic = $this->findById($id);

		$this->id = $id;
		$this->saveField("visible", true);

		// Need to reset everyone from the beginning to make sure we compare apples with apples
		$query = "UPDATE analytics SET num_ctr = 1, num_display = 1, weight = 100 WHERE category = ".$analytic['Analytic']['category']." AND domain_bitfield = ".$analytic['Analytic']['domain_bitfield']." AND visible = 1";
		
		return $this->query($query);
	}

}
?>