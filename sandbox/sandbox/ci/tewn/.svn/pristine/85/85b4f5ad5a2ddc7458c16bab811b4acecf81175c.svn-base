<?php
class WidgetRebalance extends AppModel {

	var $name = 'WidgetRebalance';

	function impressions($website_id) {
		$conditions = array(
			"website_id" => $website_id,
			"visible" => true
			);

		$rc = $this->find("first", array("conditions" => $conditions));

		if (empty($rc)) {
			$this->initialize($website_id);
			return 0;
		}

		return $rc['WidgetRebalance']['num_display'];
	}

	function initialize($website_id) {
		$this->create();

		$data['WidgetRebalance'] = array(
			"website_id" => $website_id,
			"num_display" => 0,
			"visible" => true
			);

		$this->save($data);
	}

	function reset($website_id) {
		$query = "UPDATE widget_rebalances SET num_display = 0, modified = NOW() WHERE website_id = ".$website_id;

		$this->query($query);
	}

	function increment($website_id, $count) {
		$website_id = intval($website_id);
		$count = intval($count);

		$conditions = "website_id = '".$website_id."'";
		$conditions .= " AND visible = 1";

		$query = "UPDATE widget_rebalances SET num_display = num_display + ".$count." WHERE ".$conditions;

		return $this->query($query);
	}

	function max_count() {
		$conditions = array("visible" => 1);

		$wr = $this->find("all", array("conditions" => $conditions,
			"limit" => 1,
			"order" => "num_display DESC"
			));

		return $wr[0]['WidgetRebalance']['num_display'];
	}
}
?>
