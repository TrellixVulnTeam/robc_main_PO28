/* backend2 - page_search.js */
var collapsed = false;
var page_letter_count = 0;
var website_letter_count = 0;

jQuery(document).ready(function() {

	// Search panes
	jQuery('ul.hub_list li a').click(function() {
		jQuery('ul.hub_list li').removeClass('tab_selected');
		jQuery(this).parent().addClass('tab_selected');
		var tab = $(this).attr('id');
		if(tab == "page_search_tab") {
			jQuery('.websites_column').hide();
			jQuery('.page_search_pane').show();
		} else {
			jQuery('.websites_column').hide();
			jQuery('.website_search_pane').show();			
		}
	});

	// Line collapse
	jQuery("body").delegate("a.collapse_line", "click", function() {
		jQuery(this).parent().parent().toggleClass("collapsed");
		return false;
	});

	// Collapse-expand button
	jQuery("body").delegate("a#collapse_all", "click", function() {
		if(collapsed) {
			jQuery('table#page_search tbody tr').removeClass('collapsed');	
			jQuery(this).html('Collapse Results');
			collapsed = false;
		} else {
			jQuery('table#page_search tbody tr').addClass('collapsed');	
			jQuery(this).html('Expand Results');
			collapsed = true;
		}
	});

    $("#searchWebsite").bind("change", function(){
        if ($(this).val() == "name"){

            $("#webPageQuery").bind("keyup", function(){
                if (!check_length_ws()) {
                    return false;
                }

                searchWebsite();
                return false;
            });
        } else {
            $("#webPageQuery").unbind("keyup");
        }
    });

    $("#searchPage").bind("change", function(){
        if ($(this).val() == "name"){
            $("#query").bind("keyup", function(){
                if (!check_page_query()) {
                    return false;
                }

                searchPages();
                return false;
            });
        } else {
            $("#query").unbind("keyup");
        }
    });
});

function searchWebsite()
{
    jQuery('#webPageQuery').parents('form').ajaxSubmit({
        beforeSend: function (request) {
            request.setRequestHeader('X-Update', 'auto_complete_websites');
            jQuery('#auto_complete_websites').hide();
            jQuery('#auto_complete_loading_websites').show();
        },
        complete: function (request, textStatus) {
            jQuery('#auto_complete_loading_websites').hide();
            jQuery('#auto_complete_websites').show();
        },
        success: function (data, textStatus) {
            jQuery('#auto_complete_websites').html(data);
        },
        async: true,
        type: 'post',
        url: '/websites/search'
    });
}

function searchPages(){
    jQuery('#query').parents('form').ajaxSubmit({
        beforeSend: function (request) {
            request.setRequestHeader('X-Update', 'auto_complete');
            jQuery('#auto_complete').hide();
            jQuery('#auto_complete_loading').show();
        },
        complete: function (request, textStatus) {
            jQuery('#auto_complete_loading').hide();
            jQuery('#auto_complete').show();
            jQuery('.tablesorter').tablesorter();
        },
        success: function (data, textStatus) {
            jQuery('#auto_complete').html(data);
        },
        async: true,
        type: 'post',
        url: '/pages/search'
    });
}

function check_page_query() {
	var str = jQuery("#query").val();
	clearTimeout( jQuery("#query").data('timer') );

	if( str.length > 3 ){
		if( page_letter_count >= 1 ) {			
			page_letter_count = 0;
			return true;
		} else {			
			//jQuery("#query").data('timer', setTimeout( check_page_query, 500) );	
		} 	
	}
	page_letter_count+=1;
	return false;
}

function check_length_ws() {
	var str = jQuery("#webPageQuery").val();
	if (str.length > 3 && website_letter_count >= 3) {
		website_letter_count = 0;
		return true;
	}
	website_letter_count+=1;
	return false;	
}