<?php echo $this->element('crowdignite/backend2_toolbar', array("tab" => $tab, "user" => $user)); ?>

<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<style>
    .table tbody>tr>td.vert-align {vertical-align: middle;}
    .main-container {padding-top: 15px;}
    .btn-default {color: #333 !important;}
    .content-column {background: #fff;}
    .main-container a,
    .main-container a:active,
    .main-container a:visited {color: #428bca;}
</style>

<div class="row supercontainer">
    <div class="side-column">
        <span class="title icon icon-link">Analysis By</span>
        <ul class="list">
            <li><a href="/analysis/websites">Websites</a></li>
            <li><a href="/analysis/hubs">Hubs</a></li>
            <li><a href="/analysis/widgets">Widgets</a></li>
            <li class="active"><a href="/analysis/lpwebsites">Website distribution</a></li>
            <li><a href="/analysis/lpcoverage">Hubs distribution</a></li>
            <li><a href="/analysis/tpcategory">Traffic categories</a></li>
        </ul> <!-- list -->
    </div> <!-- side-column -->
    <div class="content-column">
        <div class="options-bar">
            <form>
                <div class="controls controls-chosen">
                    <label for="">Choose an Active Website</label>
                    <select id="website_select" class="chosen-select" data-placeholder="Choose a website...">
                    <?php foreach ($website_list as $domain => $websites_options): ?>
                        <optgroup label="<?php echo $domain ?>">
                        <?php foreach ($websites_options as $id => $name): ?>
                            <option value="<?php echo $id; ?>" <?php echo $id == $website_id ? 'selected="selected"' : '' ?>><?php echo $name; ?></option>
                        <?php endforeach ?>
                        </optgroup>
                    <?php endforeach ?>
                    </select>
                </div>
                <a href="javascript:;" id="analyse-website" class="btn btn-sm">Start Analysis</a>
            </form>
        </div> <!-- options-bar -->
        <div class="container-fluid main-container">
        <?php if (isset($website)): ?>
            <div class="row">
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Website</h3>
                        </div>
                        <div class="panel-body">
                            <dl class="dl-horizontal">
                                <dt>ID</dt>
                                <dd><a title="Moderate website" target="_blank" href="/websites/moderate/<?php echo $website['id'] ?>"><?php echo $website['id'] ?></a></dd>
                                <dt>Name</dt>
                                <dd><?php echo $website['name'] ?></dd>
                                <dt>Primary Domain</dt>
                                <dd><?php echo $domains->get($website['domain_primary']) ?></dd>
                                <dt>Category</dt>
                                <dd><?php echo $convert->category($website['category']) ?></dd>
                                <dt>Content Rating</dt>
                                <dd><?php echo $convert->content_rating($website['content_rating']) ?></dd>
                                <dt>Active Pages</dt>
                                <dd><a title="View active pages list" target="_blank" href="/management/pages/<?php echo $website['id'] ?>"><?php echo $website['active_pages'] ?></a></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Account</h3>
                        </div>
                        <div class="panel-body">
                            <dl class="dl-horizontal">
                                <dt>ID</dt>
                                <dd><?php echo $account['id'] ?></dd>
                                <dt>Credits</dt>
                                <dd><?php echo $account['credits'] ?></dd>
                                <dt>Traffic from</dt>
                                <dd><?php echo $account['incoming'] ?></dd>
                                <dt>Traffic to</dt>
                                <dd><?php echo $account['outgoing'] ?></dd>
                                <dt>Return Rate</dt>
                                <dd><?php echo $account['return_rate'] ?></dd>
                                <dt>Featured</dt>
                                <dd><?php echo empty($account['featured']) ? 0 : $account['featured'] ?></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Cross Domain</h3>
                        </div>
                        <div class="panel-body">
                            <ul>
                                <?php foreach ($website_domains as $domain): ?>
                                    <li><?php echo $domains->get($domain, "Unknown ($domain)") ?></li>
                                <?php endforeach ?>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <?php if (intval($website['active_pages']) > 0): ?>
            <div class="row">
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Active Categories</h3>
                        </div>
                        <div class="panel-body">
                            <div id="chart_category_pages" style="height: 180px"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Active Content Ratings</h3>
                        </div>
                        <div class="panel-body">
                            <div id="chart_content_pages" style="height: 180px"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h2>Landing Page</h2>
                    <form class="form-inline" role="form">
                        <div class="form-group">
                            <label class="sr-only" for="intersect">Intersection: </label>
                            <select class="form-control" id="intersect" name="intersect">
                                <?php foreach ($website_domains as $domain): ?>
                                    <?php if (!empty($valid_landing_pages[$domain])): ?>
                                    <?php foreach ($valid_landing_pages[$domain] as $category => $contents): ?>
                                        <?php foreach ($contents as $content_rating => $lp_website): ?>
                                            <?php
                                                $value = "{$domain}_{$category}_{$content_rating}";
                                                $checked = "{$website['domain_primary']}_{$website['category']}_{$website['content_rating']}" == $value ? 'selected' : '';
                                                $value .= "_{$website['id']}";
                                            ?>
                                            <option value="<?php echo $value ?>" <?php echo $checked ?>>
                                                <?php echo $domains->get($domain, "Unknown ID {$domain}").' - '.$convert->category($category).' - '.$convert->content_rating($content_rating) ?>
                                            </option>
                                        <?php endforeach ?>
                                    <?php endforeach ?>
                                    <?php endif ?>
                                <?php endforeach ?>
                            </select>
                        </div>
                        <div class="form-group">
                        <button type="submit" title="Locate all active pages from this website on the selected landing page intersection." class="btn btn-primary">Get Intersection Data</button>
                      </div>
                    </form>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" id="intersect-data"></div>
            </div>
            <?php endif ?>
        <?php endif ?>
        </div> <!-- container -->
    </div> <!-- content-column -->
</div>  <!-- row supercontainer -->

<script type="text/x-handlebars-template" id="tpl-intersect-data">
<div class="page-header">
    <div class="pull-right">
        <button class="btn btn-danger" id="btn-rebalance" data-domain="{{domain.id}}" data-category="{{category.id}}" data-content="{{content_rating.id}}">Rebalance landing page</button>
        <a class="btn btn-primary" target="_blank" href="{{link}}">Link to landing page</a>
    </div>
    <h1>{{domain.name}} <small>{{category.name}} - {{content_rating.name}}</small></h1>
</div>
<table class="table table-condensed table-hover">
    <thead>
        <tr>
            <th>#</th>
            <th>Page ID</th>
            <th>Slot</th>
            <th>Shown on <span class="label label-info tool" title="Green: Page 1, Yellow: Page 2 - 5, Red: Page 6 and after.">?</span></th>
            <th>Weights <span class="label label-info tool" title="W: database weight, R: randomized weight">?</span></th>
            <th>Type</th>
            <th>Ctr</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each pages}}
            <tr class="page_{{id}}">
                <td>{{plusOne @index}}</td>
                <td><a target="_blank" href="/pages/moderate/{{../website_id}}/{{id}}">{{id}}</a></td>
                <td>{{slot}}</td>
                <td class="vert-align"><span class="label label-{{labelClass page}}">Page {{page}}</span></td>
                <td>W: {{weight.original}}, R: {{weight.adjusted}}</td>
                <td>{{type}}</td>
                <td><span title="Clicks: {{clicks}}, Impressions: {{impressions}}" class="tool">{{ctr}}</span></td>
                <td>{{#if previous}}<button class="btn btn-xs btn-default detail-btn tool" title="Show analytics from other websites between the previous and the current slot" data-websites="{{previous}}">Previous Analytics</button></td>{{/if}}
            </tr>
        {{/each}}
    </tbody>
</table>
</script>

<div class="modal fade" id="modal-details" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Previous Analytics</h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    Click on <strong>ID</strong> to moderate the website, on <strong>Name</strong> to analyze the website.
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th class="text-center">ID</th>
                            <th class="text-center">Website</th>
                            <th class="text-center">Domain</th>
                            <th class="text-center">Featured</th>
                            <th class="text-center">Credits</th>
                            <th class="text-center">Analytics</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" id="modal-rebalance">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Rebalancing <small>please wait...</small></h4>
            </div>
            <div class="modal-body text-center">
                <img src="http://img4.wikia.nocookie.net/__cb20111211195802/elderscrolls/images/f/f3/AjaxLoading.gif">
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<?php if (isset($highlight_page)): ?>
<input type="hidden" value=".page_<?php echo $highlight_page ?>" id="highlight_page">
<?php endif; ?>

<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<!-- Flot -->
<script src="http://www.flotcharts.org/flot/jquery.flot.js"></script>
<!-- Flot pie -->
<script src="http://www.flotcharts.org/flot/jquery.flot.pie.js"></script>
<!-- Handlebars -->
<script src="/js/handlebars-v1.3.0.js"></script>
<script>
    $ = $.noConflict(true);
    Handlebars.registerHelper('plusOne', function (index) {
        return index + 1;
    });
    Handlebars.registerHelper('labelClass', function (page) {
        var label = 'danger';
        if (page <= 5) label = 'warning';
        if (page <= 1) label = 'success';
        return label;
    });

    $('#analyse-website').on('click', function () {
        var website = $('#website_select').val();
        $(this).attr('href', '/analysis/lpwebsites/' + website);
    });

    var TplIntersectData = Handlebars.compile($('#tpl-intersect-data').html());

    function getData() {
        var intersect = $('#intersect').val();
        var keys = intersect.split('_');
        $('#intersect-data').addClass('text-center').html(
            '<p class="text-info" style="margin-top: 20px;">Please wait, processing information could take several minutes...</p>' +
            '<img src="http://img4.wikia.nocookie.net/__cb20111211195802/elderscrolls/images/f/f3/AjaxLoading.gif">'
        );
        $('form button').prop('disabled', true);
        $.get('/analysis/action/get_intersection_data', {
            domain: keys[0],
            category: keys[1],
            content_rating: keys[2],
            website_id: keys[3]
        }, function (data) {
            $('#intersect-data').removeClass('text-center').html(TplIntersectData(data));
            $('form button').prop('disabled', false);
            $('.detail-btn').on('click', function () {
                var websites = $(this).data('websites').split('::');
                var tbody = $('#modal-details tbody').html('');
                $.each(websites, function(index, website) {
                    var fields = website.split('|');
                    keys[3] = fields[5];
                    intersect = keys.join('_');
                    var bg = parseFloat(fields[2]) > 0 ? 'warning' : '';
                    tbody.append($('<tr class="'+ bg +'">' +
                        '<td align="right"><a target="_blank" href="/websites/moderate/'+ fields[5] +'">'+ fields[5] +'</a></td>' +
                        '<td><a target="_blank" href="/analysis/lpwebsites/'+ fields[5] +'?intersect='+ intersect +'">'+ fields[0] +'</a></td>' +
                        '<td class="text-center">'+ fields[1] +'</td>' +
                        '<td class="text-center"><span title="'+ fields[2] +'" class="other_tool">'+ (parseFloat(fields[2]) > 0 ? 'Yes' : 'No') +'</span></td>' +
                        '<td align="right">'+ fields[3] +'</td>' +
                        '<td class="text-center"><span class="badge">'+ fields[4] +'</span></td>' +
                    '</tr>'));
                });
                $('#modal-details').modal();
                $('.other_tool').tooltip();
            });
            var highlight_page = $('#highlight_page').val();
            if (highlight_page) {
                var page = $(highlight_page).addClass('warning');
                var offset = page.offset().top - page.height();
                setTimeout(function () {
                    jQuery('html,body').animate({scrollTop: offset}, 1200);
                }, 200);
            }
            $('.tool').tooltip();
        }, 'json');
        return false;
    }

    $('#intersect-data').on('click', '#btn-rebalance', function () {
        $('#modal-rebalance').modal({
            backdrop: 'static',
            keyboard: false
        });
        var domain   = $(this).data('domain');
        var category = $(this).data('category');
        var content  = $(this).data('content');
        $.ajax('/analysis/action/rebalance', {
            type: 'POST',
            data: {domain: domain, category: category, content: content},
            complete: function () {
                $('#modal-rebalance').modal('hide');
            }
        });
    });

    $('form').on('submit', getData);
    $('dl a[title], form button').tooltip();

    <?php if (isset($intersect)): ?>
    $('#intersect').val('<?php echo $intersect ?>');
    getData();
    <?php endif; ?>

    <?php if (isset($active)): ?>
    function labelFormatter(label, series) {
        return "<div style='font-size:8pt; font-weight:bold; text-align:center; padding:2px; color:#333;'>" + Math.round(series.percent) + "%</div>";
    }

    var categories = <?php echo json_encode($active['categories']) ?>;
    var content_ratings = <?php echo json_encode($active['content_ratings']) ?>;
    var pie_config = {
        series: {
            pie: {
                show: true,
                radius: 1,
                label: {
                    show: true,
                    radius: 3/4,
                    formatter: labelFormatter,
                    background: {
                        opacity: 0,
                        color: '#000'
                    }
                }
            }
        }
    };

    $.plot('#chart_category_pages', categories, pie_config);
    $.plot('#chart_content_pages', content_ratings, pie_config);
    <?php endif; ?>
</script>