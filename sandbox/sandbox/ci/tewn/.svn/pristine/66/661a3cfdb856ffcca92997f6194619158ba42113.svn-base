$(document).ready(function(){
    var $date = $('.bs-daterange');
    $(".selectpicker").selectpicker();
    var $imagePreview = $('#pane-add-image').ciImagePreview();

    $date.daterangepicker({
        format       : 'MM/DD/YYYY HH:mm:ss',
        buttonClasses: ['btn btn-default'],
        applyClass   : 'btn-small',
        cancelClass  : 'btn-small',
        separator    : ' to ',
        minDate      : moment(),
        opens        : 'center',
        timePicker       : true,
        timePickerIncrement : 1,
        timePicker12Hour : false
    });

    $('.bs-daterange-icon').click(function(){
        $date.click();
    });

    jQuery.validator.setDefaults({
        highlight: function (element, errorClass, validClass) {
            if (element.type === "radio") {
                this.findByName(element.name).addClass(errorClass).removeClass(validClass);
            } else {
                $(element).closest('.form-group').removeClass('has-success has-feedback').addClass('has-error has-feedback');
                $(element).closest('.form-group').find('span.glyphicon').remove();
                $(element).closest('.form-group').append(' <span class="glyphicon glyphicon-remove form-control-feedback" aria-hidden="true"></span>');
            }
        },
        unhighlight: function (element, errorClass, validClass) {
            if (element.type === "radio") {
                this.findByName(element.name).removeClass(errorClass).addClass(validClass);
            } else {
                $(element).closest('.form-group').removeClass('has-error has-feedback').addClass('has-success has-feedback');
                $(element).closest('.form-group').find('span.glyphicon').remove();
                $(element).closest('.form-group').append('<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>');
            }
        },
        submitHandler: function(validator, form) {
            var action = 'add';

            if ('form-add-custom-page' === form.target.id) {
                $("#btn-add-page").button('loading');
            } else {
                action = 'edit';
                $("#btn-edit-page").button('loading');
            }
            var $datePicker = $('.bs-daterange').data('daterangepicker');
            var data = {
                start_at : $datePicker.startDate.format('YYYY-MM-DD HH:mm:ss'),
                end_at   : $datePicker.endDate.format('YYYY-MM-DD HH:mm:ss')
            };

            if (!ci.isUndefined($imagePreview.data('_ciImagePreview').getCropper())) {
                var cropData    = $imagePreview.data('_ciImagePreview').getCropper().cropper('getData');
                data = $.extend(data, {
                    coordinates : {
                        x1 : cropData.x,
                        x2 : cropData.x + cropData.width,
                        y1 : cropData.y,
                        y2 : cropData.y + cropData.height,
                    }
                });
            }

            $.ajax({
                url      : '/custom_landing_page/action/' + action + '?' + $('#form-add-custom-page').serialize(),
                type     : 'GET',
                dataType : 'json',
                data     : data
            }).done(function(data){
                if(data.hasOwnProperty("status") && data.status == 'ok') {
                    window.location = '/management/website/' + $('#input-website-id').val();
                } else {
                    var error_list = '';
                    $.each(data.errors, function(index){
                        error_list += '<li>' + data.errors[index].msg + '</li>'
                    });

                    $('#warning-msg').alert('close');
                    var alert = '<div id="warning-msg" class="alert alert-warning alert-dismissible fade in" role="alert">' +
                                '    <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">Ã—</span><span class="sr-only">Close</span></button>' +
                                '    <div class="error-container"><ul>' + error_list + '</ul></div>' +
                                '</div>';

                    $('#form-add-custom-page').prepend(alert);
                    $("#btn-add-page, #btn-edit-page").button('reset');
                    setTimeout(function(){$('#warning-msg').alert('close');}, 3000);
                }
            });
        }
    });

    $('#form-add-custom-page').validate({
        ignore : '#txt-get-image, .selectpicker + div.dropdown-menu input',
        rules : {
            headline: {
                required : true
            },
            body_text: {
                required : true
            },
            readmore_link: {
                required : true,
                url : true
            },
            image : {
                required : true
            }
        },
        messages : {
            headline : {
                required  : 'Please enter a head line'
            },
            byline : {
                required : 'Please enter a byline'
            },
            body_text : {
                required : 'Please enter a abstract'
            },
            readmore_link : {
                required : 'Please enter a URL',
                url      : 'Invalid URL'
            },
            image : {
                required : 'Image is required'
            }
        }
    });
});

