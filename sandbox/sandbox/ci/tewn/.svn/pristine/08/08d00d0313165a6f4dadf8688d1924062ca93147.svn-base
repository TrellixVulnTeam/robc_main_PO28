<?php

namespace Test\Content\Provider;
use CI\Content\Provider\Gravity;

class GravityTest extends \PHPUnit_Framework_TestCase
{
    public function testGetItem() {
        $aOptions = array(
            'clicked_page' => array(
                'id'              => '591329575',
                'domain_bitfield' => '12',
                'url'             => 'http://whatculture.com/film/10-famous-actors-literally-thing-every-movie.php'
            )
        );

        $oMockService = $this->getMockBuilder('\CI\Http\Service\Gravity')
                             ->setMethods(array('getData', 'query'))
                             ->getMock();
        $oMockService->expects($this->once())
                     ->method('getData')
                     ->will($this->returnValue(array(
                            'payload' => array(
                                array(
                                    "title"             => "The Giants Win",
                                    "url"               => "http://www.site.com/giants-win.html",
                                    "image"             => "http://www.site.com/images/giants-win.html",
                                    "publish_timestamp" => "1367424120000",
                                    "summary"           => "The San Francisco Giants have won the 2010 World Series",
                                    "author"            => "John Doe"
                                )
                            ),
                            'status' => array(
                                "httpCode"        => 200,
                                "message"         => "OK",
                                "executionTime"   => "83 milliseconds",
                                "executionMillis" => 83
                            ),
                            'meta' => array(
                                "impressionHash"           => "2da0f560eb9d90bf05863a783f1276d4",
                                "impressionViewedCallback" => "http://rma-api.gravity.com/v0/site/c3b6ed27b540e1c1121abfe3c59edc6c/user/cc630b6453f71272c82426ab810d659d/impressionViewed?limit=20&rec_type=sponsored&ih=2da0f560eb9d90bf05863a783f1276d4&ct=1398104708005"
                            )
                        )
                    ));

        $oMockService->expects($this->once())
            ->method('query')
            ->will($this->returnValue(array()));

        $oMockProvider = $this->getMockBuilder('\CI\Content\Provider\Gravity')
                              ->setMethods(array('getService'))
                              ->getMock();

        $oMockProvider->expects($this->once())
                      ->method('getService')
                      ->will($this->returnValue($oMockService));

        $aItem = $oMockProvider->provide(array());

        $aExpected = array(
            "title"       => "The Giants Win",
            "description" => "The San Francisco Giants have won the 2010 World Series",
            "image"       => "http://www.site.com/images/giants-win.html",
            "link"        => "http://www.site.com/giants-win.html",
            "extra"       => "<iframe src='http://rma-api.gravity.com/v0/site/c3b6ed27b540e1c1121abfe3c59edc6c/user/cc630b6453f71272c82426ab810d659d/impressionViewed?limit=20&rec_type=sponsored&ih=2da0f560eb9d90bf05863a783f1276d4&ct=1398104708005' width='1' height='1' scrolling='no' frameborder='0'></iframe>"
        );

        $this->assertEquals($aExpected, $aItem);
    }

    public function testServiceInstance() {
        $oGravity = new \CI\Content\Provider\Gravity();
        $this->assertInstanceOf('\CI\Http\Service\Gravity', $oGravity->getService());
    }
}