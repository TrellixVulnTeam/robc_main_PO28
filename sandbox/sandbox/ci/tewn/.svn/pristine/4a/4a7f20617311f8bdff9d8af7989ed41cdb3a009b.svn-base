var ci = ci || {};

ci.CustomLanding = function($) {

    var _pageNumber = 1;
    var _sentRequest = true;
    var _config = {};

    (function constructor(){
        _config = $.parseJSON($("#body").attr('data-layout'));
    })();

    return {
        redrawLayout: function () {
            var $body      = $("#body");

            if ($body.find('.page_link').size() > 0) {
                var bodyOffset = $body.offset();
                var $logo      = $("#logo");
                var $login     = $("#login");

                $logo.css('left', bodyOffset.left);
                $logo.css('top', ($logo.parent().height() - $logo.height()) / 2);

                if ($login.length > 0 ) {
                    var topLogin = ($login.parent().height() - $login.height()) / 2;
                    $login.css('right', bodyOffset.left);
                    $login.css('top', topLogin);
                }

                if ($body.width() > 300) {
                    $('.article-wrapper').css({
                        margin: '0px auto',
                        width: $body.width()
                    });
                } else {
                    $('.article-wrapper').removeAttr('style');
                }
            }
        },
        loadInitPages: function () {
            var $body = $("#body");
            var url_params = [
                $('#domain_id').val(),
                $('#intersect_id').val(),
                $('#random_seed').val()
            ];

            $body.after("<div class='loading'></div>");

            $.ajax({
                url : "/custom_landing_page/action/get_pages/" + url_params.join('/') + "/page:1",
                cache : false,
                type : 'GET',
                data : {
                    article_id : $('#article_id').val()
                }
            }).done(function(data){
                    var $data = $(data);
                    var $cards = $data.find('.page_link');
                    $('#random_seed').val($data.find('#seed').val());
                    _sentRequest = true;

                    $cards.click(ci.CustomLanding.onPageClicked);
                    $(".loading").remove();
                    $body.append($cards).masonry('appended', $cards, true);

                    if ($cards.length < _config.limit) {
                        $(window).unbind('scroll');
                    }

                    ci.CustomLanding.redrawLayout();

                    $body.find(".card img").each(function(){
                        var $img = $(this);
                        $img.attr("src", $img.data("src"));
                    });

                    $body.masonry();
            });
        },
        addMorePages : function() {
            if (_sentRequest && $(document).height() - $(window).scrollTop() <= $(window).height() * 2.5) {
                _sentRequest = false;

                var $body = $("#body");
                var url_params = [
                    $('#domain_id').val(),
                    $('#intersect_id').val(),
                    $('#random_seed').val()
                ];
                $body.after("<div class='loading'></div>");
                _pageNumber++;

                $.ajax({
                    url: "/custom_landing_page/action/get_pages/" + url_params.join('/') + "/page:" + _pageNumber,
                    type: 'GET',
                    cache: false,
                    data: {
                        article_id : $('#article_id').val()
                    }
                }).done(function(data) {
                    var $cards = $(data).find('.page_link');
                        _sentRequest = true;

                        $cards.click(ci.CustomLanding.onPageClicked);
                        $(".loading").remove();
                        $body.append($cards).masonry('appended', $cards, true);

                        if ($cards.length < _config.limit) {
                            $(window).unbind('scroll');
                        }
                });
            }
        },
        onPageClicked : function(){
            var $anchor     = $(this);
            var urlOutbound = $anchor.attr("href");

            // Pretty link functionality
            if (_config.is_home_page == false) {
                var prettyLink = urlOutbound;
                urlOutbound    = $anchor.attr("data-link");

                $anchor.attr("href", urlOutbound);
                $anchor.mouseleave(function(){
                    $(this).attr("href", prettyLink).unbind("mouseleave");
                });
            }

            // Record outbound link
            try {
                var myTracker =_gat._getTracker("UA-20708699-1");
                myTracker._trackEvent('Outbound Links', urlOutbound);
            }catch(err){}
        },
        getConfigValue : function(name) {
            var confing = null;

            if (typeof name == "string" && _config.hasOwnProperty(name)) {
                confing = _config[name];
            }

            return confing;
        }
    }
}(jQuery);

ci.include = {
    js : function(url, callback, attrs) {
        var script = document.createElement("script");
        script.setAttribute("language", "javascript");
        script.setAttribute("type", "text/javascript");
        script.setAttribute("src", url);
        script.setAttribute("async", true);

        if (typeof attrs == "object") {
            for( attr in attrs ) {
                script.setAttribute(attr, attrs[attr]);
            }
        }

        if (typeof callback == 'function') {
            if (script.addEventListener) {
                script.addEventListener('load', callback);
            } else {
                script.attachEvent('onload', callback);
            }
        }

        document.body.appendChild(script);
    }
};

ci.swapLink = function (link) {
    link = link || this;
    var $link = $(link);
    $link.attr('href', $link.data('href'));
}

$(document).ready(function() {
    var $body  = $('#body');
    var $pages = $body.find('.page_link');

    $(window).scroll(ci.CustomLanding.addMorePages);
    $pages.click(ci.CustomLanding.onPageClicked);

    $body.masonry({
        itemSelector: ".card",
        columnWidth : 200,
        gutter : 10,
        isFitWidth : true
    });

    $body.masonry('on', 'layoutComplete', ci.CustomLanding.redrawLayout);

    var limit = ci.CustomLanding.getConfigValue("limit");

    if ($(document).height() <= $(window).height() && limit == $pages.length){
        ci.CustomLanding.addMorePages();
    }

    ci.CustomLanding.loadInitPages();
});

$(window).load(function(){
    // Include chartbeat
    window._sf_async_config={};
    window._sf_async_config.uid = 8555;
    window._sf_async_config.domain = "crowdignite.com";
    window._sf_endpt=(new Date()).getTime();
    ci.include.js('//static.chartbeat.com/js/chartbeat.js');

    // Include comscore
    var sComscore = (document.location.protocol == "https:" ? "https://sb" : "http://b") + ".scorecardresearch.com/beacon.js";

    ci.include.js(sComscore, function(){
        COMSCORE.beacon({
                        c1:2,
                        c2:6036161,
                        c3:"",
                        c4:"",
                        c5:"",
                        c6:"",
                        c15:""
        });
    });

    // Include fraudlogix
    var tci = "flx367";
    var flcachebuster = Math.round((new Date()).getTime() / 1000);
    var sFraud = (document.location.protocol=='https:') ? 'https://'+tci+'.lporirxe.com':'http://'+tci+'.lporirxe.com'+"/"+"flp"+"/"+"ncvp.js?"+flcachebuster;
    window._flbtn = "";

    ci.include.js(sFraud, function(){
            FLPXobj.procinit(['367','631']);
            var myto = setInterval(function(){
                clearInterval(myto);
                var status = FLPXobj.pxstatus;
            }, 500);
    }, {'charset' : 'ISO-8859-1'});
});