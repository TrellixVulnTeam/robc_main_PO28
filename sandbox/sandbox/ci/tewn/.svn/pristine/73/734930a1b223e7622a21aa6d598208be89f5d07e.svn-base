jQuery(document).ready(function() {
	websites_yesterday_data(status,hub,category);

	jQuery('.btn-navbar').click(function(){
	    var tabnav = jQuery('.tabnav');
		if( tabnav.hasClass('collapsed') ) {
			tabnav.slideUp().removeClass('collapsed');
		} else {
			tabnav.slideDown().addClass('collapsed');
		}
		return false;
	});

	jQuery(".tooltip").qtip({
		position: {
			my:'bottom center',
			at:'top center'
		},
		style: {
			classes: 'ui-tooltip-plain'
		}
	});

	jQuery("body").delegate("div.blockOverlay","click",function(){
		jQuery.unblockUI();
		return false;
	});

	/* dropdowns */
    $(".dropdown dt a").click(function() {
        $(this).parent().parent().find("dd ul").toggle();
    });

    $(".dropdown dd ul li a").click(function() {
        var text = $(this).html();
        $(this).parent().parent().find("dt a span").html(text);
       	$(this).parent().parent().find("dd ul").hide();
    });

    var dropdown1_text = $(".dropdown1 dd ul li.tab_selected a").html();
    var dropdown2_text = $(".dropdown2 dd ul li.tab_selected a").html();
	var dropdown3_text = $(".dropdown3 dd ul li.tab_selected a").html();
	$(".dropdown1 dt a span").html( dropdown1_text );
	$(".dropdown2 dt a span").html( dropdown2_text );
	$(".dropdown3 dt a span").html( dropdown3_text );

    function getSelectedValue(id) {
        return $("#" + id).find("dt a span.value").html();
    }

    $(document).bind('click', function(e) {
        var $clicked = $(e.target);
        if (! $clicked.parents().hasClass("dropdown"))
            $(".dropdown dd ul").hide();
    });

	$("#website_table thead tr").not('.stickyHeader').find('th').each(function(index){
		index++; // This is increased by one because indexes on element start on 1

		if(index > 2) { // This is because ID and Site can't be hidden //
			var th = $(this);
			var toggle = $('<li><input type="checkbox" id="toggle_col_'+index+'" class="toggle_col" value="col_'+index+'"/> <label for="toggle_col_'+index+'">'+th.text()+'</label></li>');
			$('.dropdown4 ul').append(toggle);

			toggle.find("input").bind("updateCheck", function(){
				if ( th.css("display") ==  "table-cell") {
				   $(this).attr("checked", true);
				} else {
				   $(this).attr("checked", false);
				};
			}).trigger("updateCheck");
		}
	});

	$('.dropdown4').delegate(".toggle_col", "change", function(event){
		var col_num = $(this).val();
		var input = $(this);
		if (input.is(":checked")) {
			$('.'+col_num).show();
		} else {
			$('.'+col_num).hide();
		}
	});


});

function websites_yesterday_data( status, hub, category ) {
	$.ajax({
        type: "POST",
        url: "/management/websites_yesterday_data",
        data: {
			status:status,
			hub:hub,
			category:category
        },
        success: function(data){

        	var website_data = jQuery.parseJSON(data);
        	$("#needs_attention_count font").html(website_data.statistics.needs_attention_count);
        	$("#needs_attention_notice font").html(website_data.statistics.needs_attention_notice);
        	$("#needs_attention_warning font").html(website_data.statistics.needs_attention_warning);
        	$("#needs_attention_immediate font").html(website_data.statistics.needs_attention_immediate);

        	for( i=0; i<website_data.statistics.count; i++ ) {
                website = website_data[i].Website;

                /* table rows */
                $('#rr_'+website.id+' a').html(round_decimals(website.rr * 100) + '%').show();
                $('#yin_'+website.id+' a').html(numberWithCommas(website.yincoming)).show();
                $('#yout_'+website.id+' a').html(numberWithCommas(website.youtgoing)).show();
                $('#y_lp_ctr_'+website.id).html(round_decimals((website.y_lp_ctr * 100), 2) + "%");
                $('#y_lp_imp_'+website.id+' a').html(numberWithCommas((website.y_lp_imp / 1000).toFixed(2)) + "k");

                $('#y_w_ctr_'+website.id+' a').html(round_decimals((website.y_w_ctr * 100), 2) + "%").show();
                $('#y_w_imp_'+website.id+' a').html(numberWithCommas((website.y_w_imp / 1000).toFixed(2)) + "k");

                $('#y_gen_r_r_'+website.id).html(round_decimals((website.y_gen_r_r * 100)) + "%").show();
                $('#tier_'+website.id).html(website.tier).show();
                $('#attention_level_'+website.id).html(website.attention_level);

                yrr = website.yrr;
				$('#yrr_'+website.id).html(round_decimals((yrr * 100), 2) + '%');

                var traffic_delta = (website.y_gen_r_r - yrr) * website.yincoming;
                traffic_delta = round_decimals(traffic_delta);
                $('#traffic_delta_'+website.id).html(numberWithCommas(traffic_delta));

				/* full stats lightbox */
                $("#full_stats_"+website.id+" .yincoming").html(website.yincoming);
                $("#full_stats_"+website.id+" .youtgoing").html(website.youtgoing);
                $("#full_stats_"+website.id+" .y_r_w_ctr").html((website.y_w_ctr*100).toFixed(1) + "%");
                $("#full_stats_"+website.id+" .y_r_w_imp").html((website.y_w_imp/1000).toFixed(1) + "k");
                $("#full_stats_"+website.id+" .y_r_lp_ctr").html((website.y_lp_ctr*100).toFixed(1) + "%");
                $("#full_stats_"+website.id+" .y_r_lp_imp").html((website.y_lp_imp).toFixed(1));
                $("#full_stats_"+website.id+" .aprox_lp_traffic").html((website.y_lp_imp * website.y_lp_ctr).toFixed(1));
                $("#full_stats_"+website.id+" .aprox_w_traffic").html((website.y_w_imp * website.y_w_ctr).toFixed(1));
                $("#full_stats_"+website.id+" .yrr").html(yrr);
                $("tr#website_row_"+website.id+" div.preloader").hide();

				/* Apply attention colors */
				var row_color = "";
				switch(website.attention_level) {
				case ATTENTION_LEVEL_IMMEDIATE:
					row_color = "#edc3a8"; // orange
					break;
				case ATTENTION_LEVEL_WARNING:
					row_color = "yellow"; // yellow
					break;
				case ATTENTION_LEVEL_NOTICE:
				default:
					break;
				}
				$("tr#website_row_"+website.id+" td").css("background", row_color);

				/* featured website id cell */
				//var featured_color = row_color;
				if( website_data[i].Account.featured > 0 ) {
					//featured_color = "#b4d9a6";	// green
					//$("#website_id_"+website.id).css("background", featured_color);
					$("#website_id_"+website.id).addClass('featured_row');
				}


				/* need attention colored cells */
				var needs_attention = website.needs_attention;
				var attention_color = "#CC9999"; // red

				if( needs_attention & ATTENTION_PENDING_PAGES ){ $(".pages_pending_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_PENDING_MODERATION ){ $(".pending_moderation_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_RETURN_RATE ){ $("#yrr_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_LP_PERFORMANCE){ $("#y_lp_ctr_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_ENOUGH_LANDING_PAGE_IMPRESSIONS ){ $("#y_lp_imp_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_W_PERFORMANCE ){ $("#y_w_ctr_"+website.id).css("background", attention_color); }
				if( needs_attention & ATTENTION_ENOUGH_WIDGET_IMPRESSIONS ){ $("#y_w_imp_"+website.id).css("background", attention_color); }

				if(needs_attention) {
					$("#full_stats_"+website.id+" .needs_attention").html("Yes");
				} else {
					$("#full_stats_"+website.id+" .needs_attention").html("No");
				}
        	}

			/* totals  */
			rr_total = 0;
			if(website_data.statistics.incoming > 0) {
				rr_total = website_data.statistics.outgoing / website_data.statistics.incoming;
			}
			$('#rr_total').html(round_decimals(rr_total * 100) + "%");

			$('#yin_total').html(numberWithCommas(website_data.statistics.yincoming));
			$('#yout_total').html(numberWithCommas(website_data.statistics.youtgoing));

			yrr_total = 0;
			if(website_data.statistics.yincoming > 0) {
				yrr_total = website_data.statistics.youtgoing / website_data.statistics.yincoming;
			}
			$('#yrr_total').html((yrr_total * 100 ).toFixed(2) + '%');

			y_lp_ctr_total = 0;
			if(website_data.statistics.y_lp_imp > 0) {
				y_lp_ctr_total = website_data.statistics.y_lp_clicks / website_data.statistics.y_lp_imp;
			}
			$('#y_lp_ctr_total').html(round_decimals(y_lp_ctr_total * 100, 2) + '%');

			$('#y_lp_imp_total').html(numberWithCommas((website_data.statistics.y_lp_imp / 1000).toFixed(2)) + "k");

			y_w_ctr_total = 0;
			if(website_data.statistics.y_w_imp > 0) {
				y_w_ctr_total = (website_data.statistics.y_w_clicks / website_data.statistics.y_w_imp) * 100;
			}
			$('#y_w_ctr_total').html(y_w_ctr_total.toFixed(2) + '%');

			$('#y_w_imp_total').html(numberWithCommas((website_data.statistics.y_w_imp / 1000).toFixed(2)) + "k");

            var y_gen_r_r_total = 0;
            if (website_data.statistics.yincoming > 0) {
                y_gen_r_r_total = website_data.statistics.y_w_traffic / website_data.statistics.yincoming;
            }
            $('#y_gen_r_r_total').html((y_gen_r_r_total * 100).toFixed(2) + "%");

            var traffic_delta_total = (y_gen_r_r_total - yrr_total) * website_data.statistics.yincoming;
            traffic_delta_total = round_decimals(traffic_delta_total);
            $('#traffic_delta_total').html(numberWithCommas(traffic_delta_total));

			$("#website_table").trigger("update");
        },
        complete: function(){
            jQuery.tablesorter.addParser({
                id: "commaDigit",
                is: function(s, table) {
                    var c = table.config;
                    return jQuery.tablesorter.isDigit(s.replace(/,/g, ""), c);
                },
                format: function(s) {
                    return jQuery.tablesorter.formatFloat(s.replace(/,/g, ""));
                },
                type: "numeric"
            });

            jQuery.tablesorter.addParser({
              id: "numberAndLetter",
              is: function(value, table) {
                  var config = table.config;
                  return jQuery.tablesorter.isDigit(value.replace(/k/g, ""), config);
              },
              format: function(value) {
                return jQuery.tablesorter.formatFloat(value.replace(/k/g, ""));
              },
              type: "numeric"
              });

            $("#website_table").tablesorter({
                headers: {
                    10: { sorter: false },
                    11: { sorter: false },
                    6: { sorter: 'commaDigit' },
                    8: { sorter: 'commaDigit' },
                    9: { sorter: 'commaDigit' },
                    10: { sorter: 'commaDigit' },
                    11: { sorter: 'commaDigit' },
                    12: { sorter: 'commaDigit' },
                    14: { sorter: 'commaDigit' },
                    17: { sorter: 'numberAndLetter'}
                },
                widgets: ['zebra','stickyHeaders'],
                widgetZebra: {css: ["NormRow","AltRow"]} // css classes to apply to rows
            });
        }
    });
}

function round_decimals(num, decimals) {
	if(decimals === "undefined" ) decimals=2;
	return parseFloat(num).toFixed(decimals);
}

function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function show_notes(website_id){
	$.ajax({
		type: "POST",
		url: "/websites/show_note/"+website_id,
		cache: false,
		success: function(html){
			$("#show_notes").replaceWith(html);
		}
	});

	jQuery.blockUI({message:jQuery('#show_notes'), css: {padding: '5px 8px 5px 5px', top: '100px', width:'398px', height:'150px'}, overlayCSS: { } });
}

function flag_website(website_id, user_id){
	$.ajax({
		type: "POST",
		url: "/users/flag_website/"+website_id+"/"+user_id,
		cache: false,
		success: function(html){
			alert("This Website has been flagged for you.");
		}
	});
}

function unflag_website(website_id, user_id){
	$.ajax({
		type: "POST",
		url: "/users/unflag_website/"+website_id+"/"+user_id,
		cache: false,
		success: function(html){
			alert("This Website has been unflagged for you.");
		}
	});
}

function show_full_stats(website_id) {
        jQuery.blockUI({ message:jQuery("#full_stats_"+website_id), css: { top: '10px', width:'600px', height:'auto'} });
}

function show_chart_popup (website_id, type) {
	close_str = '<div class="align_right"><a class="btn_close" href="#" onclick="jQuery.unblockUI(); return false;">Close</a></div>';
    pop_str = '<div class="inside_block_ui">'+ close_str + '<div id="chart_popup_area" style="cursor: default;"></div>';
    if(type==3) {
    	pop_str += '<div id="graph_tpm" class="chart_small"></div><div id="graph_ctr" class="chart_small"></div><div id="graph_return_rate" class="chart_small"></div><div id="graph_credits" class="chart_small"></div><div id="graph_io" class="chart_small"></div><div id="graph_display" class="chart_small"></div><br/>';
    }
    pop_str += '<br/></div>';
    jQuery.blockUI({ message:pop_str, css: { background:"transparent", border:"none", top:"20px", left:"50%", position:"fixed", width:'980px', height:'480px'}});

    waiting_str = '<div style="cursor: default; margin:10px 0;"><img src="/img/crowdignite/website_ajax_loader_2.gif"></div>';
    if(type!=3) {
    	jQuery("#chart_popup_area").block({ message:waiting_str, css: {width:'210px', height:'50px'} });
    } else {
    	jQuery("#graph_tpm, #graph_ctr, #graph_return_rate, #graph_credits, #graph_io, #graph_display").block({ message:waiting_str, css: {width:'50px', height:'50px'} });
	}

    var now = new Date();
    now.setHours(0);
    now.setMinutes(0);

	startTime = weekago;
        var endTime = Math.ceil(now.getTime()/1000);
        var website_list = "";

        switch (type) {
        case 3:
			/* Chart TPM */
			chartify('graph_tpm', startTime, endTime, '/history_stats/chart', "TPM", "Impressions", "line", website_id, 0, "tpm", false,  TIME_UNIT_DAY, function(){ jQuery("#graph_tpm").unblock(); });

			/* Chart Widget Click Through Rate */
			chartify('graph_ctr', startTime, endTime, '/history_widgets/chart', "Widget Click Through Rate", "Rate", "line", website_id, 0, "ctr", false,  TIME_UNIT_DAY, function(){ jQuery("#graph_ctr").unblock(); });

			/* Chart Return Rate */
			chartify('graph_return_rate', startTime, endTime, '/history_credits/chart', "Return Rate", "Rate", "line", website_id, 0, "return_rate", false,  TIME_UNIT_DAY, function(){ jQuery("#graph_return_rate").unblock(); });

			/* Chart Credits */
			chartify('graph_credits', startTime, endTime, '/history_credits/chart', "Credits", "Credits", "line", website_id, 0, "credits", false,  TIME_UNIT_DAY, function(){ jQuery("#graph_credits").unblock(); });

			 /* Chart I/O */
			chartify('graph_io', startTime, endTime, '/history_credits/chart', "Traffic From/To", "Traffic From/To", "line", website_id, 0, "incoming,outgoing", false, TIME_UNIT_DAY, function(){ jQuery("#graph_io").unblock(); });

			 /* Chart Widget Impressions */
			chartify('graph_display', startTime, endTime, '/history_widgets/chart', "Widget Impressions", "Impressions", "line", website_id, 0, "display", false,  TIME_UNIT_DAY,function(){ jQuery("#graph_display").unblock(); });

			break;
        case 2:
			chartify('chart_popup_area', startTime, endTime, '/history_widgets/chart', "Widget CTR & Impressions", "Rate", "doubleline", website_id, 0, "ctr,display", false, TIME_UNIT_DAY, function(){ jQuery("#chart_popup_area").unblock(); });
			break;
        case 1:
        	chartify('chart_popup_area', startTime, endTime, '/history_credits/chart', "Traffic From/To", "I/O", "lineLegend", website_id, 0, "incoming,outgoing", true, TIME_UNIT_DAY, function(){ jQuery("#chart_popup_area").unblock(); });
        	break;
		case 0:
		default:
			chartify('chart_popup_area', startTime, endTime, '/history_credits/chart', "Return Rate", "Rate", "line", website_id, 0, "return_rate", false, TIME_UNIT_DAY, function(){ jQuery("#chart_popup_area").unblock(); });
        }
}
