<?php
class PageController extends AppController
{
    var $uses       = array('User', 'MetricLog', 'Website', 'CustomLandingPage');
    var $components = array('CIBreadCrumbs', 'CIHubsSelect', 'CIDemographicSelect', 'CIContentRatingSelect', 'CICategoriesSelect', 'CIDatePicker');

    var $view  = 'Theme';
    var $theme = 'bootstrap';

    public function beforeFilter()
    {
        $this->layout = 'bootstrap';

        $this->Session->activate();
        $user = $this->Session->read('User');
        $user = $this->User->findById($user['id']);

        $this->validate_admin(ADMIN_DOMAIN);

        $this->set_types_user($user['User']);
        $this->MetricLog->log(LOG_TYPE_PAGE_VIEW);
        $this->set('user', $user);
        $this->set('full_admin',$user['User']['domain_bitfield'] == -1);
    }

    public function custom($website_id = 0, $article_id = 0)
    {
        App::import('Vendor', 'Carbon', array('file' => 'Carbon.php'));

        if ($website_id < 1 ) {
            $this->redirect('/admin/websites/report');
        }

        if ($article_id > 0) {
            $article = $this->CustomLandingPage->findById($article_id);

            if (empty($article['CustomLandingPage'])) {
                $this->redirect('/admin/websites/report');
            }

            $hub            = new \CI\Hub(new \CI\Hub\DataSource\MyArray());
            $article        = $article['CustomLandingPage'];

            $article['url'] = 'http://' . $hub->idToLandingpage($article['domain_primary']) . '/article/' . $article['id'];

            $image_asset = new \CI\Asset\Image();

            $article['image_preview'] = $image_asset->getUrl(
                array(
                    'image'   => $article['image'],
                    'page_id' => '',
                    'type'    => \CI\Asset\Image::URL_RELATIVE,
                    'extra_parameters' => array(
                        't' => \Carbon\Carbon::parse($article['updated'])->timestamp,
                    )
                )
            );

            $this->set('article', $article);
        }

        $website = $this->Website->get_by_id($website_id);

        if ($website === false) {
            $this->redirect('/admin/websites/report');
        }

        $oWebsite = new \CI\Website();
        $website['Website']['status_name'] = $oWebsite->getStatusName($website['Website']['status']);

        $this->set('tab', 'websites');
        $this->set('button_show', 'custom');
        $this->set('website_id', $website_id);
        $this->set('website', $website);

        $this->CIBreadCrumbs->setup(
            'breadcrumbs_component',
            array(
                  'crumbs' => array(
                    array(
                        'name' => 'Websites',
                        'href' => '/admin/websites/report'
                    ),
                    array(
                        'name' => $website['Website']['name'],
                        'href' => '/management/website/' . $website['Website']['id']
                    ),
                    array(
                        'name' => 'Custom Landing Page'
                    )
                 )
            )
        );

        $domain_primary  = isset($article['domain_primary']) ? $article['domain_primary'] : $website['Website']['domain_primary'];
        $demographic_sex = isset($article['sex']) ? $article['sex'] : $website['Website']['demographic_sex'];
        $content_rating  = isset($article['content_rating']) ? $article['content_rating'] : $website['Website']['content_rating'];
        $category        = isset($article['category']) ? $article['category'] : $website['Website']['category'];

        $this->CIHubsSelect->setup(
            'hubs_select_component',
            array(
                'domain_id' => $domain_primary,
                'name'      => 'domain_primary'
            )
        );

        $this->CIDemographicSelect->setup(
            'demographic_select_component',
            array(
                'demographic_id' => $demographic_sex,
                'name'           => 'sex'
            )
        );

        $this->CIContentRatingSelect->setup(
            'content_rating_select_component',
            array(
                'content_rating_id' => $content_rating,
                'name'              => 'content_rating'
            )
        );

        $this->CICategoriesSelect->setup(
            'categories_select_component',
            array(
                'category_id' => $category,
                'name'        => 'category'
            )
        );

        if (isset($article['start_at'], $article['end_at'])) {
            $start_date = \Carbon\Carbon::createFromTimestamp($article['start_at'])->format('m/d/Y H:i:s');
            $end_date   = \Carbon\Carbon::createFromTimestamp($article['end_at'])->format('m/d/Y H:i:s' );
        } else {
            $start_date = \Carbon\Carbon::now()->format('m/d/Y H:i:s');
            $end_date   = \Carbon\Carbon::now()->addDays(30)->format('m/d/Y H:i:s' );
        }

        $this->CIDatePicker->setup(
            'range_date_component',
            array(
                'start_date'  => $start_date,
                'end_date'    => $end_date,
                'placeholder' => $start_date . ' to ' . $end_date,
                'clear'       => false
            )
        );
    }
}