<?php

namespace CI\VowpalWabbit\Parser\LandingPage\Paid;
use CI\File\Exception;
use CI\VowpalWabbit\Parser\Common;

class Clicks extends Common
{
    const TIME_RANGE = 3600;

    protected $sPrefixName    = 'lppaidclick.log.';
    protected $sServerPattern = "/^app[\d].*ci.ci./";
    protected $aKeys          = array(
        'unix_timestamp',
        'user_id',
        'ip',
        'paid_link_id',
        'paid_link_campaign_id'
    );

    /**
     * Constructor of the class
     *
     * @param string $sDate date we will be process
     *
     * @return  Landing Page Paid Impressions object.
     */
    public function __construct($sDate)
    {
        $this->sDate = $sDate;
        $this->sDateFile = $this->increment30Minutes($sDate);
        parent::__construct();
    }

    /**
     * Reading the log
     *
     * @param integer $nLimit number of lines
     *
     * @return array[StdObject] with all the properties of one LandingPageImpressions Paid
     * @throws CI\File\Exception when the file can't be read
     */
    public function readLog($nLimit = null)
    {
        $aReturn = array();
        $aPhysicalFiles = $this->getNecessaryLogs();
        $nTotal = 0;

        foreach ($aPhysicalFiles as $sFilePath) {

            if (null !== $nLimit && $nTotal >= $nLimit) {
                break;
            }

            $oHandle = @fopen($sFilePath, "r");

            if (false !== $oHandle) {
                $oLine = null;

                while (!feof($oHandle)) {
                    $sLine = fgets($oHandle);

                    if (!empty($sLine)) {
                        $aLine = explode(',', $sLine);
                        $aLine = $this->cutData($aLine);

                        foreach ($aLine as $key => $value) {
                            $value = $this->sanitaze($value);
                            $aLine[$key] =$value;
                        }

                        $oLine = (object) array_combine($this->aKeys, $aLine);

                        if (!$this->isInTimeFrame($oLine->unix_timestamp, self::TIME_RANGE)) {
                            $oLogger = $this->getLogger(self::TYPE_LOGGER_FAILED);
                            $oLogger->log($sLine);
                            continue;
                        }

                        $sKey = $oLine->user_id . '-' . $oLine->paid_link_id;
                        $aReturn[$sKey] = $oLine;
                        $nTotal++;

                        if (null !== $nLimit && $nTotal >= $nLimit) {
                            break;
                        }
                    }
                }
                fclose($oHandle);
            }
        }

        if (empty($aReturn)) {
            $print = print_r($aPhysicalFiles, true);
            throw new Exception(
                Exception::FILE_NOT_FOUND, $print
            );
        }

        return $aReturn;
    }

    protected function getNecessaryLogs()
    {
        $next30MinutesLog = $this->increment30Minutes($this->sDateFile);
        $aFiles = $this->getAllLogs($this->sDateFile);
        $aFiles = array_merge($aFiles, $this->getAllLogs($next30MinutesLog));
        return $aFiles;
    }

    public function cleanUp()
    {
        $this->moveDoneFiles($this->sDateFile);
    }

    /**
     * Data to be cut respect of the size of $this->aKeys
     *
     * @param array $aData to be cut
     *
     * @return array
     */
    protected function cutData(array $aData)
    {
        $nTotalItems = count($this->aKeys);
        $aData = array_slice($aData, 0, $nTotalItems);
        return $aData;
    }
}