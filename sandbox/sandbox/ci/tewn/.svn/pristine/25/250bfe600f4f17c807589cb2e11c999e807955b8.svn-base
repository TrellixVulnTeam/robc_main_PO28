<?xml version="1.0" encoding="UTF-8"?>
<project name="CrowdIgnite" default="build">
    <target name="build" depends="clean, prepare, lint, phploc, phpcpd, phpmd-ci, pdepend, phpcs-ci, phpunit" />

    <target name="console" depends="clean, prepare, lint, phploc, phpcpd, phpmd, pdepend, phpcs, phpunit" description="Execute all targets for console" />

    <property name="buildDir"      value="${basedir}/build"/>
    <property name="libraryDir"    value="${basedir}/library"/>
    <property name="testsDir"      value="${basedir}/tests"/>
    <property name="logsDir"       value="${basedir}/build/logs"/>

    <target name="clean" description="Cleanup build artifacts">
        <delete dir="${buildDir}"/>
    </target>

    <target name="prepare" depends="clean">
        <mkdir dir="${buildDir}"/>
        <mkdir dir="${logsDir}"/>

        <mkdir dir="${buildDir}/logs"/>
        <mkdir dir="${buildDir}/logs/coverage"/>
        <mkdir dir="${buildDir}/pdepend"/>
    </target>

    <target name="lint" depends="prepare">
        <apply executable="php" failonerror="true">
            <arg value="-l"/>
            <fileset dir="${libraryDir}">
                <include name="**/*.php"/>
                <modified />
            </fileset>
            <fileset dir="${testsDir}">
                <include name="**/*.php"/>
                <modified />
            </fileset>
        </apply>
    </target>

    <target name="phploc" depends="prepare" description="Measure project size">
        <exec executable="phploc">
                <arg value="--count-tests"/>
                <arg value="--log-csv"/>
                <arg value="${logsDir}/phploc.csv"/>
                <arg path="${basedir}"/>
        </exec>
    </target>

    <target name="pdepend" depends="prepare" description="Calculate software metrics">
        <exec executable="pdepend">
            <arg value="--jdepend-xml=${logsDir}/jdepend.xml"/>
            <arg value="--jdepend-chart=${buildDir}/pdepend/dependencies.svg"/>
            <arg value="--overview-pyramid=${buildDir}/pdepend/overview-pyramid.svg"/>
            <arg path="${libraryDir}"/>
        </exec>
    </target>

    <target name="phpmd" depends="prepare" description="Perform project mess detection, for command line before committing">
        <exec executable="phpmd">
            <arg path="${libraryDir}"/>
            <arg value="text"/>
            <arg value="design,codesize,unusedcode,naming"/>
            <arg value="${basedir}/build/logs/pmd.xml"/>
            <arg value="--exclude" />
            <arg value="PDL,SimplePie" />
        </exec>
    </target>

    <target name="phpmd-ci" depends="prepare" description="Perform project mess detection, for the continuous integration server">
        <exec executable="phpmd">
            <arg path="${libraryDir}"/>
            <arg value="xml"/>
            <arg value="design,codesize,unusedcode,naming"/>
            <arg value="--reportfile"/>
            <arg value="${basedir}/build/logs/pmd.xml"/>
            <arg value="--exclude" />
            <arg value="PDL,SimplePie" />
        </exec>
    </target>

    <target name="phpcs" depends="prepare" description="Find coding standard violations, for command line before commiting">
        <exec executable="phpcs" failonerror="true">
            <arg value="--extensions=php"/>
            <arg value="--standard=resources/phpcs/Crowdignite"/>
            <arg value="--ignore=*${libraryDir}/PDL*,*${libraryDir}/SimplePie*,*${libraryDir}/History/Template/Html.php"/>
            <arg value="${libraryDir}"/>
        </exec>
    </target>

    <target name="phpcs-ci" depends="prepare" description="Find coding standard violations, for the continuous integration server">
        <exec executable="phpcs" output="${logsDir}/phpcs-ci.log" failonerror="true">
            <arg value="--report=checkstyle"/>
            <arg value="--extensions=php"/>
            <arg value="--report-file=${logsDir}/checkstile.xml"/>
            <arg value="--standard=resources/phpcs/Crowdignite"/>
            <arg value="--ignore=*${libraryDir}/PDL*,*${libraryDir}/SimplePie*,*${libraryDir}/History/Template/Html.php"/>
            <arg value="${libraryDir}"/>
        </exec>
    </target>

    <target name="phpcpd" depends="prepare" description="Find duplicate code">
        <exec executable="phpcpd">
            <arg value="--log-pmd"/>
            <arg value="${logsDir}/phpcpd.xml"/>
            <arg path="${libraryDir}"/>
        </exec>
    </target>

    <target name="qtest" depends="prepare" description="Perform several test to one file" if="file">
        <exec executable="php" failonerror="true">
            <arg value="-l"/>
            <arg path="${file}"/>
        </exec>
        <exec executable="phpcs">
            <arg path="${file}"/>
        </exec>
        <exec executable="phpmd">
            <arg path="${file}"/>
            <arg value="text"/>
            <arg value="design,codesize,unusedcode,naming"/>
        </exec>
    </target>

    <target name="phpunit" depends="prepare" description="Run unit tests">
        <exec executable="phpunit" failonerror="true" dir="${testsDir}"/>
    </target>
</project>
