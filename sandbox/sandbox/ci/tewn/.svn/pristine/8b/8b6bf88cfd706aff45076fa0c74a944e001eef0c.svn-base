ci.namespace('ci.ImagePreview');

ci.ImagePreview = function($elem){
    this.$elem = $elem;
    this.$cropper = undefined;
}

ci.ImagePreview.prototype.init = function() {
    var _self = this;
    this.$elem.find('#btn-get-image').on('click', function(){
        var $getImage = $('#txt-get-image');
        _self.url($getImage.val());
        $('#btn-upload-img').removeClass('hidden');
    });

    this.$elem.find('#txt-get-image').keypress(function(event) {
        // Key 13 = Enter
        if(event.which == 13) {
            var $getImage = $('#txt-get-image');
            _self.url($getImage.val());
            $('#btn-upload-img').removeClass('hidden');
        }
    });

    $(document).on('change', '.btn-file :file', function() {
      var input = $(this),
          numFiles = input.get(0).files ? input.get(0).files.length : 1,
          label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
      input.trigger('fileselect', [numFiles, label]);
    });

    $('.btn-file :file').on('fileselect', function(event, numFiles, label) {
        $.ajax({
            type        : 'POST',
            dataType    : 'json',
            url         : '/custom_landing_page/action/upload_image',
            processData : false,
            contentType : this.files[0].type,
            cache       : false,
            data        : this.files[0],
            success     : function(response) {
                if (response.hasOwnProperty('status') && response.status == 'ok') {
                    _self.url('/img/' + response.data.image, function(){
                        $("#progress-bar").addClass('progress-bar-success');
                        _self.displayProgress(100);
                    });
                }
            },
            xhr         : function(){
                // get the native XmlHttpRequest object
                var xhr = $.ajaxSettings.xhr() ;
                var percentage = 0;

                // set the onprogress event handler
                xhr.upload.onprogress = function(evt){
                    _self.$elem.find('.tab-content').addClass('hidden');
                    percentage = Math.round(evt.loaded/evt.total*100);

                    if (percentage < 99 ) {
                        _self.displayProgress(percentage);
                    }
                };
                // return the customized object
                return xhr ;
            }
        });
    });

    $('#btn-change-img').click(function(){
        var percentage = 0;
        var $progress  = $("#progress-bar");
        $('#image').val('');


        $(this).addClass('hidden');

        _self.destroyCropper();

        $progress.attr('aria-valuenow', percentage);
        $progress.width(percentage + "%");
        $progress.find('span').text(percentage + "%");
        $progress.parent().addClass('hidden');
        $progress.removeClass('progress-bar-success');
        $(_self.$elem.data('image-selector') + ' img').attr('src', 'http://placehold.it/349x199&text=Preview');
        $(_self.$elem.data('preview-selector')).parent().addClass('hidden');
        _self.$elem.find('.tab-content').removeClass('hidden');
        $('#form-add-custom-page').valid();
        $('#txt-get-image, #input-upload-image').val('');
        $('#btn-crop-img').addClass('hidden');
    });

    $('#btn-crop-img').click(function(){
        var $image    = $(_self.$elem.data('image-selector') + ' img');
        var sPreview = _self.$elem.data('preview-selector');

        $(this).addClass('hidden');
        $('#btn-cancel-crop-img').removeClass('hidden');
        $(sPreview).parent().removeClass('hidden');

        _self.$cropper = $image.cropper({
            aspectRatio: 210 / 120,
            preview : sPreview,
        });
    });

    $('#btn-cancel-crop-img').click(function(){
        var sPreview = _self.$elem.data('preview-selector');
        $(this).addClass('hidden');
        $('#btn-crop-img').removeClass('hidden');
        $(sPreview).parent().addClass('hidden');
        _self.destroyCropper();
    });
};

ci.ImagePreview.prototype.displayProgress = function(percentage) {
    var $progress = $("#progress-bar");
    $progress.parent().removeClass('hidden');
    $progress.attr('aria-valuenow', percentage);
    $progress.width(percentage + "%");
    $progress.find('span').text(percentage + "%");
};

ci.ImagePreview.prototype.createCropper = function() {
    var $image    = $(this.$elem.data('image-selector') + ' img');
    var sPreview = this.$elem.data('preview-selector');

    $(sPreview).parent().removeClass('hidden');

    this.$cropper = $image.cropper({
        aspectRatio: 210 / 120,
        preview : sPreview,
    });
};

ci.ImagePreview.prototype.destroyCropper = function() {
    if (ci.isObject(this.$cropper)) {
        this.$cropper.cropper('destroy');
    }
};

ci.ImagePreview.prototype.getCropper = function() {
    return this.$cropper;
};

ci.ImagePreview.prototype.url = function(sUrl, callback) {
    var _self = this;

    if (sUrl.length < 1) {
        $('#form-add-custom-page').valid();
        return;
    }

    var $image   = $(this.$elem.data('image-selector') + ' img');
    $('#image').val(sUrl);
    $image.on('load', function(){
        var $this = $(this);
        $this.off('load');

        _self.$elem.find('.tab-content').addClass('hidden');
        $('#btn-change-img, #btn-crop-img').removeClass('hidden');
        $('#form-add-custom-page').valid();

        if (ci.isFunction(callback)){
            callback();
        }
    });

    $image.attr('src', sUrl);
};

(function($){
    $.fn.ciImagePreview = function(settings) {
        return this.each(function(){
            var $elem = $(this);

            var ciImagePreview = new ci.ImagePreview($elem);
            ciImagePreview.init();

            $elem.data("_ciImagePreview", ciImagePreview);
        });
    }
})(jQuery);