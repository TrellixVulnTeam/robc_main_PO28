<?php

class PageCategory extends AppModel
{
    var $name = 'PageCategory';

    /**
     * Get cake model result by page id and only visible
     * @param  integer $page_id The page id
     * @return array The cake model result
     */
    public function get_by_page_id($page_id)
    {
        $categories = $this->find('all', array(
            'conditions' => array(
                'visible' => 1,
                'page_id' => $page_id,
            ),
        ));

        return $categories;
    }

    /**
     * Get an array with category names from a page
     * @param  integer $page The page id
     * @return array [id]name
     */
    public function get_with_name_by_page_id($page)
    {
        App::import('Helper', 'Convert');
        $convert = new ConvertHelper();
        $categories = $this->get_by_page_id($page);
        $page_categories = array();
        foreach ($categories as $category) {
            $category_id = $category['PageCategory']['category'];
            $page_categories[$category_id] = $convert->category($category_id);
        }
        return $page_categories;
    }

    /**
     * Update the categories of a page id
     * @param  integer $page_id    The page to update
     * @param  array   $categories Categories to update
     * @return void
     */
    public function update_by_page_id($page_id, $categories)
    {
        $page_id = intval($page_id);
        if ($page_id > 0) {
            $this->query('UPDATE page_categories SET visible = 0 WHERE page_id = ' . $page_id);

            if (!empty($categories)) {
                $categories_tpl = array();
                foreach ($categories as $category_id) {
                    $categories_tpl[] = "({$category_id},{$page_id},unix_timestamp(),1)";
                }

                $query_update = sprintf(
                    'INSERT INTO tewn.page_categories(category, page_id, created, visible) VALUES %s ON DUPLICATE KEY UPDATE visible = VALUES(visible);',
                    implode(',', $categories_tpl)
                );

                $this->query($query_update);
            }
        }
    }
}
