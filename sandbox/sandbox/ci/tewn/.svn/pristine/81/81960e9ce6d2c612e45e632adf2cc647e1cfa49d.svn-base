<?

    function tab_selected($status_a, $status_b) {
        // Hack for casting issue
        if ($status_a === DOMAIN_ID_ALL &&
            $status_b === 0) {
            return "tab_unselected";
        }

        if ($status_a == $status_b) {
            $selected_class = "tab_selected";
        } else {
            $selected_class = "tab_unselected";
        }
        return $selected_class;
    }

?>

<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/jquery-ui.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/js/fileuploader/fileuploader.js"></script>
<script type="text/javascript" src="/js/jquery.Jcrop.js"></script>
<script type="text/javascript" src="/js/tag-it.min.js"></script>
<script type="text/javascript" src="/js/daterangepicker.jQuery.js"></script>
<script type="text/javascript" src="/js/spin.min.js"></script>
<script type="text/javascript" src="/js/jquery.spin.js"></script>
<script src="http://<?php echo CDN_URL; ?>/js/handlebars-v1.3.0.js"></script>
<?
    echo $this->element('crowdignite/analytics');
?>
<link rel="stylesheet" href="/css/fileuploader/fileuploader.css" type="text/css" />
<link rel="stylesheet" href="/js/jquery-smoothness/jquery-ui-1.8.21.custom.css" type="text/css" title="ui-theme" />
<link rel="stylesheet" href="/css/jquery.Jcrop.css" type="text/css" />
<link rel="stylesheet" href="/css/jquery.tagit.css"  type="text/css">
<link rel="stylesheet" href="/css/tagit.ui-zendesk.css" type="text/css">
<link rel="stylesheet" href="/css/ui.daterangepicker.css" type="text/css" />

<style>
.large_preview_wrapper {
    display: block;
    overflow: hidden;
    height: 172px;
    width: 300px;
}
.previewtabs { height:230px; font-size:11px; margin-top:10px; width:330px;}
.addimagetabs { font-size:11px; height: 150px; width:300px; }
.addimagetabs input[type="text"] { width:250px; margin:10px 0; }
.tabs-bottom { position: relative; }
.previewtabs .tabs-bottom .ui-tabs-panel { height: 300px; overflow: auto; }
.tabs-bottom .ui-tabs-nav { position: absolute !important; left: 0; bottom: 0; right:0; padding: 0 0.2em 0.2em 0; border-top:0!important; }
.tabs-bottom .ui-tabs-nav li { margin-top: -5px !important; margin-bottom: 1px !important; border-bottom-width: 1px; border-top:none; }
.tabs-bottom .ui-tabs-nav li a { font-weight: bold;}
.ui-tabs-selected { margin-top: -3px !important; }
div.ui-datepicker{ font-size:11px; }
.image_url { width:190px!important; }
.qq-uploader { margin-bottom:8px;}
.btn_get_image, .btn_expire_clear {
    color:#fff!important;
    display: inline-block;
    text-decoration:none;
    background: #DF6330;
    border-radius:8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    padding:4px 6px;
}

</style>

<script type="text/javascript">
    var jcrop_api = new Array();

    jQuery(document).ready( function(){
        jQuery('.expire_date').focus(function(){
            jQuery(this).daterangepicker({
                presetRanges: [
                    {text: '1 week', dateStart: 'today+1week', dateEnd: 'today+1week' },
                    {text: '2 week', dateStart: 'today+2week', dateEnd: 'today+2week' },
                    {text: '4 week', dateStart: 'today+4week', dateEnd: 'today+4week' },
                    {text: '2 months', dateStart: 'today+2months', dateEnd: 'today+2months' },
                    {text: '3 months', dateStart: 'today+3months', dateEnd: 'today+3months' },
                    {text: '6 months', dateStart: 'today+6months', dateEnd: 'today+6months' },
                    {text: '1 year', dateStart: 'today+1year', dateEnd: 'today+1year' }
                ]
            });
        });
        jQuery('.btn_expire_clear').click(function(){
            jQuery('#' + jQuery(this).data('clear')).val('');
            return false;
        });
        jQuery(".addimagetabs").tabs();
        jQuery( ".previewtabs" ).tabs().hide();
        jQuery( ".tabs-bottom .ui-tabs-nav, .tabs-bottom .ui-tabs-nav > *" )
            .removeClass( "ui-corner-all ui-corner-top" )
            .addClass( "ui-corner-bottom" );
        jQuery(".centerselection").click(function() {
            var i=jQuery(this).data('number');
            centerselection(i);
        });

        jQuery('textarea[maxlength]').limitMaxlength();

        jQuery(".btn_get_image").click(function() {
            var i=jQuery(this).data('number');
            jQuery("#turn_on_"+i).show();
            jQuery("#turn_off_"+i).hide();
            jQuery('#center_selection_wrap_'+i).hide();
            update_image(i);
            return false;
        });

        jQuery(".image_url").focus(function() {
            var i=jQuery(this).data('number');
            clear_box(i);
        });
        jQuery(".image_url").blur(function() {
            var i=jQuery(this).data('number');
            clear_box(i);
        });

        jQuery(".accept").click( function(){
            var i=jQuery(this).data('number');
            if( validate_form(i) ) {
                // submits form
            } else {
                // prevent submit
                return false;
            }
        });

        // add a sample url to empty image_url input boxes
        jQuery(".image_url").each(function(){
            if(jQuery(this).val()=="") {
                jQuery(this).val("http://mywebsite/img/example_image.jpg").css("color","#bbbbbb");
            }
        });

        /* Tags */
        <?php
            $active_tags = array();
            foreach($all_tags as $tag){
                $active_tags[] = '"'.addslashes($tag['Tag']['name']).'"';
            }
        ?>
        var active_tags = [<? echo implode(",", $active_tags); ?>];
        $('.page_tags').tagit({
            availableTags: active_tags,
            allowSpaces: true,
            removeConfirmation: true,
            caseSensitive: false
        });

        get_page_info();
        createUploaders();
    });

    function validate_form(i){
        var image_url = jQuery("#image_url_"+i).val();
        var page_url = jQuery("#url_"+i).val();
        var page_title = jQuery("#title_"+i).val();
        var output = true;
        if(image_url=="" || image_url=="http://mywebsite/img/example_image.jpg") {
            jQuery(".moderate_"+i).html('Please add a valid image URL.');
            output = false;
        }
        if(page_title =="") {
            jQuery(".moderate_"+i).html('Please add a title.');
            output = false;
        }
        if(page_url==""|| !validate_url(page_url) ) {
            jQuery(".moderate_"+i).html('Please add a valid page URL.');
            output = false;
        }
        jQuery(".moderate_"+i).addClass('red');
        return output;
    }

    function validate_url(url) {
        url = url.replace('[','%5B');
        url = url.replace(']','%5D');

        if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(url)) {
            return true;
        } else {
            return false;
        }
    }

    function clear_box(i) {
        var field = jQuery('#image_url_'+i).val();
        if( field == "http://mywebsite/img/example_image.jpg" ){
            jQuery("#image_url_"+i).val("");
            jQuery("#image_url_"+i).css("color", "black");
        } else if( field == "" ) {
            jQuery("#image_url_"+i).val("http://mywebsite/img/example_image.jpg").css("color","#bbbbbb");
        }
    }

    function createUploaders(){
        jQuery(".file_uploader").each(function(){

            var i=jQuery(this).data('number');

            var uploader = new qq.FileUploader({
                element: document.getElementById('file_uploader_'+i),
                action: '/pages/upload_image/',
                allowedExtensions: ['jpg', 'jpeg', 'png', 'gif'],
                debug: false,
                onComplete: function(id, fileName, responseJSON){
                    if(!responseJSON.error){
                        jQuery('#image_url_'+i).val('/img/'+responseJSON.success);
                        update_image(i);
                        //jQuery('#file_uploader_'+i).hide();
                        //jQuery('#image_url_'+i).hide();
                        //jQuery('.size_message').html('Image Loaded');
                    } else {
                        jQuery('.qq-upload-list').hide();
                    }
                }
            });
        });
    }

    function update_image(i) {
        var image_url = jQuery("#image_url_"+i).val();
        if (!image_url.match('^https?') && !image_url.match('^/img/upload/')) {
            return false;
        }
        if (image_url == "http://mywebsite/img/example_image.jpg") {
            return false;
        }
        jQuery('#preview_image_busy_'+i).show();
        jQuery("#test_image_size_"+i).attr('src', image_url);
        jQuery("#test_image_size_"+i).load(function(){
            if( jQuery(this).width()<300 || jQuery(this).height()<250 ) {
                jQuery("#image_url_"+i).val('http://mywebsite/img/example_image.jpg').css('color','grey');
                jQuery("#preview_image_"+i).attr('src', '');
                jQuery(this).attr('src', '');
                jQuery('.size_message').show();
                jQuery('#preview_image_busy_'+i).hide();
                return false;
            }
            jQuery('#preview_image_busy_'+i).hide();
            jQuery('.size_message').hide();
            jQuery('.qq-upload-list').hide();
            jQuery("#preview_image_"+i).attr('src', image_url);
            jQuery("#preview_outside_large_"+i).attr('src', image_url);
            jQuery("#preview_outside_small_"+i).attr('src', image_url);
            jQuery("#preview_outside_large_wrap_"+i).css({
                // The aspect ratio is 210/120 so the
                // height for 300 px would be 172
                // that is 120*(width/210) to respet the
                // aspect ratio
                width: '300px',
                height: '172px'
            });
            jQuery("#preview_outside_small_wrap_"+i).css({
                // small preview uses the width and height
                // of the aspect ratio
                width: '210px',
                height:'120px' });
            jQuery(".moderate_"+i).html('');
            reset_crop(i);
        });
    }

    function get_image_extension(i){
        var filename = (i + '').toLowerCase() ;
        var ext =  filename.split('.').pop();
        return ext;
    }

    function reset_crop(i) {
        jQuery("#turn_on_"+i).show();
        jQuery("#turn_off_"+i).hide();
        jQuery("#previewtabs_"+i).hide();
        jQuery('#center_selection_wrap_'+i).hide();

        entry = document.getElementById("preview_image_"+i);

        jcrop = jQuery("#preview_image_"+i).data('Jcrop');
        if (jcrop) {
            jcrop.destroy();
        }

        entry = document.getElementById("image_"+i+"_x1");
        entry.value = 0;

        entry = document.getElementById("image_"+i+"_y1");
        entry.value = 0;

        $("#crop_" + i + "_dim").html('');
        var src = $("#preview_image_"+i).attr('src').split('?')[0];
        $("#preview_image_"+i).attr('src', src + '?t=' + (new Date()).getTime());
    }

    function onEndCrop(coords, dimensions, i) {
        var entry;
        var adjust;
        var max_height;
        var max_width;
        var newImg = new Image();

        entry = document.getElementById("preview_image_"+i);
        max_width = 330;
        max_height = 250;

        newImg.src = entry.src;
        var height = newImg.height;
        var width = newImg.width;
    }

    function showCoords(c) {
        var entry;
        var adjust;
        var max_height;
        var max_width;
        var new_img = new Image();

        max_height = 250;
        max_width = 330;

        new_img.src = document.getElementById("preview_image_"+c.passthrough).src;
        var height = new_img.height;
        var width = new_img.width;

        if(height > max_height || width > max_width){
            adjust_height = height / max_height;
            adjust_width = width / max_width;
        }else{
            adjust_height = 1;
            adjust_width = 1;
        }
        adjust = Math.max(adjust_height, adjust_width);
        x1 = c.x * adjust;
        y1 = c.y * adjust;
        x2 = c.x2 * adjust;
        y2 = c.y2 * adjust;
        jQuery("#image_"+c.passthrough+"_x1").val(x1);
        jQuery("#image_"+c.passthrough+"_y1").val(y1);
        jQuery("#image_"+c.passthrough+"_x2").val(x2);
        jQuery("#image_"+c.passthrough+"_y2").val(y2);

        update_view_dimensions(y2 - y1, x2 - x1, c.passthrough);

        var thumb_width = jQuery('#preview_outside_large_wrap_'+c.passthrough).width();
        var thumb_height = jQuery('#preview_outside_large_wrap_'+c.passthrough).height();
        var thumb_sm_width = jQuery('#preview_outside_small_wrap_'+c.passthrough).width();
        var thumb_sm_height = jQuery('#preview_outside_small_wrap_'+c.passthrough).height();
        var crop_width = jQuery('#div_preview_image_'+c.passthrough+' .jcrop-holder img').width();
        var crop_height = jQuery('#div_preview_image_'+c.passthrough+' .jcrop-holder img').height();


        if (parseInt(c.w) > 0) {
              var rx = thumb_width / (x2-x1)*adjust;
              var ry = thumb_height / (y2-y1)*adjust;
              var rx_sm = thumb_sm_width / (x2-x1)*adjust;
              var ry_sm = thumb_sm_height / (y2-y1)*adjust;

              jQuery('#preview_outside_large_'+c.passthrough).css({
                width: Math.round(rx*crop_width) + 'px',
                height: Math.round(ry*crop_height) + 'px',
                marginLeft: '-' + Math.round(rx * c.x ) + 'px',
                marginTop: '-' + Math.round(ry * c.y ) + 'px'
              });

              jQuery('#preview_outside_large_wrap_'+c.passthrough).css({
                marginLeft: '-'+Math.round( (thumb_width-300) / 2 ) + 'px'
              });

              jQuery('#preview_outside_small_'+c.passthrough).css({
                width: Math.round(rx_sm*crop_width) + 'px',
                height: Math.round(ry_sm*crop_height) + 'px',
                marginLeft: '-' + Math.round(rx_sm * c.x ) + 'px',
                marginTop: '-' + Math.round(ry_sm * c.y ) + 'px'
              });
        }

    }

    function update_view_dimensions(height, width, i) {
        height = Math.round(height);
        width = Math.round(width);
        if (height < 250) {
            height_html = "<font color=red>"+height+"</font>";
        } else {
            height_html = height;
        }

        if (width < 300) {
            width_html = "<font color=red>"+width+"</font>";
        } else {
            width_html = width;
        }
        jQuery("#crop_"+i+"_dim").html(width_html+"x"+height_html);
    }

    function crop(i) {
        var entry;
        var crop_entry;

        entry = jQuery("#preview_image_"+i);

        var image_url = jQuery("#preview_image_"+i).attr('src');
        jQuery("#preview_outside_large_"+i).attr('src', image_url);
        jQuery("#preview_outside_small_"+i).attr('src', image_url);
        jQuery("#preview_outside_large_wrap_"+i).css({
            width: '300px',
            height: '172px'
        });
        jQuery("#preview_outside_small_wrap_"+i).css({
            width: '210px',
            height:'120px'
        });

        jcrop_api[i] = $.Jcrop('#preview_image_'+i);
        jcrop_api[i].setOptions({
            onSelect: showCoords,
            onChange: showCoords,
            aspectRatio: 210/120,
            setSelect: [0, 0, 150, 200],
            centerSelection: false,
            passthrough: i
        });
        jcrop_api[i].focus();
        jQuery("#turn_on_"+i).hide();
        jQuery("#turn_off_"+i).show();
        jQuery('#previewtabs_'+i).show();
        jQuery('#centerSelection_'+i).attr('checked', false);
        jQuery('#center_selection_wrap_'+i).fadeIn();
    }

    function get_page_info() {
        jQuery('.PageTitle').each(function(){
            var titl = jQuery(this);
            var desc = titl.parent().find('.PageDescription');
            var loader = titl.parent().find('img.title_loader');
            loader.show();
            jQuery.get('/pages/get_info/'+titl.data('pageid'),{},function(data) {
                if(data!=null)  {
                    if(titl.val() == "") { titl.val(data.title); }
                    if(desc.val() == "") { desc.val(data.description); }
                }
            }, 'json').complete(function() {
                loader.hide();
            });
        })
    }

    function centerselection(i) {
        var do_center = false;
        if(jQuery('#centerSelection_'+i).is(':checked')) {
            do_center = true;
        }
        jcrop_api = jQuery("#preview_image_"+i).Jcrop({
                    onSelect: showCoords,
                    onChange: showCoords,
                    aspectRatio: 210/120,
                    setSelect:   [ 0, 0, 150, 200 ],
                    centerSelection: do_center,
                    passthrough: i
                    });
    }

    jQuery.fn.limitMaxlength = function(options){

      var settings = jQuery.extend({
        attribute: "maxlength",
        onLimit: function(){},
        onEdit: function(){}
      }, options);

      // Event handler to limit the textarea
      var onEdit = function(){
        var textarea = jQuery(this);
        var maxlength = parseInt(textarea.attr(settings.attribute));
        if(textarea.val().length > maxlength){
          textarea.val(textarea.val().substr(0, maxlength));
          jQuery.proxy(settings.onLimit, this)();
        }
        jQuery.proxy(settings.onEdit, this)(maxlength - textarea.val().length);
      }

      this.each(onEdit);

      return this.keyup(onEdit)
            .keydown(onEdit)
            .focus(onEdit);
    }
</script>

<div class="row main">
<div id="content" class="column grid_12">

<?
    echo $this->element("management_toolbar", array("tab" => "none"));
?>
          <!-- Rank Method -->
        <table cellpadding=0 border=0>
        <tr>
        <td>
            <? $selected_class = tab_selected($social, 0); ?>
            <div class="tab <?=$selected_class?>" id="">
                <a class="<?=$selected_class?>" href="/pages/moderate/<?=$website_id?>/0/0">Traffic Trending</a>
            </div>
            </td>
        <td>
            <? $selected_class = tab_selected($social, 1); ?>
            <div class="tab <?=$selected_class?>" id="">
                <a class="<?=$selected_class?>" href="/pages/moderate/<?=$website_id?>/0/1">Social Trending</a>
            </div>
                </td>
            </tr>
        </table>

    <div class="column grid_12">

    <h3 class="topContent">Moderate Pages</h3>


     <div class="row" id="content_area">
     <div style="margin-top:12px; margin-left:12px" class="accordion">


        <ul id='regex_tools'>
            <li><a id="add" href="/pages/add/<?=$website_id?>">Add Page Manually</a></li>
            <li><a id="pages" href="/management/pages/<?=$website_id?>">Active Pages</a></li>
            <li><a id="edit" href="/websites/moderate/<?=$website_id?>">Website Edit</a></li>
        </ul>
        <br class="clearfloat" />
<?

    $i = 0;

        foreach($pages as $page) {
                $i++;
            $website = $websites[$page['Page']['website_id']];

        ?>

          <div class="page_add page_moderate" style="height: auto;">
<?
        echo $ajax->form('/pages/add', 'Post', array(
            'url' => '/pages/add',
            'update' => 'moderate_'.$page['Page']['id'], 'model' => 'Pages',
            'before' => 'jQuery("body").spin("large"); jQuery(".accept").addClass("disabled").attr("disabled","disabled")',
            'complete' => 'reset_crop('.$i.'); jQuery("body").spin(false); jQuery(".accept").removeClass("disabled").removeAttr("disabled");',
        ));
?>
           <table width="1024">
            <tr>
            <td class="padd bordered">

        Title<br>

                <?

        echo $form->hidden('Page.id', array('value' => $page['Page']['id']));
        echo $form->hidden('Page.website_id', array('value' => $page['Page']['website_id']));

        echo $form->text('Page.title', array('size' => '30', "id" => "title_".$i, 'class'=>'PageTitle', 'data-pageid'=>$page['Page']['id'], 'value' => $page['Page']['title']));
        echo $form->error('Page.title', NULL, array('class' => 'error_message'));
                ?>
        <img style="display:none" id="title_busy_<?=$i?>" class="title_loader" src="/img/wait.gif">

        <br>
        URL<br/>
        <?

             $url_parameters = array(
                'size' => '10',
                "id" => "url_".$i,
                "class" => "url",
                "value" => $page['Page']['url']
                );
             echo $form->text('Page.url', $url_parameters);
        ?>

        <br><br>Page Description<br>
        <?
        echo $form->textarea('Page.description', array("id" => "description_".$i, 'value' => html_entity_decode($page['Page']['description']), "class"=>"PageDescription", 'maxlength'=>'250') );
        echo $form->error('Page.description', NULL, array('class' => 'error_message'));
        ?>
        <br><br>
         Expire Date (Optional)<br>
        <?
            $expire_parameters = array('size' => '10', "id" => "expire_".$i, "class" => "expire_date");
            if ($page['Page']['expire']) {
                $expire_parameters['value'] = $page['Page']['expire'];
            }
            echo $form->text('Page.expire', $expire_parameters);
            echo '&nbsp;';
            echo $html->link('Clear', '#', array('class' => 'purple awesome btn_expire_clear', 'data-clear' => 'expire_'.$i));
        ?>
                    <div class="tag_container">
                        <?php
                            $page_tags = implode(",", $page['Page']['tags']);
                            $page_tags = htmlentities($page_tags);
                        ?>
                        <span>Tags</span> <input name="page_tags" class="page_tags" value="<?=$page_tags?>">
                    </div>
                </td>
        <td class="padd bordered">
                <table class="details">
                <tr>
                        <td>Sex</td>
                        <td>
                                <?
                if ($page['Page']['status'] == PAGE_STATUS_APPROVED) {
                    $demographic_sex = $page['Page']['demographic_sex'];
                } else {
                    $demographic_sex = $website['Website']['demographic_sex'];
                }
                        echo $form->select('Page.demographic_sex', $convert->demographic_sex_select(), $demographic_sex);
                                ?>
                        </td>
                </tr>

                        <tr>
                        <td>Content Rating</td>
                        <td>
                                <?
                if ($page['Page']['status'] == PAGE_STATUS_APPROVED) {
                    $content_rating = $page['Page']['content_rating'];
                } else {
                    $content_rating = $website['Website']['content_rating'];
                }
                        echo $form->select('Page.content_rating', $convert->content_rating_select(), $content_rating);
                                ?>



                        </td>
                    </tr>
                    <tr>
                        <td>Category</td>
                        <td>
                                <?
                if (isset($page['Page']['category'])) {
                    $category = (string)$page['Page']['category'];
                } else {
                    $category = $website['Website']['category'];
                }
                        echo $form->select('Page.category', $convert->category_select(), $category, array('class' => 'page_category', 'data-page' => $page['Page']['id']));
                                ?>
                        </td>
                    </tr>
                    <?php
                        echo $this->element(
                            'crowdignite/pages/subcategories',
                            array(
                                'page'     => $page['Page'],
                                'category' => $category,
                            )
                        );
                    ?>
                    <tr>
                        <td colspan="2">
                            <div id="addimagetabs_<?=$i?>" class="tabs-bottom addimagetabs">
                                <ul>
                                    <li><a href="#tabs-1">From URL</a></li>
                                    <li><a href="#tabs-2">From Computer</a></li>
                                </ul>
                                <div id="tabs-1">
                                  <div style="font-size: 14px">
                                  <b>Image URL</b><br/>
                                  </div>
                                    <?
                                    // Image
                                    $image_parameters = array('size' => '30', "id" => "image_url_".$i, "class"=>"image_url", "data-number"=>$i);
                                    if (isset($page['Page']['image'])) {
                                        $image_parameters['value'] = $page['Page']['image'];
                                    }
                                    echo $form->text('Page.image', $image_parameters);
                                    echo $form->error('Page.image', NULL, array('class' => 'error_message'));
                                    ?>
                                    <a href="#" class="btn_get_image" data-number="<?=$i?>">Get Image</a>
                                    <br/>
                                  <div style="font-size: 12px; color:red; display:none;" class="size_message">
                                  Image should be at least <b>300x250</b> in size
                                  </div>
                                </div>
                                <div id="tabs-2">
                                  <div style="font-size: 14px">
                                  <b>From Computer</b>
                                  </div>
                                    <br/>
                                    <div id="file_uploader_<?=$i?>" class="file_uploader" data-number="<?=$i?>">
                                        <noscript>
                                            <p>Please enable JavaScript to use file uploader.</p>
                                        </noscript>
                                    </div>
                                  <div style="font-size: 12px; color:red; display:none;" class="size_message">
                                  Image should be at least <b>300x250</b> in size
                                  </div>
                                </div>
                            </div>
                            <?
                            echo $form->hidden('Page.x1', array("id" => "image_".$i."_x1"));
                            echo $form->hidden('Page.y1', array("id" => "image_".$i."_y1"));
                            echo $form->hidden('Page.x2', array("id" => "image_".$i."_x2"));
                            echo $form->hidden('Page.y2', array("id" => "image_".$i."_y2"));
                            ?>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                             <div id="turn_on_<?=$i?>" class="awesome purple crop">
                             <a href="#" onclick="crop(<?=$i?>); return false" style="color:black">Crop Image</a>
                             </div>
                             <div id="turn_off_<?=$i?>" style="display:none" class="awesome purple crop">
                             <a href="#" onclick="reset_crop(<?=$i?>); return false;" style="color:black">Turn Off Crop</a><br>
                                 </div>
                             <br/>
                             <div id="center_selection_wrap_<?=$i?>" style="display:none; margin:20px 0 0  20px; font-size:12px;" data-number="<?=$i?>">
                                <input type="checkbox" name="centerSelection" id="centerSelection_<?=$i?>" class="centerselection" data-number="<?=$i?>"/> Expand selection from center<br>
                         </div>
                        </td>
                    </tr>
                    </table>
        </td>
                <td class="padd" width=330px rowspan=2>
        <img style="display:none" id="preview_image_busy_<?=$i?>" src="/img/wait.gif">
        <div id="div_preview_image_<?=$i?>">
        <img id="preview_image_<?=$i?>" style="width: expression( document.body.clientWidth > 329 ? '330px' : 'auto'); /* sets max-width for IE */
                                                        max-width:330px; /* this sets the max-width value for all standards-compliant browsers */
                                                        height: expression( this.scrollHeight > 329 ? '330px' : 'auto' ); /* sets max-height for IE */
                                                        max-height: 250px;" src="<?php echo $page['Page']['image_url']?>">
        </div>
        <div id="preview_image_crop_<?=$i?>"></div>
        <img id="test_image_size_<?=$i?>" style="display:none;"/>
        <div id=crop_<?=$i?>_dim></div>

        <div id="previewtabs_<?=$i?>" class="previewtabs tabs-bottom">
            <ul>
                <li><a href="#ptabs-1">Large Preview</a></li>
                <li><a href="#ptabs-2">Small Preview</a></li>
            </ul>
            <div id="ptabs-1">
                <div class="large_preview_wrapper">
                    <div id="preview_outside_large_wrap_<?=$i?>" style="width:300px;height:172px;overflow:hidden;">
                        <img id="preview_outside_large_<?=$i?>"/>
                    </div>
                </div>
            </div>
            <div id="ptabs-2">
                <div id="preview_outside_small_wrap_<?=$i?>" style="width:120px;height:120px;overflow:hidden;">
                    <img id="preview_outside_small_<?=$i?>"/>
                </div>
            </div>
        </div>

        </td>
        </tr>
                <tr>
                        <td class="padd bordered">
                        <table class="details">
                        <tr>
                                <td>
                          <?
                      echo $form->submit("Add",array("class" => "awesome purple btn_control accept", "id"=>"add_button_".$i, "data-number"=>$i));
                      echo $form->end();
                      echo "";
                                echo "</td><td>&nbsp;</td><td>";
                                // Deny form
                      echo $ajax->form('/pages/deny', 'Post', array('url' => '/pages/deny', 'update' => 'moderate_'.$page['Page']['id'], 'model' => 'Pages'));
                      echo $form->hidden('Page.id', array('value' => $page['Page']['id']));
                      echo $form->submit("Deny",array("class" => "awesome purple btn_control deny"));
                      echo $form->end();

                                echo "</td></tr><tr><td>";
                      // Duplicate form
                      echo $ajax->form('/pages/duplicate', 'Post', array('url' => '/pages/duplicate', 'update' => 'moderate_'.$page['Page']['id'], 'model' => 'Pages'));
                      echo $form->hidden('Page.id', array('value' => $page['Page']['id']));
                      echo $form->submit("Duplicate",array("class" => "awesome purple btn_control duplicate"));
                      echo $form->end();

                                echo "</td><td>&nbsp;</td>";
                  ?>
                    <td>

                    </td>
                        </tr>
                        </table>
                        </td>
                <td class="padd bordered">
                Website: <b><?=$website['Website']['name']?></b><br><br>
                            <?php $status_color = 'red';
                                $page_status = $convert->page_status($page['Page']['status']);

                                if ($page['Page']['status'] == PAGE_STATUS_APPROVED) {
                                    $status_color = 'green';
                                } else if($page['Page']['status'] == PAGE_STATUS_PENDING) {
                                    $status_color = 'yellow';
                                }
                            ?>
                Status: <b class=<?=$status_color?>><?=$page_status?></b><br>
                <?
                if (isset($page['SocialPage'])) {
                    echo "Facebook Likes: <b>".$page['SocialPage']['likes_fb']."</b><br>";
                    echo "Facebook Shares: <b>".$page['SocialPage']['shares_fb']."</b><br>";
                    echo "Facebook Comments: <b>".$page['SocialPage']['comments_fb']."</b><br>";
                }
                ?>
                Impressions: <b><?=$page['Page']['impressions']?></b><br>
                Created: <b><?=date("n-j-y g:i a", strtotime($page['Page']['created']))?></b><br>
                Page ID: <b><?=$page['Page']['id']?></b><br>
            <?
                if (isset($page['User'])) {
                    echo "Moderator: ".$page['User']['username']."<br>";
                }
            ?>
          <div id="moderate_<?=$page['Page']['id']?>" class="moderate_<?=$i?>">
        </div>
                </td></tr>
                </table>
<?
          echo $form->end();
?>              <div class="site_info">
                        <a href="<?=$page['Page']['url']?>" target="_blank"><?=$page['Page']['url']?></a>&nbsp;&nbsp;
                </div>
        </div>
<?
    }
?>
    </div>
    </div>
<?php echo $this->element('crowdignite/pages/tpl/subcategories'); ?>