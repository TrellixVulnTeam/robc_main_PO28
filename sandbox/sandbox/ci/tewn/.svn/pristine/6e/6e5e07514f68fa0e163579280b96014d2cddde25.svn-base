<?
function percent($num) {
    return number_format(($num*100), 4)."%";
}
echo $this->element("dashboard2_toolbar", array("tab" => "pages"));
?>

<div class="row supercontainer" id="content_area">

    <div class="hubs_column"> <!-- left col -->
        <ul class="hub_list">
            <li class="title t_info">Pages</li>
            <li class="tab_selected"><a class="add_pages" href="#">Add Pages</a></li>
            <li><a class="active_pages" href="#">Active Pages</a></li>
        </ul>
    </div>

    <div class="websites_column"> <!-- right col -->

        <div id="status_bar">
            <div class="ddown_container">
                &nbsp;
            </div>
        </div>

        <div class="table_container">

            <div id="add_pages" class="pane">
                <h4>Add New Pages</h4>
                <p>We'll automatically find your top pages and post them, but if you want a specific page, feel free to add it here.<br/>
                Note: we can't guarantee it will be used, but we'll try.<!--'-->
                </p>
                <table id="website_table" class="tablesorter">
                <thead>
                        <tr>
                        <th>Website</th>
                        <th>Number Pages Active</th>
                        <th>Number Pending Moderation</th>
                        <th class="align_center">Add a Page</th>
                        </tr>
                </thead>
                <tbody>
                <?
                foreach($websites as $website) {
                    if (empty($website['Website']['name'])) {
                        $website_name = $website['Website']['url'];
            		} else {
                    	$website_name = $website['Website']['name'];
            		}
                ?>
                <tr>
                    <!-- Website -->
                    <td><?=$website_name?></td>

                    <!-- Active Pages -->
                    <td><?=$website['Website']['active_pages']?></td>

                    <!-- Pending Pages -->
                    <td><?=$website['Website']['pending_moderation_pages']?></td>

                    <!-- Add Page -->
                    <td class="align_center">
                        <a class="button" href="/pages/add/<?=$website['Website']['id']?>">Add a New Page</a>
                    </td>
                </tr>
                <?
                }
                ?>
                </table>
            </div>

            <div id="active_pages" class="pane">
                <h4>Active Pages</h4>
    	        <table id="page_table" class="tablesorter">
                    <thead>
                        <tr>
                        <th>Website</th>
                        <th>Title</th>
                        <th>Image</th>
                        <th>Landing Page CTR</th>
                        <th>Widget CTR</th>
                        <th>Moderate</th>
                        </tr>
                    </thead>
                    <tbody>
    <?
                $image_assets = new \CI\Asset\Image();

                /* Websites */
        		foreach($websites as $website) {
        			if (empty($website['Website']['name'])) {
        				$website_name = $website['Website']['url'];
        			} else {
        				$website_name = $website['Website']['name'];
        			}
                    foreach($website['Website']['pages'] as $page) {

                        $image_html = $image_assets->getUrl(
                            array(
                                'page_id' => $page['Page']['id'],
                                'type' => \CI\Asset\Image::URL_CROP_RELATIVE,
                                'image' => $page['Page']['image'],
                                'width' => 140,
                                'height' => 80,
                                'extra_parameters' => array(
                                    't' => strtotime($page['Page']['moderator_modified']),
                                )
                            )
                        );

    ?>
                    <tr>
                    <!-- Website -->
                    <td ><?=$website_name?></td>

                    <!-- Title -->
                    <td ><a href="<?=$page['Page']['url'] ?>"><?=$page['Page']['title']?></a></td>

                    <!-- Image -->
                    <td ><img src="<?=$image_html?>" border=0></td>

                    <!-- Landing Page CTR -->
                    <td ><?=percent($page['Page']['lp_ctr'])?></td>

                    <!-- Widget CTR -->
                    <td ><?=percent($page['Page']['widget_ctr'])?></td>

                    <!-- Pages Moderate -->
                    <td class="align_center">
                    <a class="button" onclick="return confirm_delete();" href="/pages/delete/<?=$page['Page']['id']?>">Delete</a>
                    </td>
    <?
                    }
                }
    ?>
                    </tbody>
                </table>
            </div>
</div>