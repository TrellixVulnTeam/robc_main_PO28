<?php
/**
 * Testing the lecture of the Widget Clicks
 * PHP Version 5.3
 *
 * @category Test
 * @package  Test_VowpalWabbit_Parser_Widget
 * @author   Julio Rodriguez <julio.rodriguez@evolvemediallc.com>
 * @license  Evolve Media LLC
 * @link     http://crowdignite.com
 */

namespace Test\VowpalWabbit\Parser\Widget;
use CI\VowpalWabbit\Parser\Common;
use CI\VowpalWabbit\Parser\Widget\Clicks;

/**
 * Testing the lecture of the Widget Clicks
 * PHP Version 5.3
 *
 * @category Test
 * @package  Test_VowpalWabbit_Parser_Widget
 * @author   Julio Rodriguez <julio.rodriguez@evolvemediallc.com>
 * @license  Evolve Media LLC
 * @link     http://crowdignite.com
 * @group    VowpalWabbit
 */
class ClicksTest extends \PHPUnit_Framework_TestCase
{
    protected $oClicks;

    /**
     * Initializing the test
     *
     * @return void.
     */
    public function setUp()
    {
        $this->oClicks = new WidgetClicksMock('20131030_05:00');
    }

    /**
     * Testing the lecture of one line of the  Clicks log
     *
     * @return void
     */
    public function testRowsOfoneItemFromLog()
    {
        $oExpected['e1f8589fbfff98f443d780dd0350713c-402337701'] = (object) array(
            'unix_timestamp' => '1383134403',
            'user_id' => 'e1f8589fbfff98f443d780dd0350713c',
            'link_click_page_id' => '402337701',
            'link_click_slot' => '3'
        );
        $nLimit = 1;
        $oResult = $this->oClicks->readLog($nLimit);

        $this->assertEquals($oExpected, $oResult, 'we are no getting the expected object ');
    }

    /**
     * Testing the lecture of many lines of the  Clicks log
     *
     * @return void
     */
    public function testReadOneItemFromLog()
    {
        $nExpected = 1;
        $oResult = $this->oClicks->readLog($nExpected);
        $nResult = count($oResult);

        $this->assertEquals($nExpected, $nResult, 'we didn\'t get the items was requested =' . $nExpected);
    }

    /**
     * Testing the lecture of many lines of the  Widget Clicks log
     *
     * @return void
     */
    public function testReadManyItemsFromLog()
    {
        $nExpected = 4;
        $oResult = $this->oClicks->readLog($nExpected);
        $nResult = count($oResult);

        $this->assertEquals($nExpected, $nResult, 'we didn\'t get the items was requested = ' . $nExpected);
    }

    /**
     * Testing the Lecture
     *
     * @return void.
     */
    public function testReadOfTwoHourFile()
    {
        $nExpected = 40;
        $oResult = $this->oClicks->readLog();
        $nResult = count($oResult);

        $this->assertEquals($nExpected, $nResult, 'we didn\'t get the items was requested = '. $nExpected);

    }

    /**
     * Testing the exception
     *
     * @expectedException CI\File\Exception
     *
     * @return void.
     */
    public function testFileException()
    {
        $this->oClicks = new WidgetClicksMock('20000816_12:00');
        $this->oClicks->readLog();
    }

    /**
     * Testing the Sanitation of our strings
     *
     * @return void
     */
    public function testSanitaze()
    {
        $sExpected = '0';
        $sBad = '0    ';
        $sReturn = $this->oClicks->sanitaze($sBad);

        $this->assertEquals($sExpected, $sReturn, 'did not sanitaze correctly');
    }

    /**
     * Testing the get the directories
     *
     * @return void.
     */
    public function testGetDirLogs()
    {
        $aExpected = array(
          "app1v-ci.ci.prd.lax.gnmedia.net",
          "app2v-ci.ci.prd.lax.gnmedia.net",
          "app3v-ci.ci.prd.lax.gnmedia.net",
          "app4v-ci.ci.prd.lax.gnmedia.net",
          "app5v-ci.ci.prd.lax.gnmedia.net",
          "app6v-ci.ci.prd.lax.gnmedia.net",
          "app7v-ci.ci.prd.lax.gnmedia.net",
          "app8v-ci.ci.prd.lax.gnmedia.net"
        );
        $aResult = $this->oClicks->getDirLogs();

        $this->assertEquals($aExpected, $aResult);
    }


    /**
     * Testing the get the directories
     *
     * @return void.
     */
    public function testGetAllLogs()
    {
        $aExpected = array(
            '../library/../tests/resources/mnt/crowdignite/app1v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app2v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app3v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app4v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app5v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app6v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app7v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00',
            '../library/../tests/resources/mnt/crowdignite/app8v-ci.ci.prd.lax.gnmedia.net/vwlogs/wclick.log.20130816_12:00'
        );
        $aResult = $this->oClicks->getAllLogs('20130816_12:00');

        $this->assertEquals($aExpected, $aResult);
    }
    /**
     * Testing the case of 30 minutes in time frame.
     *
     * @return void
     */
    public function testIsInTimeFrame30Minutes()
    {
        $bExpected = true;
        $this->oClicks = new WidgetClicksMock('20120816_16:30');
        $nDate = strtotime('2012/08/16 17:00');
        $TimeFrame = 30 * 60;
        $bResult = $this->oClicks->isInTimeFrame($nDate, $TimeFrame);

        $this->assertEquals($bExpected, $bResult);
    }

    /**
     * Testing the case of 1 hour and 30 minutes in time frame.
     *
     * @return void
     */
    public function testIsInTimeFrame90Minutes()
    {
        $bExpected = true;
        $this->oClicks = new WidgetClicksMock('20120816_16:00');
        $nDate = strtotime('2012/08/16 17:30');
        $TimeFrame = 1.5 * 60 * 60;
        $bResult = $this->oClicks->isInTimeFrame($nDate, $TimeFrame);

        $this->assertEquals($bExpected, $bResult);
    }

    /**
     * Testing the case of more of the time frime limit
     *
     * @return void
     */
    public function testIsNotInTimeFrame30Minutes()
    {
        $bExpected = false;
        $this->oClicks = new WidgetClicksMock('20120816_16:00');
        $nDate = strtotime('2012/08/16 16:30:01');
        $TimeFrame = 30 * 60;
        $bResult = $this->oClicks->isInTimeFrame($nDate, $TimeFrame);

        $this->assertEquals($bExpected, $bResult);
    }

    /**
     * Testing the case of more of the time frime limit
     *
     * @return void
     */
    public function testIsLesstInTimeFrame()
    {
        $bExpected = false;
        $this->oClicks = new WidgetClicksMock('20120816_16:00');
        $nDate = strtotime('2012/08/16 13:30:01');
        $TimeFrame = 30 * 60;
        $bResult = $this->oClicks->isInTimeFrame($nDate, $TimeFrame);

        $this->assertEquals($bExpected, $bResult);
    }

    /**
     * Testing the case of time stamp
     *
     * @return void
     */
    public function testTimeStam()
    {
        $bExpected = false;
        $this->oClicks = new WidgetClicksMock('20120816_12:00');
        $nDate = 1376676001;
        $TimeFrame = 30 * 60;
        $bResult = $this->oClicks->isInTimeFrame($nDate, $TimeFrame);

        $this->assertEquals($bExpected, $bResult);
    }
}

/**
 * Mockup of the class Click to rewrite some variables.
 */
class WidgetClicksMock extends Clicks
{
    /**
     * Rewrite the __construct to rewrite tha path to read the logs
     *
     * @param $sDate date to be proccess
     *
     * @return void.
     */
    public function __construct($sDate)
    {
        $this->sMountLogs = LIBRARY_DIR . '../tests/resources/mnt/crowdignite/';
        parent::__construct($sDate);
    }

    public function moveDoneFiles($bVar = false)
    {
        //rewrite this function, to dont move any File
    }
}